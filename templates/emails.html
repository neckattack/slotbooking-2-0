<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox ‚Äì neckattack</title>
  <style>
    :root { --border:#e5e7eb; --sub:#6b7280; --fg:#111827; --primary:#111827; --active:#f5f6f7; --hover:#f0f2f4; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; color: var(--fg); background:#fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:#ffffff; position:sticky; top:0; z-index:10; }
    h1 { margin: 0; font-size:20px; display:flex; gap:8px; align-items:center; }
    .toolbar { display:flex; align-items:center; gap:10px; }
    button { background:var(--primary); color:#fff; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }
    .container { display:grid; grid-template-columns: 340px 1fr 460px; height: calc(100vh - 58px); }
    .list { border-right:1px solid var(--border); overflow:auto; background:#fff; }
    .item { padding:10px 14px; border-bottom:1px solid var(--border); cursor:pointer; }
    .item:hover { background: var(--hover); }
    .item.active { background: var(--active); border-left:3px solid var(--primary); padding-left:11px; }
    .item .subject { font-size:14px; }
    .item.unseen .subject { font-weight:700; }
    .item .meta { color: var(--sub); font-size:12px; margin-top:3px; display:flex; justify-content:space-between; gap:8px; }
    .detail { overflow:hidden; padding:16px 24px; background:#f9fafb; }
    .detail h2 { margin:0 0 8px; font-size:18px; }
    .detail .meta { color: var(--sub); font-size:12px; margin-bottom:14px; }
    .detail .content { background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .profile { margin-top:8px; background:#fff; border:1px solid var(--border); border-radius:8px; padding:12px; }
    .profile h3 { margin:0 0 10px; font-size:16px; }
    .profile .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .profile .kv { font-size:13px; }
    .profile .kv span { color: var(--sub); display:inline-block; min-width:90px; }
    .compose { border-left:1px solid var(--border); padding:16px 16px; overflow:auto; background:#fff; }
    .compose h3 { margin:0 0 10px; font-size:16px; }
    .compose .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .compose label { width:60px; color:var(--sub); font-size:12px; }
    .compose input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px; }
    .compose .editor { min-height:220px; border:1px solid var(--border); border-radius:8px; padding:12px; background:#fff; }
    .compose .actions { margin-top:10px; display:flex; gap:8px; }
    .muted { color:var(--sub); }
    .sub { color:var(--sub); font-size:12px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:100; }
    .modal .box { background:#fff; border-radius:10px; padding:16px; width:320px; border:1px solid var(--border); }
    .modal .row { display:flex; gap:8px; margin:10px 0; align-items:center; }
    .modal label { width:90px; color:var(--sub); font-size:12px; }
    .modal input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
    .modal select { flex:1; padding:12px 14px; border:2px solid var(--border); border-radius:8px; font-size:15px; font-weight:500; background:#fff; cursor:pointer; transition:all 0.2s; appearance:none; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23111827' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; }
    .modal select:hover { border-color:#111827; }
    .modal select:focus { outline:none; border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,0.1); }
    .modal textarea { flex:1; padding:12px 14px; border:2px solid var(--border); border-radius:8px; font-size:14px; font-family:inherit; resize:vertical; transition:all 0.2s; }
    .modal textarea:hover { border-color:#111827; }
    .modal textarea:focus { outline:none; border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,0.1); }
    .sidebar { position:fixed; top:0; right:-320px; width:320px; height:100vh; background:#fff; box-shadow:-4px 0 20px rgba(0,0,0,0.1); z-index:200; transition:right 0.3s ease; overflow-y:auto; }
    .sidebar.open { right:0; }
    .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:199; display:none; transition:opacity 0.3s; }
    .sidebar-overlay.open { display:block; }
    .sidebar-header { padding:20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .sidebar-header h3 { margin:0; font-size:18px; }
    .sidebar-close { background:none; border:0; font-size:24px; cursor:pointer; color:var(--sub); padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; }
    .sidebar-close:hover { background:var(--hover); color:var(--fg); }
    .sidebar-menu { padding:0; margin:0; list-style:none; }
    .sidebar-menu li { border-bottom:1px solid var(--border); }
    .sidebar-menu li a { display:flex; align-items:center; gap:12px; padding:16px 20px; text-decoration:none; color:var(--fg); font-size:15px; transition:background 0.2s; }
    .sidebar-menu li a:hover { background:var(--hover); }
    .sidebar-menu li a .icon { font-size:20px; width:24px; }
    
    /* Detail layout: scrollable content (70%) + scrollbares Profil (30%) im gleichen Panel (Desktop) */
    .detail {
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .detail-scroll {
      flex:0 0 70%;
      min-height:0;
      overflow:auto;
      padding-right:4px;
    }
    .detail > .profile {
      flex:0 0 30%;
      min-height:0;
      overflow:auto;
    }

    /* Responsive Design for Mobile */
    @media (max-width: 768px) {
      /* Header wraps on mobile */
      header { flex-wrap:wrap; gap:8px; padding:10px; }
      h1 { font-size:16px; flex:1; min-width:0; }
      .toolbar { flex-wrap:wrap; width:100%; justify-content:flex-end; gap:6px; }
      .toolbar button { padding:6px 10px; font-size:13px; }
      #status { order:-1; width:100%; margin:0 0 4px 0 !important; text-align:center; }
      
      /* Stack layout vertically on mobile */
      .container { 
        display:flex; 
        flex-direction:column; 
        height:auto; 
        min-height:calc(100vh - 100px); 
      }
      
      /* List takes full width, scroll horizontally disabled */
      .list { 
        border-right:none; 
        border-bottom:1px solid var(--border); 
        max-height:40vh; 
        width:100%; 
        overflow-x:hidden;
      }
      
      /* Detail takes full width (reset flex layout) */
      .detail { 
        width:100%; 
        min-height:300px;
        padding:12px;
        overflow-x:hidden;
        display:block;
      }
      .detail-scroll {
        padding-right:0;
        overflow:visible;
      }
      .detail > .profile {
        flex:none;
        max-height:none;
        overflow:visible;
      }
      
      /* Compose section on mobile */
      .compose { 
        border-left:none; 
        border-top:1px solid var(--border); 
        width:100%;
        padding:12px;
        overflow-x:hidden;
      }
      
      /* Make modals responsive */
      .modal .box { 
        width:90vw !important; 
        max-width:400px !important;
        max-height:85vh;
        overflow:auto;
      }
      
      /* Profile grid single column on mobile */
      .profile .grid { 
        grid-template-columns:1fr; 
      }
      
      /* Compose editor smaller on mobile */
      .compose .editor { 
        min-height:150px; 
        font-size:14px;
      }
      
      /* Actions wrap on mobile */
      .compose .actions { 
        flex-wrap:wrap; 
      }
      
      /* Detail content padding */
      .detail .content { 
        padding:12px; 
      }
    }

    /* Extra small devices */
    @media (max-width: 480px) {
      header { padding:8px; }
      h1 { font-size:14px; }
      .toolbar button { padding:5px 8px; font-size:12px; }
      .detail { padding:8px; }
      .compose { padding:8px; }
      .item { padding:8px 10px; }
      .profile { padding:10px; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <header>
    <h1>üì• Inbox</h1>
    <div class="toolbar">
      <button id="reload">Aktualisieren</button>
      <button id="load_more_btn" style="background:#0284c7; display:none;">üì• Weitere E-Mails laden</button>
      <span id="status" class="sub" style="margin-right:auto;"></span>
      <button id="user_badge" style="background:#111827; display:none;">üë§ Lade...</button>
      <button id="menu_btn" style="background:#111827; font-size:20px; padding:8px 14px;">‚ò∞</button>
    </div>
  </header>
  <div class="container">
    <div class="list" id="list">
      <div class="sub" style="padding:12px 14px;">Lade ‚Ä¶</div>
    </div>
    <div class="detail" id="detail">
      <div class="sub">E-Mail ausw√§hlen ‚Ä¶</div>
    </div>
    <div class="compose" id="compose">
      <h3>Antwort</h3>
      <div class="row"><label>Empf.</label><input id="compose_to" placeholder="Empf√§nger" /></div>
      <div class="row"><label>Betreff</label><input id="compose_subject" placeholder="Betreff" /></div>
      <div id="compose_editor" class="editor" contenteditable="true"><div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div></div>
      <div class="actions">
        <button id="btn_propose" disabled>Antwort vorschlagen</button>
        <button id="btn_send" disabled>Senden</button>
        <span id="compose_status" class="sub"></span>
      </div>
    </div>
  </div>

  <!-- Login Modal (required at app start) -->
  <div id="login_modal" class="modal" style="display:none;">
    <div class="box">
      <h3 style="margin:0 0 10px;">Login</h3>
      <div class="row"><label>E‚ÄëMail</label><input id="login_email" placeholder="you@domain.com"></div>
      <div class="row"><label>Passwort</label><input id="login_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="login_debug" style="background:#6b7280;">Debug</button>
        <button id="login_submit">Login</button>
      </div>
      <div id="login_msg" class="sub" style="margin-top:8px; white-space:pre-wrap; text-align:left;"></div>
    </div>
  </div>

  <!-- E-Mail Settings Modal -->
  <div id="email_settings_modal" class="modal">
    <div class="box" style="width:480px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">E‚ÄëMail Einstellungen</h3>
      <div style="margin-bottom:12px; padding:10px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; display:flex; flex-direction:column; gap:8px;">
        <div class="row" style="margin:0; align-items:center;">
          <label style="width:100px;">Account</label>
          <select id="email_account_select" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="">Neuer Account ‚Ä¶</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="email_account_new" style="background:#059669;">‚ûï Neuer Account</button>
          <button id="email_account_delete" style="background:#dc2626;">üóë Account l√∂schen</button>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">IMAP (Empfang)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="imap_host" placeholder="imap.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="imap_port" type="number" placeholder="993"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="imap_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="imap_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="imap_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
          </select>
        </div>
        <div id="imap_port_hint" class="sub" style="margin-top:8px; padding:8px; background:#fef3c7; border:1px solid #fbbf24; border-radius:4px; display:none;">
          üí° <span id="imap_port_hint_text"></span>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">SMTP (Versand)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="smtp_host" placeholder="smtp.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="smtp_port" type="number" placeholder="465"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="smtp_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="smtp_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="smtp_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
            <option value="auto">Auto</option>
          </select>
        </div>
        <div id="smtp_port_hint" class="sub" style="margin-top:8px; padding:8px; background:#fef3c7; border:1px solid #fbbf24; border-radius:4px; display:none;">
          üí° <span id="smtp_port_hint_text"></span>
        </div>
      </div>
      <div style="margin-bottom:12px; padding:12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px;">
        <button id="smtp_test_btn" style="background:#0284c7; color:#fff; width:100%;">üîß SMTP-Verbindung testen</button>
        <div id="smtp_test_result" class="sub" style="margin-top:8px;"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="email_settings_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="email_settings_save">Speichern</button>
      </div>
      <div id="email_settings_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="user_management_modal" class="modal">
    <div class="box" style="width:640px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">üë• User-Verwaltung</h3>
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <button id="btn_new_user" style="background:#059669;">‚ûï Neuer User</button>
      </div>
      <div id="user_list" style="background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:12px; min-height:200px;">
        <div class="sub">Lade User...</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="user_management_close" style="background:#6b7280;">Schlie√üen</button>
      </div>
      <div id="user_management_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Sidebar Menu -->
  <div class="sidebar-overlay" id="sidebar_overlay"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>‚öôÔ∏è Einstellungen</h3>
      <button class="sidebar-close" id="sidebar_close">‚úï</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" id="sidebar_profile"><span class="icon">üë§</span> Profil</a></li>
      <li><a href="#" id="sidebar_agent"><span class="icon">ü§ñ</span> Agent-Setup</a></li>
      <li><a href="#" id="sidebar_knowledge"><span class="icon">üìö</span> Wissensdatenbank</a></li>
      <li><a href="#" id="sidebar_contacts"><span class="icon">üìá</span> Kontakte</a></li>
      <li><a href="#" id="sidebar_email"><span class="icon">‚úâÔ∏è</span> E-Mail-Einstellungen</a></li>
      <li id="sidebar_users_item" style="display:none;"><a href="#" id="sidebar_users"><span class="icon">üë•</span> User-Verwaltung</a></li>
      <li style="border-top:2px solid var(--border);"><a href="#" id="sidebar_logout" style="color:#dc2626;"><span class="icon">üö™</span> Logout</a></li>
    </ul>
  </div>

  <!-- Profile Modal -->
  <div id="profile_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">üë§ Mein Profil</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="profile_email" disabled style="background:#f3f4f6;"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="profile_first" placeholder="Vorname"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="profile_last" placeholder="Nachname"></div>
      <div class="row"><label style="width:100px;">Rolle</label><input id="profile_role" disabled style="background:#f3f4f6;"></div>
      <div style="border-top:1px solid var(--border); margin:16px 0; padding-top:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">üîí Passwort √§ndern (optional)</h4>
        <div class="row"><label style="width:100px;">Neu</label><input id="profile_new_pass" type="password" placeholder="min. 6 Zeichen"></div>
        <div class="row"><label style="width:100px;">Wiederholen</label><input id="profile_confirm_pass" type="password" placeholder="best√§tigen"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="profile_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="profile_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="profile_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- New User Modal -->
  <div id="new_user_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">‚ûï Neuer User</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="new_user_email" placeholder="user@example.com"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="new_user_first" placeholder="Max"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="new_user_last" placeholder="Mustermann"></div>
      <div class="row"><label style="width:100px;">Passwort</label><input id="new_user_pass" type="password" placeholder="min. 6 Zeichen"></div>
      <div class="row"><label style="width:100px;">Rolle</label>
        <select id="new_user_role" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superadmin">Superadmin</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="new_user_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="new_user_save" style="background:#059669;">Erstellen</button>
      </div>
      <div id="new_user_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Agent Setup Modal -->
  <div id="agent_setup_modal" class="modal">
    <div class="box" style="width:520px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin:0 0 12px;">ü§ñ Agent-Setup</h3>
      
      <div class="row">
        <label style="width:120px;">Agent-Rolle</label>
        <select id="agent_role">
          <option value="">-- Bitte w√§hlen --</option>
          <option value="Vertrieb">Vertrieb</option>
          <option value="Support">Support</option>
          <option value="Manager">Manager</option>
          <option value="Controller">Controller</option>
          <option value="HR">HR / Personalwesen</option>
          <option value="Sonstige">Sonstige</option>
        </select>
      </div>
      
      <div class="row" style="align-items:flex-start; margin-top:16px;">
        <label style="width:120px; padding-top:12px;">Anweisungen</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="agent_instructions" placeholder="z.B. 'Antworte immer kurz und h√∂flich...'" rows="5" maxlength="500" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Max. 500 Zeichen</small>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="agent_setup_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="agent_setup_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="agent_setup_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Knowledge Base Modal -->
  <div id="knowledge_modal" class="modal">
    <div class="box" style="width:600px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin:0 0 12px;">üìö Wissensdatenbank</h3>
      
      <div class="row" style="align-items:flex-start;">
        <label style="width:140px; padding-top:12px;">FAQ-Text</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="knowledge_faq" placeholder="Kopiere deine FAQs hier rein&#10;&#10;z.B.&#10;F: Wie lange dauert die Lieferung?&#10;A: 2-3 Werktage&#10;&#10;F: Was kostet der Versand?&#10;A: Versandkostenfrei ab 50‚Ç¨" rows="12" maxlength="5000" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Max. 5000 Zeichen</small>
        </div>
      </div>
      
      <div class="row" style="align-items:flex-start; margin-top:16px;">
        <label style="width:140px; padding-top:12px;">Dokument-Links</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="knowledge_links" placeholder="Links zu Dokumenten (einer pro Zeile)&#10;&#10;z.B.&#10;https://firma.de/faq.pdf&#10;https://firma.de/preisliste.pdf&#10;https://firma.de/handbuch.docx" rows="6" maxlength="2000" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Optional - Ein Link pro Zeile, max. 2000 Zeichen</small>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="knowledge_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="knowledge_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="knowledge_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div id="contacts_modal" class="modal">
    <div class="box" style="width:700px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 16px;">üìá Kontakte</h3>
      <div style="margin-bottom:16px;">
        <input id="contacts_search" type="text" placeholder="üîç Suche nach Name oder E-Mail..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
      </div>
      <div id="contacts_list" style="min-height:200px;">
        <div class="sub" style="text-align:center; padding:20px;">Lade Kontakte...</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="contacts_close" style="background:#6b7280;">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Contact Detail Modal -->
  <div id="contact_detail_modal" class="modal">
    <div class="box" style="width:800px; max-height:90vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
        <div>
          <h3 id="contact_detail_name" style="margin:0 0 4px;">Kontakt</h3>
          <div class="sub" id="contact_detail_email">email@example.com</div>
        </div>
        <button id="contact_detail_close" style="background:#6b7280; padding:8px 12px;">‚úï</button>
      </div>
      <div class="sub" style="margin-bottom:12px;">
        <strong id="contact_detail_count">0</strong> E-Mails insgesamt
      </div>
      <div id="contact_detail_emails" style="border-top:1px solid var(--border); padding-top:16px;">
        <div class="sub" style="text-align:center; padding:20px;">Lade E-Mails...</div>
      </div>
    </div>
  </div>

  <script>
    let currentUid = null;
    // Load email limit from localStorage or default to 50
    let currentEmailLimit = parseInt(localStorage.getItem('emailLimit')) || 50;
    // Aktueller E-Mail-Account (Multi-Account-Unterst√ºtzung)
    let currentAccountId = null;
    // E-Mail-Accounts f√ºr Einstellungen (Verwaltung im Modal)
    let emailAccounts = [];
    let currentSettingsAccountId = null;
    // Inbox filtering: 'relevant' (default) vs 'other'
    let inboxFilter = 'relevant';
    let inboxEmails = [];
    async function parseJsonSafe(res){
      const ct = res.headers.get('content-type') || '';
      const txt = await res.text();
      if(ct.includes('application/json')){
        try { return { __ok: res.ok, __status: res.status, ...(txt ? JSON.parse(txt) : {}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: 'Ung√ºltiges JSON vom Server', raw: txt }; }
      }
      // Fallback: leere OK-Antwort als Erfolg behandeln (manche Proxies strippen kleine JSON-Bodies)
      if(res.ok && (!txt || txt.trim() === '')){
        return { __ok: true, __status: res.status };
      }
      // Versuche JSON, sonst Fehlertext kapseln
      try { return { __ok: res.ok, __status: res.status, ...(JSON.parse(txt)||{}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: txt || 'Leere Antwort vom Server' }; }
    }
    
    // Format customer profile with HTML structure
    function formatCustomerProfile(text){
      if(!text) return text;
      
      // Split by numbered sections (1., 2., 3., etc.) or double asterisks
      let html = text;
      
      // Format bold sections: **Text:** -> <strong>Text:</strong>
      html = html.replace(/\*\*([^*]+):\*\*/g, '<strong style="color:#7c3aed;font-size:1.05em;">$1:</strong>');
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      // Format numbered sections: 1. **Title** -> <h4>Title</h4>
      html = html.replace(/(\d+)\.\s+\*\*([^*]+)\*\*/g, '<h4 style="margin:12px 0 6px 0;color:#7c3aed;font-size:1.1em;">$1. $2</h4>');
      
      // Format bullet points: ‚Ä¢ or - at line start
      html = html.replace(/^[‚Ä¢\-]\s+(.+)$/gm, '<div style="margin-left:16px;margin-bottom:4px;">‚Ä¢ $1</div>');
      
      // Format paragraphs: double line breaks
      html = html.split('\n\n').map(para => {
        para = para.trim();
        if(!para) return '';
        // Don't wrap if already has HTML tags
        if(para.includes('<h4') || para.includes('<div')) return para;
        return `<p style="margin:8px 0;line-height:1.6;">${para}</p>`;
      }).join('');
      
      // Single line breaks to <br>
      html = html.replace(/\n/g, '<br>');
      
      return html;
    }
    
    function isRelevantEmail(it){
      const fromAddr = (it.from_addr || it.from || '').toLowerCase();
      const subject = (it.subject || '').toLowerCase();
      // Heuristik: Newsletter / No-Reply / Massenmails als "Sonstige" markieren
      const newsletterLike = /(no-?reply|newsletter|news@|mailer@|noreply)/.test(fromAddr) ||
                             subject.includes('newsletter') || subject.includes('angebote') || subject.includes('sale');
      // Wenn Kontakt bereits mehrere E-Mails hat, eher wichtig
      const count = it.contact_email_count || 0;
      if (count >= 3) return true;
      // Eigene Domain-Kontakte immer als relevant
      if (fromAddr.includes('@neckattack.')) return true;
      return !newsletterLike;
    }

    function setupInboxFilterToggle(){
      const list = document.getElementById('list');
      if(!list) return;
      // Toggle soll innerhalb der linken Listenspalte direkt √ºber den Items sitzen
      if(document.getElementById('inbox_filter_toggle')) return;
      const toggle = document.createElement('div');
      toggle.id = 'inbox_filter_toggle';
      toggle.style.cssText = 'display:flex; justify-content:flex-start; gap:8px; align-items:center; margin:4px 0 8px 0; font-size:12px;';
      toggle.innerHTML = `
        <div style="display:inline-flex; background:#e5e7eb; border-radius:999px; padding:2px;">
          <button id="filter_relevant" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:#fff; color:#111827; font-weight:600;">Relevant</button>
          <button id="filter_other" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:transparent; color:#4b5563;">Sonstige</button>
        </div>
      `;
      // In die Listenspalte einf√ºgen, direkt vor dem ersten Inhalt
      list.insertBefore(toggle, list.firstChild);
      const btnRel = document.getElementById('filter_relevant');
      const btnOther = document.getElementById('filter_other');
      const updateButtons = () => {
        if(inboxFilter === 'relevant'){
          btnRel.style.background = '#fff';
          btnRel.style.color = '#111827';
          btnRel.style.fontWeight = '600';
          btnOther.style.background = 'transparent';
          btnOther.style.color = '#4b5563';
          btnOther.style.fontWeight = '400';
        } else {
          btnOther.style.background = '#fff';
          btnOther.style.color = '#111827';
          btnOther.style.fontWeight = '600';
          btnRel.style.background = 'transparent';
          btnRel.style.color = '#4b5563';
          btnRel.style.fontWeight = '400';
        }
      };
      btnRel.addEventListener('click', () => { inboxFilter = 'relevant'; updateButtons(); renderInboxList(); });
      btnOther.addEventListener('click', () => { inboxFilter = 'other'; updateButtons(); renderInboxList(); });
      updateButtons();
    }

    function renderInboxList(){
      const list = document.getElementById('list');
      const status = document.getElementById('status');
      if(!list) return;
      const toggle = document.getElementById('inbox_filter_toggle');
      // Nur die E-Mail-Items unterhalb des Toggles leeren
      if(toggle){
        while(list.lastChild && list.lastChild !== toggle){
          list.removeChild(list.lastChild);
        }
      } else {
        list.innerHTML = '';
      }
      if(!inboxEmails || !inboxEmails.length){
        list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Keine E-Mails im Posteingang.</div>';
        if(status) status.textContent = '';
        return;
      }
      const filtered = inboxEmails.filter(it => {
        const rel = isRelevantEmail(it);
        return inboxFilter === 'relevant' ? rel : !rel;
      });
      if(!filtered.length){
        list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Keine E-Mails in dieser Ansicht.</div>';
        return;
      }
      for(const it of filtered){
        const div = document.createElement('div');
        div.className = 'item' + (!it.is_read ? ' unseen' : '');
        div.dataset.uid = it.uid;
        div.innerHTML = `
          <div class="subject">${escapeHtml(it.subject || '(ohne Betreff)')}</div>
          <div class="meta"><span>${escapeHtml(it.from || '')}</span><span>${escapeHtml(it.date || '')}</span></div>
        `;
        div.addEventListener('click', () => selectItem(it.uid, div));
        list.appendChild(div);
      }
    }

    async function loadInbox(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      status.textContent = 'l√§dt ‚Ä¶';
      try{
        if(!currentAccountId){
          // Ohne Account keine Anfragen; versuche Accounts zu laden
          await ensureEmailAccountsLoaded();
          if(!currentAccountId){
            list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Kein E-Mail-Account konfiguriert.</div>';
            status.textContent = '';
            return;
          }
        }
        // Load emails from database with current limit
        const res = await fetch(`/api/emails/list?folder=inbox&limit=${currentEmailLimit}&account_id=${encodeURIComponent(currentAccountId)}`, {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(!data.__ok){ 
          // Check if user needs to configure email settings
          if(data.error && (data.error.includes('configure email settings') || data.error.includes('IMAP settings'))){
            list.innerHTML = `
              <div style="padding:20px; text-align:center;">
                <div style="font-size:48px; margin-bottom:16px;">üìß</div>
                <div style="font-size:16px; font-weight:600; margin-bottom:8px;">E-Mail-Einstellungen fehlen</div>
                <div class="sub" style="margin-bottom:16px;">Bitte konfigurieren Sie zuerst Ihre IMAP/SMTP-Zugangsdaten</div>
                <button id="setup_email_btn" style="background:#059669; color:#fff; border:0; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px;">‚öôÔ∏è E-Mail-Einstellungen konfigurieren</button>
              </div>
            `;
            document.getElementById('setup_email_btn').addEventListener('click', openEmailSettingsModal);
            status.textContent = '';
            return;
          }
          throw new Error(data.error || 'Inbox-Fehler'); 
        }
        
        // Check if initial sync is needed
        if(data.total_all_folders === 0){
          await showInitialSyncDialog();
          return;
        }
        
        // Store emails for filtering and render list
        inboxEmails = data.emails || [];
        setupInboxFilterToggle();
        renderInboxList();
        
        // Show/hide "Load more" button and check server count
        const loadMoreBtn = document.getElementById('load_more_btn');
        const totalInDB = data.total || 0;
        
        // Check server for total count if we can sync more
        if(data.can_sync_more){
          loadMoreBtn.style.display = 'inline-block';
          loadMoreBtn.textContent = `üì• Weitere E-Mails laden...`;
          loadMoreBtn.disabled = true;
          
          // Get server count
          fetch('/api/emails/sync', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({ count_only: true, account_id: currentAccountId })
          })
          .then(res => res.json())
          .then(countData => {
            loadMoreBtn.disabled = false;
            if(countData.total_on_server){
              const onServer = countData.total_on_server;
              const remaining = onServer - totalInDB;
              if(remaining > 0){
                loadMoreBtn.textContent = `üì• Weitere E-Mails laden (${remaining} auf Server)`;
                status.textContent = `${currentEmailLimit} von ${totalInDB} in DB geladen ¬∑ ${onServer} auf Server verf√ºgbar`;
              } else {
                loadMoreBtn.textContent = `‚úÖ Alle E-Mails geladen`;
                status.textContent = `${currentEmailLimit} E-Mails geladen ¬∑ Alles synchronisiert (${onServer} auf Server)`;
              }
            }
          })
          .catch(() => {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = `üì• Nach neuen E-Mails suchen`;
          });
        } else if(data.has_more){
          // More emails in DB
          loadMoreBtn.style.display = 'inline-block';
          loadMoreBtn.textContent = `üì• Weitere E-Mails laden (${totalInDB - currentEmailLimit} in DB)`;
          status.textContent = `${currentEmailLimit} von ${totalInDB} E-Mails in DB geladen`;
        } else {
          loadMoreBtn.style.display = 'none';
          status.textContent = `${currentEmailLimit} E-Mails geladen`;
        }
      }catch(e){
        list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${e}</div>`;
        status.textContent = '';
      }
    }
    
    async function loadMoreEmails(){
      const loadMoreBtn = document.getElementById('load_more_btn');
      const originalText = loadMoreBtn.textContent;
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = '‚è≥ L√§dt...';
      
      // Show dialog to choose how many
      const choice = await new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:30px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:10000; max-width:400px;';
        dialog.innerHTML = `
          <h3 style="margin:0 0 16px;">Wie viele E-Mails laden?</h3>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="load-choice" data-count="20" style="background:#059669; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">üì• Weitere 20 E-Mails</button>
            <button class="load-choice" data-count="50" style="background:#0284c7; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">üì• Weitere 50 E-Mails</button>
            <button class="load-choice" data-count="100" style="background:#7c3aed; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">üì• Weitere 100 E-Mails</button>
            <button class="load-choice" data-count="500" style="background:#d97706; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">üì• Weitere 500 E-Mails</button>
            <button class="load-choice" data-count="1000" style="background:#dc2626; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">‚ö° Weitere 1.000 E-Mails</button>
            <button class="load-choice" data-count="5000" style="background:#991b1b; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">‚ö†Ô∏è Weitere 5.000 E-Mails (langsam!)</button>
            <button class="load-choice" data-count="0" style="background:#6b7280; color:#fff; border:0; padding:11px; border-radius:8px; cursor:pointer; font-size:14px;">Abbrechen</button>
          </div>
        `;
        document.body.appendChild(dialog);
        
        dialog.querySelectorAll('.load-choice').forEach(btn => {
          btn.addEventListener('click', () => {
            const count = parseInt(btn.dataset.count);
            document.body.removeChild(dialog);
            resolve(count);
          });
        });
      });
      
      if(choice === 0){
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = originalText;
        return;
      }
      
      try{
        // Sync more emails
        const syncRes = await fetch('/api/emails/sync', {
          method: 'POST',
          headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({ limit: choice, account_id: currentAccountId })
        });
        const syncData = await parseJsonSafe(syncRes);
        
        if(!syncData.__ok){
          throw new Error(syncData.error || 'Sync fehlgeschlagen');
        }
        
        // Increase limit to show newly synced emails
        currentEmailLimit += choice;
        localStorage.setItem('emailLimit', currentEmailLimit);
        
        // Reload inbox with new limit
        await loadInbox();
        
      }catch(e){
        alert('Fehler beim Laden: ' + e);
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = originalText;
      }
    }
    
    async function showInitialSyncDialog(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      
      status.textContent = 'Pr√ºfe Postfach...';
      
      // Count emails on server
      try{
        const countRes = await fetch('/api/emails/sync', {
          method: 'POST',
          headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({ count_only: true, account_id: currentAccountId })
        });
        const countData = await parseJsonSafe(countRes);
        
        if(!countData.__ok){
          status.textContent = 'Fehler beim Z√§hlen';
          list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${countData.error}</div>`;
          return;
        }
        
        const total = countData.total_on_server;
        status.textContent = '';
        
        // Show dialog
        list.innerHTML = `
          <div style="padding:40px; text-align:center;">
            <div style="font-size:48px; margin-bottom:16px;">üì¨</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Postfach noch nicht synchronisiert</div>
            <div class="sub" style="margin-bottom:24px;">Es wurden <strong>${total} E-Mails</strong> auf dem Server gefunden.<br>Wie viele m√∂chten Sie laden?</div>
            
            <div style="display:flex; flex-direction:column; gap:10px; max-width:400px; margin:0 auto;">
              <button class="sync-btn" data-limit="20" style="background:#059669; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 20 E-Mails
              </button>
              <button class="sync-btn" data-limit="50" style="background:#0284c7; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 50 E-Mails
              </button>
              <button class="sync-btn" data-limit="100" style="background:#7c3aed; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 100 E-Mails
              </button>
              <button class="sync-btn" data-limit="500" style="background:#d97706; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 500 E-Mails
              </button>
              <button class="sync-btn" data-limit="1000" style="background:#dc2626; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                ‚ö° Erste 1.000 E-Mails
              </button>
              ${total > 1000 ? `
                <button class="sync-btn" data-limit="all" style="background:#991b1b; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                  ‚ö†Ô∏è Alle ${total} E-Mails (sehr langsam!)
                </button>
              ` : ''}
            </div>
            
            <div class="sub" style="margin-top:20px;">üí° Sie k√∂nnen sp√§ter jederzeit weitere E-Mails nachladen</div>
          </div>
        `;
        
        // Add click handlers
        document.querySelectorAll('.sync-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const limit = btn.dataset.limit === 'all' ? null : parseInt(btn.dataset.limit);
            await performSync(limit);
          });
        });
        
      }catch(e){
        status.textContent = 'Fehler';
        list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${e}</div>`;
      }
    }
    
    async function performSync(limit){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      
      list.innerHTML = `
        <div style="padding:40px; text-align:center;">
          <div style="font-size:48px; margin-bottom:16px;">‚è≥</div>
          <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Synchronisiere E-Mails...</div>
          <div id="sync-progress" class="sub" style="margin-bottom:16px;">Starte...</div>
          <div style="width:80%; max-width:400px; height:8px; background:#e5e7eb; border-radius:4px; margin:0 auto; overflow:hidden;">
            <div id="sync-progress-bar" style="width:0%; height:100%; background:#059669; transition:width 0.3s;"></div>
          </div>
        </div>
      `;
      
      try{
        const syncRes = await fetch('/api/emails/sync', {
          method: 'POST',
          headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({ limit: limit, account_id: currentAccountId })
        });
        const syncData = await parseJsonSafe(syncRes);
        
        if(!syncData.__ok){
          throw new Error(syncData.error || 'Sync fehlgeschlagen');
        }
        
        document.getElementById('sync-progress').textContent = 
          `‚úÖ ${syncData.synced} E-Mails geladen, ${syncData.new_contacts} neue Kontakte gefunden!`;
        document.getElementById('sync-progress-bar').style.width = '100%';
        
        // Set limit to synced count (or keep current if higher)
        if(limit){
          currentEmailLimit = Math.max(currentEmailLimit, limit);
          localStorage.setItem('emailLimit', currentEmailLimit);
        }
        
        // Reload inbox after 1 second
        setTimeout(() => {
          loadInbox();
        }, 1000);
        
      }catch(e){
        list.innerHTML = `
          <div style="padding:40px; text-align:center;">
            <div style="font-size:48px; margin-bottom:16px;">‚ùå</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Synchronisierung fehlgeschlagen</div>
            <div class="sub" style="margin-bottom:20px;">${e}</div>
            <button onclick="loadInbox()" style="background:#059669; color:#fff; border:0; padding:10px 20px; border-radius:6px; cursor:pointer;">
              Erneut versuchen
            </button>
          </div>
        `;
      }
    }

    async function selectItem(uid, rowEl){
      // Active markieren
      document.querySelectorAll('.item.active').forEach(el => el.classList.remove('active'));
      rowEl.classList.add('active');
      currentUid = uid;
      // Draft-Controls aktivieren
      document.getElementById('btn_propose').disabled = false;
      document.getElementById('btn_send').disabled = false;
      // Compose-Bereich f√ºr neue Auswahl zur√ºcksetzen, damit alte Vorschl√§ge nicht irritieren
      try {
        const toInput = document.getElementById('compose_to');
        const subjInput = document.getElementById('compose_subject');
        const editor = document.getElementById('compose_editor');
        const status = document.getElementById('compose_status');
        if (toInput) toInput.value = '';
        if (subjInput) subjInput.value = '';
        if (editor) editor.innerHTML = '<div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div>';
        if (status) status.textContent = '';
      } catch(_) {}
      // Load email from database
      const detail = document.getElementById('detail');
      detail.innerHTML = '<div class="sub">Lade Inhalt ‚Ä¶</div>';
      try{
        const res = await fetch(`/api/emails/get/${uid}`, {
          headers: getAuthHeaders()
        });
        const t = await parseJsonSafe(res);
        if(!t.__ok){ throw new Error(t.error || 'E-Mail konnte nicht geladen werden'); }
        const html = t.body_html || (t.body_text ? `<pre>${escapeHtml(t.body_text)}</pre>` : '<div class="sub">Kein Inhalt</div>');
        
        // Extract contact info
        let contactName = t.contact_name || t.from || '‚Äì';
        const contactEmail = t.contact_email || t.from_addr || '‚Äì';
        const emailCount = t.contact_email_count || 1;
        const profileSummary = t.profile_summary || '';
        const kpis = t.kpis || {};
        
        // Helper: Extract real name from email or profile
        function extractRealName(name, email, profile) {
          // If name is an email address, extract local part
          if (name && name.includes('@')) {
            const localPart = name.split('@')[0];
            name = localPart.charAt(0).toUpperCase() + localPart.slice(1);
          }
          
          // If name is still empty or looks like email, try profile
          if (!name || name === '‚Äì' || name.includes('@')) {
            if (profile) {
              // Try to extract name from profile: "Johanna ist..." at start
              const match1 = profile.match(/^([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)\s+(ist|arbeitet|hat|sendet)/);
              if (match1) {
                name = match1[1];
              } else {
                // Pattern 2: Look for capitalized name after common phrases
                const match2 = profile.match(/(?:Kunde|Person|Kontakt|Name):\s*([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)/);
                if (match2) {
                  name = match2[1];
                }
              }
            }
          }
          
          // Final fallback: extract from email
          if (!name || name === '‚Äì' || name.includes('@')) {
            const localPart = email.split('@')[0];
            name = localPart.charAt(0).toUpperCase() + localPart.slice(1);
          }
          
          return name;
        }
        
        // Extract real name
        contactName = extractRealName(contactName, contactEmail, profileSummary);
        
        detail.innerHTML = `
          <div class="detail-scroll">
            <h2>${escapeHtml(t.subject || '')}</h2>
            <div class="meta">Von: ${escapeHtml(t.from||'')} ¬∑ An: ${escapeHtml(t.to||'')} ¬∑ ${escapeHtml(t.date||'')}</div>
            <div class="content">${html}</div>
          </div>
          <div class="profile" id="profile_panel" data-contact-id="${t.contact_id || ''}">
            <h3>üë§ KONTAKT-PROFIL</h3>
            <div class="grid">
              <div>
                <div class="kv"><span>Name</span><b>${escapeHtml(contactName)}</b></div>
                <div class="kv"><span>E‚ÄëMail</span><b>${escapeHtml(contactEmail)}</b></div>
                <div class="kv"><span>E-Mails</span><b>${emailCount} Nachricht${emailCount !== 1 ? 'en' : ''}</b></div>
              </div>
            </div>
            <div style="margin-top:12px;">
              <button id="view_all_contact_emails" data-contact-id="${t.contact_id || ''}" style="background:#0284c7; color:#fff; border:0; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:13px; width:100%;">
                üìß Alle E-Mails von diesem Kontakt (${emailCount})
              </button>
            </div>
            <div style="margin-top:16px; font-size:13px; border-top:1px solid var(--border); padding-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="font-weight:600;">ü§ñ KI-Kundenprofil</div>
                <button id="generate_profile_btn" data-contact-id="${t.contact_id || ''}" style="background:#7c3aed; color:#fff; border:0; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
                  ${profileSummary ? 'üîÑ Neu generieren' : 'Profil erstellen'}
                </button>
              </div>
              ${kpis.salutation || kpis.sentiment || kpis.email_length_preference || kpis.communication_frequency ? `
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
                  ${kpis.salutation ? `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:#dbeafe; color:#1e40af; border-radius:4px; font-size:11px; font-weight:500;">
                    üëã Anrede: ${kpis.salutation}
                  </span>` : ''}
                  ${kpis.sentiment ? `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:${
                    kpis.sentiment === 'positive' ? '#d1fae5;color:#065f46' : 
                    kpis.sentiment === 'negative' ? '#fee2e2;color:#991b1b' : 
                    '#f3f4f6;color:#374151'
                  }; border-radius:4px; font-size:11px; font-weight:500;">
                    ${kpis.sentiment === 'positive' ? 'üòä' : kpis.sentiment === 'negative' ? 'üòü' : 'üòê'} Stimmung: ${
                      kpis.sentiment === 'positive' ? 'Positiv' : 
                      kpis.sentiment === 'negative' ? 'Negativ' : 
                      'Neutral'
                    }
                  </span>` : ''}
                  ${kpis.email_length_preference ? `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:#fef3c7; color:#92400e; border-radius:4px; font-size:11px; font-weight:500;">
                    üìè E-Mail-L√§nge: ${kpis.email_length_preference === 'short' ? 'Kurz' : kpis.email_length_preference === 'medium' ? 'Mittel' : 'Lang'}
                  </span>` : ''}
                  ${kpis.communication_frequency ? `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:#e0e7ff; color:#3730a3; border-radius:4px; font-size:11px; font-weight:500;">
                    üìä Kontakt: ${kpis.communication_frequency === 'daily' ? 'T√§glich' : kpis.communication_frequency === 'weekly' ? 'W√∂chentlich' : kpis.communication_frequency === 'monthly' ? 'Monatlich' : 'Selten'}
                  </span>` : ''}
                </div>
              ` : ''}
              <div id="prof_summary" class="sub" style="padding:10px; background:${profileSummary ? '#f0fdf4' : '#f9fafb'}; border-radius:6px; line-height:1.5;">
                ${profileSummary ? formatCustomerProfile(profileSummary) : 'Noch kein Profil vorhanden. Klicken Sie oben, um ein KI-Profil zu erstellen.'}
              </div>
            </div>
            <div style="margin-top:16px; font-size:13px; border-top:1px solid var(--border); padding-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div style="font-weight:600;">üìù Notizen</div>
              </div>
              <div id="contact_notes_list" class="sub" style="max-height:120px; overflow:auto; padding:6px 0; border-radius:4px; background:#f9fafb;"></div>
              <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
                <textarea id="contact_note_input" rows="2" placeholder="Kurze Notiz zum Kontakt (z.B. 'Angestellter von neckattack', 'Diesen Kontakt ignorieren', ...)" style="width:100%; font-size:12px; padding:6px 8px; border-radius:4px; border:1px solid var(--border); resize:vertical;"></textarea>
                <button id="contact_note_save" style="align-self:flex-end; background:#059669; color:#fff; border:0; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">Notiz speichern</button>
                <div id="contact_note_status" class="sub"></div>
              </div>
            </div>
          </div>
        `;
        // Event handler for "View all contact emails" button
        const viewAllBtn = document.getElementById('view_all_contact_emails');
        if(viewAllBtn && t.contact_id){
          viewAllBtn.onclick = () => {
            openContactDetailModal(t.contact_id, contactName, contactEmail);
          };
        }

        // Kontakt-Notizen laden und speichern
        try {
          const notesList = document.getElementById('contact_notes_list');
          const noteInput = document.getElementById('contact_note_input');
          const noteSave = document.getElementById('contact_note_save');
          const noteStatus = document.getElementById('contact_note_status');
          const contactId = t.contact_id;

          async function loadNotes(){
            if(!notesList || !contactId) return;
            notesList.textContent = 'Lade Notizen...';
            try {
              const res = await fetch(`/api/contacts/${contactId}/notes`, { headers: getAuthHeaders() });
              const data = await parseJsonSafe(res);
              if(!data.__ok){ throw new Error(data.error || 'Fehler'); }
              const notes = data.notes || [];
              if(!notes.length){
                notesList.innerHTML = '<div class="sub" style="padding:4px 6px;">Noch keine Notizen vorhanden.</div>';
              } else {
                notesList.innerHTML = notes.map(n => `
                  <div style="padding:4px 6px; border-bottom:1px solid #e5e7eb;">
                    <div style="font-size:12px;">${escapeHtml(n.text)}</div>
                    <div class="sub" style="font-size:11px;">${escapeHtml(n.created_at)}</div>
                  </div>
                `).join('');
              }
            } catch(e) {
              notesList.innerHTML = `<div class="sub" style="padding:4px 6px; color:#dc2626;">Fehler beim Laden der Notizen: ${e}</div>`;
            }
          }

          if(noteSave && noteInput && contactId){
            noteSave.onclick = async () => {
              const txt = (noteInput.value || '').trim();
              if(!txt){
                noteStatus.textContent = 'Notiz darf nicht leer sein.';
                return;
              }
              noteSave.disabled = true;
              noteStatus.textContent = 'Speichere Notiz...';
              try {
                const res = await fetch(`/api/contacts/${contactId}/notes`, {
                  method: 'POST',
                  headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                  body: JSON.stringify({ text: txt })
                });
                const data = await parseJsonSafe(res);
                if(!data.__ok){ throw new Error(data.error || 'Fehler'); }
                noteInput.value = '';
                noteStatus.textContent = 'Notiz gespeichert.';
                await loadNotes();
              } catch(e) {
                noteStatus.textContent = `Fehler: ${e}`;
              } finally {
                noteSave.disabled = false;
              }
            };
          }

          loadNotes();
        } catch(_) {}
        
        // Event handler for "Generate profile" button
        const generateBtn = document.getElementById('generate_profile_btn');
        const summaryDiv = document.getElementById('prof_summary');
        if(generateBtn && t.contact_id){
          generateBtn.onclick = async () => {
            const originalText = generateBtn.textContent;
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generiere...';
            summaryDiv.textContent = 'Analysiere E-Mails und erstelle Kundenprofil...';
            summaryDiv.style.background = '#fef3c7';
            
            try{
              const res = await fetch(`/api/contacts/${t.contact_id}/generate-profile`, {
                method: 'POST',
                headers: getAuthHeaders()
              });
              const data = await parseJsonSafe(res);
              
              if(data.__ok && data.summary){
                summaryDiv.innerHTML = formatCustomerProfile(data.summary);
                summaryDiv.style.background = '#f0fdf4';
                generateBtn.textContent = 'üîÑ Neu generieren';
                generateBtn.disabled = false;
              } else {
                throw new Error(data.error || 'Profil-Generierung fehlgeschlagen');
              }
            }catch(e){
              summaryDiv.textContent = `‚ùå Fehler: ${e}`;
              summaryDiv.style.background = '#fee2e2';
              generateBtn.textContent = originalText;
              generateBtn.disabled = false;
            }
          };
        }
        
        // Als gelesen markieren (opt-in: beim √ñffnen)
        try{ await fetch('/api/emails/seen', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, seen:true})}); }catch(_){ }
        rowEl.classList.remove('unseen');
        // Prefetch: Draft im Hintergrund erzeugen
        try {
          const toInput = document.getElementById('compose_to');
          const subjInput = document.getElementById('compose_subject');
          const editor = document.getElementById('compose_editor');
          const res2 = await fetch('/api/emails/agent-compose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, timeout_s: 8}) });
          const data2 = await parseJsonSafe(res2);
          if(data2 && data2.__ok && currentUid === uid){
            // Nur bef√ºllen, wenn Editor noch leer/Marker enth√§lt
            const htmlNow = (editor.innerHTML||'').trim();
            const isEmpty = !htmlNow || htmlNow.includes('Hier erscheint der Vorschlag');
            if(isEmpty){
              toInput.value = data2.to || '';
              subjInput.value = data2.subject || '';
              editor.innerHTML = data2.html || '<div class="muted">(leer)</div>';
              document.getElementById('compose_status').textContent = 'Vorschlag erstellt';
            }
          }
        } catch(_e) { /* still fine */ }
      }catch(e){
        detail.innerHTML = `<div class="sub">Fehler: ${e}</div>`;
      }
    }

    async function proposeDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!currentUid){ status.textContent = 'Bitte zuerst eine E-Mail ausw√§hlen.'; return; }
      status.textContent = 'Vorschlag wird erstellt ‚Ä¶';
      try{
        // Erster Versuch (8s Timeout)
        let res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 8}) });
        let data = await parseJsonSafe(res);
        if(!data.__ok){
          // Bei 504 (compose_timeout/compose_empty) ein zweiter Versuch mit 20s Timeout
          if(data.__status === 504){
            status.textContent = 'Ausgelastet, zweiter Versuch (bis 20s) ‚Ä¶';
            res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 20}) });
            data = await parseJsonSafe(res);
          }
        }
        if(!data.__ok){
          throw new Error(data.error || ('Fehler (' + (data.__status||'') + ')'));
        }
        toInput.value = data.to || '';
        subjInput.value = data.subject || '';
        editor.innerHTML = data.html || '<div class="muted">(leer)</div>';
        status.textContent = 'Vorschlag erstellt';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    async function sendDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!toInput.value){ status.textContent = 'Empf√§nger fehlt.'; return; }
      if(!currentAccountId){ status.textContent = 'Kein E-Mail-Account ausgew√§hlt.'; return; }
      status.textContent = 'Sende ‚Ä¶';
      try{
        const res = await fetch('/api/emails/send', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({to: toInput.value, subject: subjInput.value, html: editor.innerHTML, account_id: currentAccountId}) });
        const data = await parseJsonSafe(res);
        if(!data.__ok && data.error){ throw new Error(data.error); }
        status.textContent = 'Gesendet';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function renderProfilePlaceholder(p){
      const el = document.getElementById('profile_panel'); if(!el) return;
      const set = (id, val) => { const n = document.getElementById(id); if(n) n.textContent = val || '‚Äì'; };
      set('prof_name', p.name);
      set('prof_email', p.email);
      set('prof_phone', p.phone);
      set('prof_city', p.city);
      set('prof_source', p.source);
      set('prof_last', p.last);
      set('prof_channels', p.channels);
      const sum = document.getElementById('prof_summary'); if(sum) sum.textContent = p.summary || '‚Äì';
    }
    document.getElementById('reload').addEventListener('click', loadInbox);
    document.getElementById('load_more_btn').addEventListener('click', loadMoreEmails);
    document.getElementById('btn_propose').addEventListener('click', proposeDraft);
    document.getElementById('btn_send').addEventListener('click', sendDraft);
    // Auth: get JWT token and user email
    function getAuthToken(){
      return localStorage.getItem('jwt_token') || '';
    }
    function getUserEmail(){
      const token = getAuthToken();
      if(!token) return '';
      try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.user_email || '';
      }catch(e){
        return '';
      }
    }
    function getCurrentUser(){
      try{
        const user = localStorage.getItem('current_user');
        return user ? JSON.parse(user) : null;
      }catch(e){
        return null;
      }
    }

    // E-Mail-Accounts laden und Dropdown initialisieren (Inbox + "Senden als")
    async function ensureEmailAccountsLoaded(){
      try{
        const res = await fetch('/api/email-accounts/list', { headers: getAuthHeaders() });
        const data = await parseJsonSafe(res);
        if(!data.__ok){ return; }
        const accounts = data.accounts || [];
        if(!accounts.length){ return; }
        // Standard: ersten Account w√§hlen, falls keiner gesetzt
        if(!currentAccountId){
          currentAccountId = accounts[0].id;
        }
        // Dropdown im Header erg√§nzen (nur wenn noch nicht vorhanden)
        const toolbar = document.querySelector('.toolbar');
        if(toolbar && !document.getElementById('account_select')){
          const select = document.createElement('select');
          select.id = 'account_select';
          select.style.cssText = 'margin-right:8px; padding:4px 8px; border-radius:6px; border:1px solid var(--border); font-size:12px;';
          for(const acc of accounts){
            const opt = document.createElement('option');
            opt.value = acc.id;
            opt.textContent = acc.label || acc.account_email;
            if(acc.id === currentAccountId){ opt.selected = true; }
            select.appendChild(opt);
          }
          select.addEventListener('change', () => {
            currentAccountId = parseInt(select.value, 10);
            loadInbox();
          });
          toolbar.insertBefore(select, document.getElementById('status'));
        }
      }catch(e){
        // Wenn das Laden scheitert, arbeitet die Inbox einfach ohne Dropdown weiter
      }
    }

    // Schlie√üt alle offenen Modalfenster (gegen "schwarzen Screen" mit mehreren Overlays)
    function closeAllModals(){
      document.querySelectorAll('.modal').forEach(m => {
        m.style.display = 'none';
      });
    }
    function updateMenuForUser(){
      const user = getCurrentUser();
      const sidebarUsersItem = document.getElementById('sidebar_users_item');
      if(user && user.role === 'superadmin'){
        if(sidebarUsersItem) sidebarUsersItem.style.display = 'block';
      } else {
        if(sidebarUsersItem) sidebarUsersItem.style.display = 'none';
      }
      // Update user badge
      const badge = document.getElementById('user_badge');
      if(user && badge){
        const name = user.first_name ? user.first_name : user.email.split('@')[0];
        badge.textContent = `üë§ ${name}`;
        badge.style.display = 'inline-block';
      }
    }
    function getAuthHeaders(){
      const token = getAuthToken();
      return token ? {'Authorization': 'Bearer ' + token} : {};
    }
    async function checkAuth(){
      const token = getAuthToken();
      if(!token){
        showLoginModal();
        return false;
      }
      try{
        const res = await fetch('/api/auth/me', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.user){
          localStorage.setItem('current_user', JSON.stringify(data.user));
          updateMenuForUser();
          return true;
        } else {
          localStorage.removeItem('jwt_token');
          localStorage.removeItem('current_user');
          showLoginModal();
          return false;
        }
      }catch(e){
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('current_user');
        showLoginModal();
        return false;
      }
    }
    function showLoginModal(){
      closeAllModals();
      const modal = document.getElementById('login_modal');
      const email = document.getElementById('login_email');
      const pass = document.getElementById('login_pass');
      const msg = document.getElementById('login_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      email.value = '';
      pass.value = '';
      email.focus();
      document.getElementById('login_submit').onclick = async () => {
        const emailVal = email.value.trim();
        const passVal = pass.value;
        if(!emailVal || !passVal){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        msg.textContent = 'Login...';
        try{
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: emailVal, password: passVal})
          });
          const data = await parseJsonSafe(res);
          if(data.ok && data.token){
            localStorage.setItem('jwt_token', data.token);
            localStorage.setItem('current_user', JSON.stringify(data.user));
            updateMenuForUser();
            modal.style.display = 'none';
            msg.textContent = '';
            loadInbox();
          } else {
            msg.textContent = data.error || 'Login fehlgeschlagen';
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      pass.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') document.getElementById('login_submit').click();
      });
      document.getElementById('login_debug').onclick = async () => {
        msg.textContent = 'Lade Debug-Info...';
        try{
          const res = await fetch('/api/auth/debug');
          const data = await res.json();
          let debugText = '=== DB CONFIG ===\n';
          Object.entries(data.config || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== FALLBACK CONFIG ===\n';
          Object.entries(data.fallback || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== CONNECTION TEST ===\n';
          Object.entries(data.connection_test || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          if(data.tables && data.tables.length){
            debugText += '\n=== TABLES ===\n' + data.tables.join(', ');
          }
          msg.textContent = debugText;
        }catch(e){
          msg.textContent = 'Debug-Fehler: ' + e;
        }
      };
    }

    function fillEmailSettingsFormDefaults(userEmail){
      document.getElementById('imap_host').value = '';
      document.getElementById('imap_port').value = 993;
      document.getElementById('imap_user').value = userEmail || '';
      document.getElementById('imap_pass').value = '';
      document.getElementById('imap_security').value = 'ssl';
      document.getElementById('smtp_host').value = '';
      document.getElementById('smtp_port').value = 465;
      document.getElementById('smtp_user').value = userEmail || '';
      document.getElementById('smtp_pass').value = '';
      document.getElementById('smtp_security').value = 'ssl';
    }

    async function loadEmailAccountIntoForm(accountId, msgEl, userEmail){
      if(!accountId){
        fillEmailSettingsFormDefaults(userEmail);
        if(msgEl) msgEl.textContent = 'Neue Konfiguration';
        return;
      }
      try{
        if(msgEl) msgEl.textContent = 'Lade Account...';
        const res = await fetch(`/api/email-accounts/${encodeURIComponent(accountId)}`, {
          headers: getAuthHeaders(),
        });
        const data = await parseJsonSafe(res);
        const acc = data.account;
        if(!data.__ok || !acc){
          fillEmailSettingsFormDefaults(userEmail);
          if(msgEl) msgEl.textContent = data.error || 'Account nicht gefunden';
          return;
        }
        document.getElementById('imap_host').value = acc.imap_host || '';
        document.getElementById('imap_port').value = acc.imap_port || 993;
        document.getElementById('imap_user').value = acc.imap_user || (userEmail || '');
        document.getElementById('imap_pass').value = '';
        document.getElementById('imap_security').value = acc.imap_security || 'ssl';
        document.getElementById('smtp_host').value = acc.smtp_host || '';
        document.getElementById('smtp_port').value = acc.smtp_port || 465;
        document.getElementById('smtp_user').value = acc.smtp_user || (acc.account_email || userEmail || '');
        document.getElementById('smtp_pass').value = '';
        document.getElementById('smtp_security').value = acc.smtp_security || 'ssl';
        if(msgEl) msgEl.textContent = 'Account geladen';
      }catch(e){
        fillEmailSettingsFormDefaults(userEmail);
        if(msgEl) msgEl.textContent = 'Fehler beim Laden des Accounts: ' + e;
      }
    }
    async function openEmailSettingsModal(){
      closeAllModals();
      const modal = document.getElementById('email_settings_modal');
      const msg = document.getElementById('email_settings_msg');
      const userEmail = getUserEmail();
      if(!userEmail){ alert('E‚ÄëMail-Adresse erforderlich'); return; }
      msg.textContent = 'Lade Accounts...';
      modal.style.display = 'flex';
      try{
        // Accounts laden
        const listRes = await fetch('/api/email-accounts/list', { headers: getAuthHeaders() });
        const listData = await parseJsonSafe(listRes);
        const select = document.getElementById('email_account_select');
        emailAccounts = (listData.accounts || []);
        // Dropdown neu bef√ºllen
        select.innerHTML = '<option value="">Neuer Account ‚Ä¶</option>';
        for(const acc of emailAccounts){
          const opt = document.createElement('option');
          opt.value = acc.id;
          opt.textContent = acc.label || acc.account_email;
          select.appendChild(opt);
        }
        // Falls es schon einen global ausgew√§hlten Account gibt, nutzen
        if(currentAccountId && emailAccounts.some(a => a.id === currentAccountId)){
          currentSettingsAccountId = currentAccountId;
        } else if(emailAccounts.length){
          currentSettingsAccountId = emailAccounts[0].id;
        } else {
          currentSettingsAccountId = null;
        }
        if(currentSettingsAccountId){
          select.value = String(currentSettingsAccountId);
          await loadEmailAccountIntoForm(currentSettingsAccountId, msg, userEmail);
        } else {
          // Kein Account vorhanden -> Formular mit Defaults f√ºllen
          fillEmailSettingsFormDefaults(userEmail);
          msg.textContent = 'Neue Konfiguration';
        }
      }catch(e){
        msg.textContent = 'Fehler beim Laden: ' + e;
      }
      
      // Auto-detect security based on SMTP port
      const smtpPortInput = document.getElementById('smtp_port');
      const smtpSecuritySelect = document.getElementById('smtp_security');
      const smtpHintDiv = document.getElementById('smtp_port_hint');
      const smtpHintText = document.getElementById('smtp_port_hint_text');
      
      function updateSmtpSecurityHint() {
        const port = parseInt(smtpPortInput.value);
        if (port === 587) {
          smtpSecuritySelect.value = 'starttls';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 587 nutzt STARTTLS - automatisch ausgew√§hlt';
        } else if (port === 465) {
          smtpSecuritySelect.value = 'ssl';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 465 nutzt SSL - automatisch ausgew√§hlt';
        } else if (port === 25) {
          smtpSecuritySelect.value = 'starttls';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 25 nutzt meist STARTTLS - bitte pr√ºfen';
        } else {
          smtpHintDiv.style.display = 'none';
        }
      }
      
      smtpPortInput.addEventListener('input', updateSmtpSecurityHint);
      smtpPortInput.addEventListener('change', updateSmtpSecurityHint);
      
      // Run once on load if port is already filled
      if (smtpPortInput.value) {
        updateSmtpSecurityHint();
      }
      
      // Auto-detect security based on IMAP port
      const imapPortInput = document.getElementById('imap_port');
      const imapSecuritySelect = document.getElementById('imap_security');
      const imapHintDiv = document.getElementById('imap_port_hint');
      const imapHintText = document.getElementById('imap_port_hint_text');
      
      function updateImapSecurityHint() {
        const port = parseInt(imapPortInput.value);
        if (port === 993) {
          imapSecuritySelect.value = 'ssl';
          imapHintDiv.style.display = 'block';
          imapHintText.textContent = 'Port 993 nutzt SSL - automatisch ausgew√§hlt';
        } else if (port === 143) {
          imapSecuritySelect.value = 'starttls';
          imapHintDiv.style.display = 'block';
          imapHintText.textContent = 'Port 143 nutzt STARTTLS - automatisch ausgew√§hlt';
        } else {
          imapHintDiv.style.display = 'none';
        }
      }
      
      imapPortInput.addEventListener('input', updateImapSecurityHint);
      imapPortInput.addEventListener('change', updateImapSecurityHint);
      
      // Run once on load if port is already filled
      if (imapPortInput.value) {
        updateImapSecurityHint();
      }
      
      const cleanup = () => { modal.style.display='none'; };
      document.getElementById('email_settings_cancel').onclick = cleanup;
      document.getElementById('email_settings_save').onclick = async () => {
        msg.textContent = 'Speichere...';
        const data = {
          user_email: userEmail,
          imap_host: document.getElementById('imap_host').value.trim(),
          imap_port: parseInt(document.getElementById('imap_port').value.trim()) || 993,
          imap_user: document.getElementById('imap_user').value.trim(),
          imap_pass: document.getElementById('imap_pass').value,
          imap_security: document.getElementById('imap_security').value,
          smtp_host: document.getElementById('smtp_host').value.trim(),
          smtp_port: parseInt(document.getElementById('smtp_port').value.trim()) || 465,
          smtp_user: document.getElementById('smtp_user').value.trim(),
          smtp_pass: document.getElementById('smtp_pass').value,
          smtp_security: document.getElementById('smtp_security').value,
        };
        try{
          const res = await fetch('/api/user/email-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          });
          const result = await parseJsonSafe(res);
          if(result.__ok){
            msg.textContent = '‚úÖ Gespeichert! E-Mails werden geladen...';
            setTimeout(() => {
              cleanup();
              loadInbox(); // Automatisch E-Mails laden
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (result.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler beim Speichern: ' + e;
        }
      };
      
      // SMTP Test Button
      document.getElementById('smtp_test_btn').onclick = async () => {
        const resultDiv = document.getElementById('smtp_test_result');
        const btn = document.getElementById('smtp_test_btn');
        resultDiv.textContent = 'Teste Verbindung...';
        btn.disabled = true;
        
        try {
          const res = await fetch('/api/emails/smtp-test', {
            method: 'POST',
            headers: getAuthHeaders()
          });
          const data = await parseJsonSafe(res);
          
          if (data.ok) {
            let resultText = `‚úÖ SMTP-Verbindung erfolgreich!\n\nServer: ${data.host}:${data.port}\nSecurity: ${data.security}\n\n`;
            if (data.tests && data.tests.length > 0) {
              resultText += 'Tests:\n';
              data.tests.forEach(test => {
                const icon = test.success ? '‚úÖ' : '‚úÖ';
                resultText += `${icon} ${test.method}: ${test.message}\n`;
              });
            }
            resultDiv.textContent = resultText;
            resultDiv.style.color = '#059669';
          } else {
            let errorText = `‚ùå SMTP-Test fehlgeschlagen\n\n`;
            if (data.error) errorText += `Fehler: ${data.error}\n\n`;
            if (data.tests && data.tests.length > 0) {
              errorText += 'Details:\n';
              data.tests.forEach(test => {
                const icon = test.success ? '‚úÖ' : '‚ùå';
                errorText += `${icon} ${test.method}: ${test.message}\n`;
              });
            }
            resultDiv.textContent = errorText;
            resultDiv.style.color = '#dc2626';
          }
        } catch (e) {
          resultDiv.textContent = `‚ùå Fehler beim Test: ${e}`;
          resultDiv.style.color = '#dc2626';
        } finally {
          btn.disabled = false;
        }
      };
      
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    function openProfileModal(){
      closeAllModals();
      const modal = document.getElementById('profile_modal');
      const msg = document.getElementById('profile_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = '';
      
      // Fill current data
      document.getElementById('profile_email').value = user.email || '';
      document.getElementById('profile_first').value = user.first_name || '';
      document.getElementById('profile_last').value = user.last_name || '';
      document.getElementById('profile_role').value = user.role || 'user';
      document.getElementById('profile_new_pass').value = '';
      document.getElementById('profile_confirm_pass').value = '';
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('profile_cancel').onclick = cleanup;
      document.getElementById('profile_save').onclick = async () => {
        const first = document.getElementById('profile_first').value.trim();
        const last = document.getElementById('profile_last').value.trim();
        const newPass = document.getElementById('profile_new_pass').value;
        const confirmPass = document.getElementById('profile_confirm_pass').value;
        
        // Validate password if provided
        if(newPass || confirmPass){
          if(newPass !== confirmPass){
            msg.textContent = 'Passw√∂rter stimmen nicht √ºberein';
            return;
          }
          if(newPass.length < 6){
            msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
            return;
          }
        }
        
        msg.textContent = 'Speichere...';
        const updateData = {
          first_name: first,
          last_name: last
        };
        if(newPass){
          updateData.password = newPass;
        }
        
        try{
          const res = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(updateData)
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            // Update localStorage
            user.first_name = first;
            user.last_name = last;
            localStorage.setItem('current_user', JSON.stringify(user));
            updateMenuForUser();
            msg.textContent = '‚úÖ Profil gespeichert!';
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    // Sidebar Menu
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar_overlay');
    const menuBtn = document.getElementById('menu_btn');
    const sidebarClose = document.getElementById('sidebar_close');
    
    function openSidebar(){
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    }
    function closeSidebar(){
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    }
    
    menuBtn.addEventListener('click', openSidebar);
    sidebarClose.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    document.getElementById('sidebar_profile').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openProfileModal();
    });
    document.getElementById('sidebar_agent').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openAgentSetupModal();
    });
    document.getElementById('sidebar_knowledge').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openKnowledgeModal();
    });
    document.getElementById('sidebar_contacts').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openContactsModal();
    });
    document.getElementById('sidebar_email').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openEmailSettingsModal();
    });
    document.getElementById('sidebar_users').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openUserManagementModal();
    });
    document.getElementById('sidebar_logout').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      logout();
    });
    function logout(){
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('current_user');
      location.reload();
    }
    
    function openAgentSetupModal(){
      const modal = document.getElementById('agent_setup_modal');
      const msg = document.getElementById('agent_setup_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = 'Lade Einstellungen...';
      
      // Reset fields
      document.getElementById('agent_role').value = '';
      document.getElementById('agent_instructions').value = '';
      
      // Load agent settings
      fetch('/api/user/agent-settings', {
        headers: getAuthHeaders()
      }).then(res => res.json()).then(data => {
        if(data.role) document.getElementById('agent_role').value = data.role;
        if(data.instructions) document.getElementById('agent_instructions').value = data.instructions;
        msg.textContent = '';
      }).catch((e) => {
        msg.textContent = 'Fehler beim Laden: ' + e;
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('agent_setup_cancel').onclick = cleanup;
      document.getElementById('agent_setup_save').onclick = async () => {
        const role = document.getElementById('agent_role').value;
        const instructions = document.getElementById('agent_instructions').value.trim();
        
        msg.textContent = 'Speichere...';
        
        try{
          const res = await fetch('/api/user/agent-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({
              role: role,
              instructions: instructions
            })
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ Gespeichert!';
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openKnowledgeModal(){
      closeAllModals();
      const modal = document.getElementById('knowledge_modal');
      const msg = document.getElementById('knowledge_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = 'Lade Wissensdatenbank...';
      
      // Reset fields
      document.getElementById('knowledge_faq').value = '';
      document.getElementById('knowledge_links').value = '';
      
      // Load knowledge base
      fetch('/api/user/agent-settings', {
        headers: getAuthHeaders()
      }).then(res => res.json()).then(data => {
        if(data.faq_text) document.getElementById('knowledge_faq').value = data.faq_text;
        if(data.document_links) document.getElementById('knowledge_links').value = data.document_links;
        msg.textContent = '';
      }).catch((e) => {
        msg.textContent = 'Fehler beim Laden: ' + e;
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('knowledge_cancel').onclick = cleanup;
      document.getElementById('knowledge_save').onclick = async () => {
        const faqText = document.getElementById('knowledge_faq').value.trim();
        const docLinks = document.getElementById('knowledge_links').value.trim();
        
        msg.textContent = 'Speichere...';
        
        try{
          const res = await fetch('/api/user/agent-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({
              faq_text: faqText,
              document_links: docLinks
            })
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ Gespeichert!';
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openContactsModal(){
      closeAllModals();
      const modal = document.getElementById('contacts_modal');
      const list = document.getElementById('contacts_list');
      const searchInput = document.getElementById('contacts_search');
      
      modal.style.display = 'flex';
      
      async function loadContacts(search = ''){
        list.innerHTML = '<div class="sub" style="text-align:center; padding:20px;">Lade Kontakte...</div>';
        
        try{
          const url = search ? `/api/contacts/list?search=${encodeURIComponent(search)}` : '/api/contacts/list';
          const res = await fetch(url, { headers: getAuthHeaders() });
          const data = await parseJsonSafe(res);
          
          if(!data.__ok || !data.contacts){
            throw new Error(data.error || 'Fehler beim Laden');
          }
          
          if(data.contacts.length === 0){
            list.innerHTML = '<div class="sub" style="text-align:center; padding:40px;">Keine Kontakte gefunden.</div>';
            return;
          }
          
          list.innerHTML = '';
          for(const contact of data.contacts){
            const div = document.createElement('div');
            div.style.cssText = 'padding:14px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;';
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:600; margin-bottom:4px;">üìß ${escapeHtml(contact.name)}</div>
                  <div class="sub">${escapeHtml(contact.email)}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-weight:600; color:#0284c7;">${contact.email_count} E-Mail${contact.email_count !== 1 ? 's' : ''}</div>
                  <div class="sub">Letzter Kontakt: ${contact.last_contact}</div>
                </div>
              </div>
            `;
            div.addEventListener('mouseenter', () => { div.style.background = '#f3f4f6'; });
            div.addEventListener('mouseleave', () => { div.style.background = 'transparent'; });
            div.addEventListener('click', () => {
              openContactDetailModal(contact.id, contact.name, contact.email);
            });
            list.appendChild(div);
          }
          
        }catch(e){
          list.innerHTML = `<div class="sub" style="text-align:center; padding:40px; color:#dc2626;">Fehler: ${e}</div>`;
        }
      }
      
      loadContacts();
      
      // Search functionality
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          loadContacts(searchInput.value.trim());
        }, 300);
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('contacts_close').onclick = cleanup;
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openContactDetailModal(contactId, contactName, contactEmail){
      closeAllModals();
      const modal = document.getElementById('contact_detail_modal');
      const nameEl = document.getElementById('contact_detail_name');
      const emailEl = document.getElementById('contact_detail_email');
      const countEl = document.getElementById('contact_detail_count');
      const emailsEl = document.getElementById('contact_detail_emails');
      
      modal.style.display = 'flex';
      nameEl.textContent = contactName;
      emailEl.textContent = contactEmail;
      emailsEl.innerHTML = '<div class="sub" style="text-align:center; padding:20px;">Lade E-Mails...</div>';
      
      // Load emails from this contact
      fetch(`/api/contacts/${contactId}/emails`, { headers: getAuthHeaders() })
        .then(res => res.json())
        .then(data => {
          if(!data || !data.emails){
            throw new Error('Keine E-Mails gefunden');
          }
          
          countEl.textContent = data.contact.email_count;
          
          if(data.emails.length === 0){
            emailsEl.innerHTML = '<div class="sub" style="text-align:center; padding:40px;">Keine E-Mails gefunden.</div>';
            return;
          }
          
          emailsEl.innerHTML = '';
          for(const email of data.emails){
            const div = document.createElement('div');
            div.style.cssText = 'padding:12px; border:1px solid var(--border); border-radius:6px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;';
            div.innerHTML = `
              <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(email.subject)}</div>
              <div class="sub" style="margin-bottom:6px;">${escapeHtml(email.preview)}...</div>
              <div class="sub">${email.date}${email.has_attachments ? ' ¬∑ üìé Anhang' : ''}</div>
            `;
            div.addEventListener('mouseenter', () => { div.style.background = '#f3f4f6'; });
            div.addEventListener('mouseleave', () => { div.style.background = 'transparent'; });
            div.addEventListener('click', () => {
              // Close contact detail modal and open email in main view
              modal.style.display = 'none';
              document.getElementById('contacts_modal').style.display = 'none';
              // Select the email in list (if exists)
              const emailItem = document.querySelector(`[data-uid="${email.id}"]`);
              if(emailItem){
                emailItem.click();
              }
            });
            emailsEl.appendChild(div);
          }
          
        })
        .catch(e => {
          emailsEl.innerHTML = `<div class="sub" style="text-align:center; padding:40px; color:#dc2626;">Fehler: ${e}</div>`;
        });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('contact_detail_close').onclick = cleanup;
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openUserManagementModal(){
      closeAllModals();
      const modal = document.getElementById('user_management_modal');
      const list = document.getElementById('user_list');
      const msg = document.getElementById('user_management_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      loadUserList();
      document.getElementById('user_management_close').onclick = () => {
        modal.style.display = 'none';
      };
      document.getElementById('btn_new_user').onclick = () => {
        openNewUserModal();
      };
      modal.onclick = (ev) => { if(ev.target === modal) modal.style.display = 'none'; };
    }
    async function loadUserList(){
      const list = document.getElementById('user_list');
      list.innerHTML = '<div class="sub">Lade User...</div>';
      try{
        const res = await fetch('/api/admin/users', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.users){
          if(data.users.length === 0){
            list.innerHTML = '<div class="sub">Keine User vorhanden</div>';
            return;
          }
          let html = '<div style="display:grid; gap:8px;">';
          data.users.forEach(u => {
            const activeLabel = u.active ? '‚úÖ' : '‚ùå';
            const roleLabel = u.role === 'superadmin' ? 'üîë' : u.role === 'admin' ? '‚öôÔ∏è' : 'üë§';
            html += `<div style="background:#fff; border:1px solid var(--border); border-radius:6px; padding:10px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<div><div style="font-weight:600;">${roleLabel} ${escapeHtml(u.email)}</div>`;
            html += `<div class="sub">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')} ¬∑ ${u.role} ¬∑ ${activeLabel}</div></div>`;
            html += `<button onclick="deleteUser(${u.id}, '${escapeHtml(u.email)}')" style="background:#dc2626; padding:6px 10px; font-size:12px;">üóëÔ∏è L√∂schen</button>`;
            html += `</div>`;
          });
          html += '</div>';
          list.innerHTML = html;
        } else {
          list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler beim Laden: ' + (data.error || 'Unbekannt') + '</div>';
        }
      }catch(e){
        list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler: ' + e + '</div>';
      }
    }
    function openNewUserModal(){
      closeAllModals();
      const modal = document.getElementById('new_user_modal');
      const msg = document.getElementById('new_user_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      document.getElementById('new_user_email').value = '';
      document.getElementById('new_user_first').value = '';
      document.getElementById('new_user_last').value = '';
      document.getElementById('new_user_pass').value = '';
      document.getElementById('new_user_role').value = 'user';
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('new_user_cancel').onclick = cleanup;
      document.getElementById('new_user_save').onclick = async () => {
        const email = document.getElementById('new_user_email').value.trim();
        const first = document.getElementById('new_user_first').value.trim();
        const last = document.getElementById('new_user_last').value.trim();
        const pass = document.getElementById('new_user_pass').value;
        const role = document.getElementById('new_user_role').value;
        if(!email || !pass){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        if(pass.length < 6){
          msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
          return;
        }
        msg.textContent = 'Erstelle User...';
        try{
          const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({email, first_name: first, last_name: last, password: pass, role})
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ User erstellt!';
            setTimeout(() => {
              cleanup();
              loadUserList();
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    window.deleteUser = async function(userId, email){
      if(!confirm(`User "${email}" wirklich l√∂schen?`)) return;
      const msg = document.getElementById('user_management_msg');
      msg.textContent = 'L√∂sche User...';
      try{
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok){
          msg.textContent = '‚úÖ User gel√∂scht';
          loadUserList();
        } else {
          msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
        }
      }catch(e){
        msg.textContent = 'Fehler: ' + e;
      }
    };
    // Check auth on app start
    checkAuth().then(ok => {
      if(ok) loadInbox();
    });
  </script>
</body>
</html>
