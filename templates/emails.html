<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox ‚Äì neckattack</title>
  <style>
    :root { --border:#e5e7eb; --sub:#6b7280; --fg:#111827; --primary:#111827; --active:#f5f6f7; --hover:#f0f2f4; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; color: var(--fg); background:#fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:#ffffff; position:sticky; top:0; z-index:10; }
    h1 { margin: 0; font-size:20px; display:flex; gap:8px; align-items:center; }
    .toolbar { display:flex; align-items:center; gap:10px; }
    button { background:var(--primary); color:#fff; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }
    .container { display:grid; grid-template-columns: 340px 1fr 460px; height: calc(100vh - 58px); }
    .list { border-right:1px solid var(--border); overflow:auto; background:#fff; }
    .item { padding:10px 14px; border-bottom:1px solid var(--border); cursor:pointer; }
    .item:hover { background: var(--hover); }
    .item.active { background: var(--active); border-left:3px solid var(--primary); padding-left:11px; }
    .item .subject { font-size:14px; }
    .item.unseen .subject { font-weight:700; }
    .item .meta { color: var(--sub); font-size:12px; margin-top:3px; display:flex; justify-content:space-between; gap:8px; }
    .detail { overflow:auto; padding:16px 24px; background:#f9fafb; }
    .detail h2 { margin:0 0 8px; font-size:18px; }
    .detail .meta { color: var(--sub); font-size:12px; margin-bottom:14px; }
    .detail .content { background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px; }
    .profile { margin-top:16px; background:#fff; border:1px solid var(--border); border-radius:8px; padding:12px; }
    .profile h3 { margin:0 0 10px; font-size:16px; }
    .profile .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .profile .kv { font-size:13px; }
    .profile .kv span { color: var(--sub); display:inline-block; min-width:90px; }
    .compose { border-left:1px solid var(--border); padding:16px 16px; overflow:auto; background:#fff; }
    .compose h3 { margin:0 0 10px; font-size:16px; }
    .compose .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .compose label { width:60px; color:var(--sub); font-size:12px; }
    .compose input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px; }
    .compose .editor { min-height:220px; border:1px solid var(--border); border-radius:8px; padding:12px; background:#fff; }
    .compose .actions { margin-top:10px; display:flex; gap:8px; }
    .muted { color:var(--sub); }
    .sub { color:var(--sub); font-size:12px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:100; }
    .modal .box { background:#fff; border-radius:10px; padding:16px; width:320px; border:1px solid var(--border); }
    .modal .row { display:flex; gap:8px; margin:10px 0; align-items:center; }
    .modal label { width:90px; color:var(--sub); font-size:12px; }
    .modal input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <header>
    <h1>üì• Inbox</h1>
    <div class="toolbar">
      <button id="reload">Aktualisieren</button>
      <button id="user_badge" style="background:#111827; display:none;">üë§ Lade...</button>
      <div style="position:relative;">
        <button id="settings_btn" style="background:#111827;">‚öôÔ∏è</button>
        <div id="settings_menu" style="display:none; position:absolute; right:0; top:40px; background:#fff; border:1px solid var(--border); border-radius:8px; min-width:180px; box-shadow:0 6px 20px rgba(0,0,0,.08); z-index:50;">
          <div id="menu_profile" class="item" style="border:0; padding:10px 12px;">üë§ Profil</div>
          <div id="menu_email" class="item" style="padding:10px 12px;">‚öôÔ∏è E‚ÄëMail-Einstellungen</div>
          <div id="menu_users" class="item" style="padding:10px 12px; display:none;">üë• User-Verwaltung</div>
          <div style="border-top:1px solid var(--border); margin:4px 0;"></div>
          <div id="menu_logout" class="item" style="padding:10px 12px; color:#dc2626;">üö™ Logout</div>
        </div>
      </div>
      <span id="status" class="sub"></span>
    </div>
  </header>
  <div class="container">
    <div class="list" id="list">
      <div class="sub" style="padding:12px 14px;">Lade ‚Ä¶</div>
    </div>
    <div class="detail" id="detail">
      <div class="sub">E-Mail ausw√§hlen ‚Ä¶</div>
    </div>
    <div class="compose" id="compose">
      <h3>Antwort</h3>
      <div class="row"><label>Empf.</label><input id="compose_to" placeholder="Empf√§nger" /></div>
      <div class="row"><label>Betreff</label><input id="compose_subject" placeholder="Betreff" /></div>
      <div id="compose_editor" class="editor" contenteditable="true"><div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div></div>
      <div class="actions">
        <button id="btn_propose" disabled>Antwort vorschlagen</button>
        <button id="btn_send" disabled>Senden</button>
        <span id="compose_status" class="sub"></span>
      </div>
    </div>
  </div>

  <!-- Login Modal (required at app start) -->
  <div id="login_modal" class="modal" style="display:none;">
    <div class="box">
      <h3 style="margin:0 0 10px;">Login</h3>
      <div class="row"><label>E‚ÄëMail</label><input id="login_email" placeholder="you@domain.com"></div>
      <div class="row"><label>Passwort</label><input id="login_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="login_debug" style="background:#6b7280;">Debug</button>
        <button id="login_submit">Login</button>
      </div>
      <div id="login_msg" class="sub" style="margin-top:8px; white-space:pre-wrap; text-align:left;"></div>
    </div>
  </div>

  <!-- E-Mail Settings Modal -->
  <div id="email_settings_modal" class="modal">
    <div class="box" style="width:480px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">E‚ÄëMail Einstellungen</h3>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">IMAP (Empfang)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="imap_host" placeholder="imap.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="imap_port" type="number" placeholder="993"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="imap_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="imap_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="imap_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">SMTP (Versand)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="smtp_host" placeholder="smtp.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="smtp_port" type="number" placeholder="465"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="smtp_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="smtp_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="smtp_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
            <option value="auto">Auto</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="email_settings_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="email_settings_save">Speichern</button>
      </div>
      <div id="email_settings_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="user_management_modal" class="modal">
    <div class="box" style="width:640px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">üë• User-Verwaltung</h3>
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <button id="btn_new_user" style="background:#059669;">‚ûï Neuer User</button>
      </div>
      <div id="user_list" style="background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:12px; min-height:200px;">
        <div class="sub">Lade User...</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="user_management_close" style="background:#6b7280;">Schlie√üen</button>
      </div>
      <div id="user_management_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">üë§ Mein Profil</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="profile_email" disabled style="background:#f3f4f6;"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="profile_first" placeholder="Vorname"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="profile_last" placeholder="Nachname"></div>
      <div class="row"><label style="width:100px;">Rolle</label><input id="profile_role" disabled style="background:#f3f4f6;"></div>
      <div style="border-top:1px solid var(--border); margin:16px 0; padding-top:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">üîí Passwort √§ndern (optional)</h4>
        <div class="row"><label style="width:100px;">Neu</label><input id="profile_new_pass" type="password" placeholder="min. 6 Zeichen"></div>
        <div class="row"><label style="width:100px;">Wiederholen</label><input id="profile_confirm_pass" type="password" placeholder="best√§tigen"></div>
      </div>
      <div style="border-top:1px solid var(--border); margin:16px 0; padding-top:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">ü§ñ Agent-Einstellungen</h4>
        <div class="row">
          <label style="width:100px;">Agent-Rolle</label>
          <select id="profile_agent_role" style="flex:1;">
            <option value="">-- Bitte w√§hlen --</option>
            <option value="Vertrieb">Vertrieb</option>
            <option value="Support">Support</option>
            <option value="Manager">Manager</option>
            <option value="Controller">Controller</option>
            <option value="HR">HR / Personalwesen</option>
            <option value="Sonstige">Sonstige</option>
          </select>
        </div>
        <div class="row" style="align-items:flex-start;">
          <label style="width:100px; padding-top:8px;">Anweisungen</label>
          <div style="flex:1;">
            <textarea id="profile_instructions" placeholder="z.B. 'Antworte immer kurz und h√∂flich...'" rows="4" maxlength="500" style="width:100%; resize:vertical; font-family:inherit; font-size:13px; padding:8px; border:1px solid var(--border); border-radius:4px;"></textarea>
            <small class="sub">Max. 500 Zeichen</small>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="profile_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="profile_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="profile_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- New User Modal -->
  <div id="new_user_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">‚ûï Neuer User</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="new_user_email" placeholder="user@example.com"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="new_user_first" placeholder="Max"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="new_user_last" placeholder="Mustermann"></div>
      <div class="row"><label style="width:100px;">Passwort</label><input id="new_user_pass" type="password" placeholder="min. 6 Zeichen"></div>
      <div class="row"><label style="width:100px;">Rolle</label>
        <select id="new_user_role" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superadmin">Superadmin</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="new_user_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="new_user_save" style="background:#059669;">Erstellen</button>
      </div>
      <div id="new_user_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    let currentUid = null;
    async function parseJsonSafe(res){
      const ct = res.headers.get('content-type') || '';
      const txt = await res.text();
      if(ct.includes('application/json')){
        try { return { __ok: res.ok, __status: res.status, ...(txt ? JSON.parse(txt) : {}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: 'Ung√ºltiges JSON vom Server', raw: txt }; }
      }
      // Fallback: leere OK-Antwort als Erfolg behandeln (manche Proxies strippen kleine JSON-Bodies)
      if(res.ok && (!txt || txt.trim() === '')){
        return { __ok: true, __status: res.status };
      }
      // Versuche JSON, sonst Fehlertext kapseln
      try { return { __ok: res.ok, __status: res.status, ...(JSON.parse(txt)||{}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: txt || 'Leere Antwort vom Server' }; }
    }
    async function loadInbox(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      status.textContent = 'l√§dt ‚Ä¶';
      try{
        const res = await fetch('/api/emails/inbox?limit=20', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(!data.__ok){ 
          // Check if user needs to configure email settings
          if(data.error && data.error.includes('configure email settings')){
            list.innerHTML = `
              <div style="padding:20px; text-align:center;">
                <div style="font-size:48px; margin-bottom:16px;">üìß</div>
                <div style="font-size:16px; font-weight:600; margin-bottom:8px;">E-Mail-Einstellungen fehlen</div>
                <div class="sub" style="margin-bottom:16px;">Bitte konfigurieren Sie zuerst Ihre IMAP/SMTP-Zugangsdaten</div>
                <button id="setup_email_btn" style="background:#059669; color:#fff; border:0; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px;">‚öôÔ∏è E-Mail-Einstellungen konfigurieren</button>
              </div>
            `;
            document.getElementById('setup_email_btn').addEventListener('click', openEmailSettingsModal);
            status.textContent = '';
            return;
          }
          throw new Error(data.error || 'Inbox-Fehler'); 
        }
        list.innerHTML = '';
        if(!data.items || !data.items.length){
          list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Keine E-Mails gefunden.</div>';
          status.textContent = '';
          return;
        }
        for(const it of data.items){
          const div = document.createElement('div');
          div.className = 'item' + (!it.seen ? ' unseen' : '');
          div.dataset.uid = it.uid;
          div.innerHTML = `
            <div class="subject">${escapeHtml(it.subject || '(ohne Betreff)')}</div>
            <div class="meta"><span>${escapeHtml(it.from || '')}</span><span>${escapeHtml(it.date || '')}</span></div>
          `;
          div.addEventListener('click', () => selectItem(it.uid, div));
          list.appendChild(div);
        }
        status.textContent = `${data.items.length} E-Mails geladen`;
      }catch(e){
        list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${e}</div>`;
        status.textContent = '';
      }
    }

    async function selectItem(uid, rowEl){
      // Active markieren
      document.querySelectorAll('.item.active').forEach(el => el.classList.remove('active'));
      rowEl.classList.add('active');
      currentUid = uid;
      // Draft-Controls aktivieren
      document.getElementById('btn_propose').disabled = false;
      document.getElementById('btn_send').disabled = false;
      // Compose-Bereich f√ºr neue Auswahl zur√ºcksetzen, damit alte Vorschl√§ge nicht irritieren
      try {
        const toInput = document.getElementById('compose_to');
        const subjInput = document.getElementById('compose_subject');
        const editor = document.getElementById('compose_editor');
        const status = document.getElementById('compose_status');
        if (toInput) toInput.value = '';
        if (subjInput) subjInput.value = '';
        if (editor) editor.innerHTML = '<div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div>';
        if (status) status.textContent = '';
      } catch(_) {}
      // Thread laden
      const detail = document.getElementById('detail');
      detail.innerHTML = '<div class="sub">Lade Inhalt ‚Ä¶</div>';
      try{
        const res = await fetch(`/api/emails/thread?uid=${encodeURIComponent(uid)}`, {
          headers: getAuthHeaders()
        });
        const t = await parseJsonSafe(res);
        if(!t.__ok){ throw new Error(t.error || 'Thread-Fehler'); }
        const html = t.html || (t.text ? `<pre>${escapeHtml(t.text)}</pre>` : '<div class="sub">Kein Inhalt</div>');
        detail.innerHTML = `
          <h2>${escapeHtml(t.subject || '')}</h2>
          <div class="meta">Von: ${escapeHtml(t.from||'')} ¬∑ An: ${escapeHtml(t.to||'')} ¬∑ ${escapeHtml(t.date||'')}</div>
          <div class="content">${html}</div>
          <div class="profile" id="profile_panel">
            <h3>PROFIL</h3>
            <div class="grid">
              <div>
                <div class="kv"><span>Name</span><b id="prof_name">‚Äì</b></div>
                <div class="kv"><span>E‚ÄëMail</span><b id="prof_email">‚Äì</b></div>
                <div class="kv"><span>Telefon</span><b id="prof_phone">‚Äì</b></div>
                <div class="kv"><span>Ort</span><b id="prof_city">‚Äì</b></div>
              </div>
              <div>
                <div class="kv"><span>Quelle</span><b id="prof_source">‚Äì</b></div>
                <div class="kv"><span>Letzter Kontakt</span><b id="prof_last">‚Äì</b></div>
                <div class="kv"><span>Kan√§le</span><b id="prof_channels">E‚ÄëMail</b></div>
              </div>
            </div>
            <div style="margin-top:10px; font-size:13px;">
              <div class="sub" style="margin-bottom:6px;">Zusammenfassung</div>
              <div id="prof_summary">Noch keine Profildaten. Dieses Feld wird sp√§ter automatisch aus der Kommunikation erstellt.</div>
            </div>
          </div>
        `;
        // Als gelesen markieren (opt-in: beim √ñffnen)
        try{ await fetch('/api/emails/seen', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, seen:true})}); }catch(_){ }
        rowEl.classList.remove('unseen');
        // Prefetch: Draft im Hintergrund erzeugen
        try {
          const toInput = document.getElementById('compose_to');
          const subjInput = document.getElementById('compose_subject');
          const editor = document.getElementById('compose_editor');
          const res2 = await fetch('/api/emails/agent-compose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, timeout_s: 8}) });
          const data2 = await parseJsonSafe(res2);
          if(data2 && data2.__ok && currentUid === uid){
            // Nur bef√ºllen, wenn Editor noch leer/Marker enth√§lt
            const htmlNow = (editor.innerHTML||'').trim();
            const isEmpty = !htmlNow || htmlNow.includes('Hier erscheint der Vorschlag');
            if(isEmpty){
              toInput.value = data2.to || '';
              subjInput.value = data2.subject || '';
              editor.innerHTML = data2.html || '<div class="muted">(leer)</div>';
              document.getElementById('compose_status').textContent = 'Vorschlag erstellt';
            }
          }
        } catch(_e) { /* still fine */ }
        // Profil-Panel mit Platzhalterdaten bef√ºllen
        try {
          const from = t.from || '';
          const emailMatch = from.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
          const email = emailMatch ? emailMatch[0] : '';
          const nameMatch = from.replace(email, '').replace(/[<>]/g,'').trim();
          const name = nameMatch || (email ? email.split('@')[0] : '');
          renderProfilePlaceholder({
            name: name || '‚Äì',
            email: email || '‚Äì',
            phone: '‚Äì',
            city: '‚Äì',
            source: '‚Äî',
            last: t.date || '‚Äì',
            channels: 'E‚ÄëMail',
            summary: 'Noch keine Zusammenfassung vorhanden.'
          });
        } catch(_) {}
      }catch(e){
        detail.innerHTML = `<div class="sub">Fehler: ${e}</div>`;
      }
    }

    async function proposeDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!currentUid){ status.textContent = 'Bitte zuerst eine E-Mail ausw√§hlen.'; return; }
      status.textContent = 'Vorschlag wird erstellt ‚Ä¶';
      try{
        // Erster Versuch (8s Timeout)
        let res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 8}) });
        let data = await parseJsonSafe(res);
        if(!data.__ok){
          // Bei 504 (compose_timeout/compose_empty) ein zweiter Versuch mit 20s Timeout
          if(data.__status === 504){
            status.textContent = 'Ausgelastet, zweiter Versuch (bis 20s) ‚Ä¶';
            res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 20}) });
            data = await parseJsonSafe(res);
          }
        }
        if(!data.__ok){
          throw new Error(data.error || ('Fehler (' + (data.__status||'') + ')'));
        }
        toInput.value = data.to || '';
        subjInput.value = data.subject || '';
        editor.innerHTML = data.html || '<div class="muted">(leer)</div>';
        status.textContent = 'Vorschlag erstellt';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    async function sendDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!toInput.value){ status.textContent = 'Empf√§nger fehlt.'; return; }
      status.textContent = 'Sende ‚Ä¶';
      try{
        const res = await fetch('/api/emails/send', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({to: toInput.value, subject: subjInput.value, html: editor.innerHTML}) });
        const data = await parseJsonSafe(res);
        if(!data.__ok && data.error){ throw new Error(data.error); }
        status.textContent = 'Gesendet';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function renderProfilePlaceholder(p){
      const el = document.getElementById('profile_panel'); if(!el) return;
      const set = (id, val) => { const n = document.getElementById(id); if(n) n.textContent = val || '‚Äì'; };
      set('prof_name', p.name);
      set('prof_email', p.email);
      set('prof_phone', p.phone);
      set('prof_city', p.city);
      set('prof_source', p.source);
      set('prof_last', p.last);
      set('prof_channels', p.channels);
      const sum = document.getElementById('prof_summary'); if(sum) sum.textContent = p.summary || '‚Äì';
    }
    document.getElementById('reload').addEventListener('click', loadInbox);
    document.getElementById('btn_propose').addEventListener('click', proposeDraft);
    document.getElementById('btn_send').addEventListener('click', sendDraft);
    // Settings dropdown behavior
    const settingsBtn = document.getElementById('settings_btn');
    const settingsMenu = document.getElementById('settings_menu');
    settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const v = settingsMenu.style.display === 'block';
      settingsMenu.style.display = v ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if(settingsMenu.style.display === 'block') settingsMenu.style.display = 'none';
    });
    // Auth: get JWT token and user email
    function getAuthToken(){
      return localStorage.getItem('jwt_token') || '';
    }
    function getUserEmail(){
      const token = getAuthToken();
      if(!token) return '';
      try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.user_email || '';
      }catch(e){
        return '';
      }
    }
    function getCurrentUser(){
      try{
        const user = localStorage.getItem('current_user');
        return user ? JSON.parse(user) : null;
      }catch(e){
        return null;
      }
    }
    function updateMenuForUser(){
      const user = getCurrentUser();
      const menuUsers = document.getElementById('menu_users');
      if(user && user.role === 'superadmin'){
        menuUsers.style.display = 'block';
      } else {
        menuUsers.style.display = 'none';
      }
      // Update user badge
      const badge = document.getElementById('user_badge');
      if(user && badge){
        const name = user.first_name ? user.first_name : user.email.split('@')[0];
        badge.textContent = `üë§ ${name}`;
        badge.style.display = 'inline-block';
      }
    }
    function getAuthHeaders(){
      const token = getAuthToken();
      return token ? {'Authorization': 'Bearer ' + token} : {};
    }
    async function checkAuth(){
      const token = getAuthToken();
      if(!token){
        showLoginModal();
        return false;
      }
      try{
        const res = await fetch('/api/auth/me', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.user){
          localStorage.setItem('current_user', JSON.stringify(data.user));
          updateMenuForUser();
          return true;
        } else {
          localStorage.removeItem('jwt_token');
          localStorage.removeItem('current_user');
          showLoginModal();
          return false;
        }
      }catch(e){
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('current_user');
        showLoginModal();
        return false;
      }
    }
    function showLoginModal(){
      const modal = document.getElementById('login_modal');
      const email = document.getElementById('login_email');
      const pass = document.getElementById('login_pass');
      const msg = document.getElementById('login_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      email.value = '';
      pass.value = '';
      email.focus();
      document.getElementById('login_submit').onclick = async () => {
        const emailVal = email.value.trim();
        const passVal = pass.value;
        if(!emailVal || !passVal){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        msg.textContent = 'Login...';
        try{
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: emailVal, password: passVal})
          });
          const data = await parseJsonSafe(res);
          if(data.ok && data.token){
            localStorage.setItem('jwt_token', data.token);
            localStorage.setItem('current_user', JSON.stringify(data.user));
            updateMenuForUser();
            modal.style.display = 'none';
            msg.textContent = '';
            loadInbox();
          } else {
            msg.textContent = data.error || 'Login fehlgeschlagen';
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      pass.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') document.getElementById('login_submit').click();
      });
      document.getElementById('login_debug').onclick = async () => {
        msg.textContent = 'Lade Debug-Info...';
        try{
          const res = await fetch('/api/auth/debug');
          const data = await res.json();
          let debugText = '=== DB CONFIG ===\n';
          Object.entries(data.config || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== FALLBACK CONFIG ===\n';
          Object.entries(data.fallback || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== CONNECTION TEST ===\n';
          Object.entries(data.connection_test || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          if(data.tables && data.tables.length){
            debugText += '\n=== TABLES ===\n' + data.tables.join(', ');
          }
          msg.textContent = debugText;
        }catch(e){
          msg.textContent = 'Debug-Fehler: ' + e;
        }
      };
    }
    async function openEmailSettingsModal(){
      const modal = document.getElementById('email_settings_modal');
      const msg = document.getElementById('email_settings_msg');
      const userEmail = getUserEmail();
      if(!userEmail){ alert('E‚ÄëMail-Adresse erforderlich'); return; }
      msg.textContent = 'Lade Einstellungen...';
      modal.style.display = 'flex';
      try{
        const res = await fetch(`/api/user/email-settings?user_email=${encodeURIComponent(userEmail)}`, {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.exists){
          document.getElementById('imap_host').value = data.imap_host || '';
          document.getElementById('imap_port').value = data.imap_port || 993;
          document.getElementById('imap_user').value = data.imap_user || '';
          document.getElementById('imap_pass').value = ''; // don't prefill password
          document.getElementById('imap_security').value = data.imap_security || 'ssl';
          document.getElementById('smtp_host').value = data.smtp_host || '';
          document.getElementById('smtp_port').value = data.smtp_port || 465;
          document.getElementById('smtp_user').value = data.smtp_user || '';
          document.getElementById('smtp_pass').value = ''; // don't prefill password
          document.getElementById('smtp_security').value = data.smtp_security || 'ssl';
          msg.textContent = 'Geladen';
        } else {
          // New user, prefill defaults
          document.getElementById('imap_host').value = '';
          document.getElementById('imap_port').value = 993;
          document.getElementById('imap_user').value = userEmail;
          document.getElementById('imap_pass').value = '';
          document.getElementById('imap_security').value = 'ssl';
          document.getElementById('smtp_host').value = '';
          document.getElementById('smtp_port').value = 465;
          document.getElementById('smtp_user').value = userEmail;
          document.getElementById('smtp_pass').value = '';
          document.getElementById('smtp_security').value = 'ssl';
          msg.textContent = 'Neue Konfiguration';
        }
      }catch(e){
        msg.textContent = 'Fehler beim Laden: ' + e;
      }
      const cleanup = () => { modal.style.display='none'; };
      document.getElementById('email_settings_cancel').onclick = cleanup;
      document.getElementById('email_settings_save').onclick = async () => {
        msg.textContent = 'Speichere...';
        const data = {
          user_email: userEmail,
          imap_host: document.getElementById('imap_host').value.trim(),
          imap_port: parseInt(document.getElementById('imap_port').value.trim()) || 993,
          imap_user: document.getElementById('imap_user').value.trim(),
          imap_pass: document.getElementById('imap_pass').value,
          imap_security: document.getElementById('imap_security').value,
          smtp_host: document.getElementById('smtp_host').value.trim(),
          smtp_port: parseInt(document.getElementById('smtp_port').value.trim()) || 465,
          smtp_user: document.getElementById('smtp_user').value.trim(),
          smtp_pass: document.getElementById('smtp_pass').value,
          smtp_security: document.getElementById('smtp_security').value,
        };
        try{
          const res = await fetch('/api/user/email-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          });
          const result = await parseJsonSafe(res);
          if(result.__ok){
            msg.textContent = '‚úÖ Gespeichert! E-Mails werden geladen...';
            setTimeout(() => {
              cleanup();
              loadInbox(); // Automatisch E-Mails laden
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (result.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler beim Speichern: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    function openProfileModal(){
      const modal = document.getElementById('profile_modal');
      const msg = document.getElementById('profile_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = '';
      
      // Fill current data
      document.getElementById('profile_email').value = user.email || '';
      document.getElementById('profile_first').value = user.first_name || '';
      document.getElementById('profile_last').value = user.last_name || '';
      document.getElementById('profile_role').value = user.role || 'user';
      document.getElementById('profile_new_pass').value = '';
      document.getElementById('profile_confirm_pass').value = '';
      document.getElementById('profile_agent_role').value = '';
      document.getElementById('profile_instructions').value = '';
      
      // Load agent settings
      fetch('/api/user/agent-settings', {
        headers: getAuthHeaders()
      }).then(res => res.json()).then(data => {
        if(data.role) document.getElementById('profile_agent_role').value = data.role;
        if(data.instructions) document.getElementById('profile_instructions').value = data.instructions;
      }).catch(() => {});
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('profile_cancel').onclick = cleanup;
      document.getElementById('profile_save').onclick = async () => {
        const first = document.getElementById('profile_first').value.trim();
        const last = document.getElementById('profile_last').value.trim();
        const newPass = document.getElementById('profile_new_pass').value;
        const confirmPass = document.getElementById('profile_confirm_pass').value;
        
        // Validate password if provided
        if(newPass || confirmPass){
          if(newPass !== confirmPass){
            msg.textContent = 'Passw√∂rter stimmen nicht √ºberein';
            return;
          }
          if(newPass.length < 6){
            msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
            return;
          }
        }
        
        msg.textContent = 'Speichere...';
        const updateData = {
          first_name: first,
          last_name: last
        };
        if(newPass){
          updateData.password = newPass;
        }
        
        try{
          // Save profile
          const res = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(updateData)
          });
          const data = await parseJsonSafe(res);
          if(!data.__ok){
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
            return;
          }
          
          // Save agent settings
          const agentRole = document.getElementById('profile_agent_role').value;
          const agentInstructions = document.getElementById('profile_instructions').value.trim();
          const agentRes = await fetch('/api/user/agent-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({
              role: agentRole,
              instructions: agentInstructions
            })
          });
          const agentData = await parseJsonSafe(agentRes);
          if(!agentData.__ok){
            msg.textContent = 'Profil OK, aber Agent-Einstellungen Fehler: ' + (agentData.error || 'Unbekannt');
            return;
          }
          
          // Update localStorage
          user.first_name = first;
          user.last_name = last;
          localStorage.setItem('current_user', JSON.stringify(user));
          updateMenuForUser();
          msg.textContent = '‚úÖ Profil gespeichert!';
          setTimeout(cleanup, 1500);
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    document.getElementById('menu_profile').addEventListener('click', (e)=>{
      e.stopPropagation(); settingsMenu.style.display='none';
      openProfileModal();
    });
    document.getElementById('menu_email').addEventListener('click', (e)=>{
      e.stopPropagation(); settingsMenu.style.display='none';
      openEmailSettingsModal();
    });
    document.getElementById('menu_users').addEventListener('click', (e)=>{
      e.stopPropagation(); settingsMenu.style.display='none';
      openUserManagementModal();
    });
    document.getElementById('menu_logout').addEventListener('click', (e)=>{
      e.stopPropagation(); settingsMenu.style.display='none';
      logout();
    });
    function logout(){
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('current_user');
      location.reload();
    }
    function openUserManagementModal(){
      const modal = document.getElementById('user_management_modal');
      const list = document.getElementById('user_list');
      const msg = document.getElementById('user_management_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      loadUserList();
      document.getElementById('user_management_close').onclick = () => {
        modal.style.display = 'none';
      };
      document.getElementById('btn_new_user').onclick = () => {
        openNewUserModal();
      };
      modal.onclick = (ev) => { if(ev.target === modal) modal.style.display = 'none'; };
    }
    async function loadUserList(){
      const list = document.getElementById('user_list');
      list.innerHTML = '<div class="sub">Lade User...</div>';
      try{
        const res = await fetch('/api/admin/users', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.users){
          if(data.users.length === 0){
            list.innerHTML = '<div class="sub">Keine User vorhanden</div>';
            return;
          }
          let html = '<div style="display:grid; gap:8px;">';
          data.users.forEach(u => {
            const activeLabel = u.active ? '‚úÖ' : '‚ùå';
            const roleLabel = u.role === 'superadmin' ? 'üîë' : u.role === 'admin' ? '‚öôÔ∏è' : 'üë§';
            html += `<div style="background:#fff; border:1px solid var(--border); border-radius:6px; padding:10px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<div><div style="font-weight:600;">${roleLabel} ${escapeHtml(u.email)}</div>`;
            html += `<div class="sub">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')} ¬∑ ${u.role} ¬∑ ${activeLabel}</div></div>`;
            html += `<button onclick="deleteUser(${u.id}, '${escapeHtml(u.email)}')" style="background:#dc2626; padding:6px 10px; font-size:12px;">üóëÔ∏è L√∂schen</button>`;
            html += `</div>`;
          });
          html += '</div>';
          list.innerHTML = html;
        } else {
          list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler beim Laden: ' + (data.error || 'Unbekannt') + '</div>';
        }
      }catch(e){
        list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler: ' + e + '</div>';
      }
    }
    function openNewUserModal(){
      const modal = document.getElementById('new_user_modal');
      const msg = document.getElementById('new_user_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      document.getElementById('new_user_email').value = '';
      document.getElementById('new_user_first').value = '';
      document.getElementById('new_user_last').value = '';
      document.getElementById('new_user_pass').value = '';
      document.getElementById('new_user_role').value = 'user';
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('new_user_cancel').onclick = cleanup;
      document.getElementById('new_user_save').onclick = async () => {
        const email = document.getElementById('new_user_email').value.trim();
        const first = document.getElementById('new_user_first').value.trim();
        const last = document.getElementById('new_user_last').value.trim();
        const pass = document.getElementById('new_user_pass').value;
        const role = document.getElementById('new_user_role').value;
        if(!email || !pass){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        if(pass.length < 6){
          msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
          return;
        }
        msg.textContent = 'Erstelle User...';
        try{
          const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({email, first_name: first, last_name: last, password: pass, role})
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ User erstellt!';
            setTimeout(() => {
              cleanup();
              loadUserList();
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    window.deleteUser = async function(userId, email){
      if(!confirm(`User "${email}" wirklich l√∂schen?`)) return;
      const msg = document.getElementById('user_management_msg');
      msg.textContent = 'L√∂sche User...';
      try{
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok){
          msg.textContent = '‚úÖ User gel√∂scht';
          loadUserList();
        } else {
          msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
        }
      }catch(e){
        msg.textContent = 'Fehler: ' + e;
      }
    };
    // Check auth on app start
    checkAuth().then(ok => {
      if(ok) loadInbox();
    });
  </script>
</body>
</html>
