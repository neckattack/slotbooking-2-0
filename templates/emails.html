<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox â€“ neckattack</title>
  <style>
    :root { --border:#e5e7eb; --sub:#6b7280; --fg:#111827; --primary:#2563eb; --active:#f3f4f6; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; color: var(--fg); }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border); }
    h1 { margin: 0; font-size:20px; display:flex; gap:8px; align-items:center; }
    .toolbar { display:flex; align-items:center; gap:10px; }
    button { background:var(--primary); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }
    .container { display:grid; grid-template-columns: 360px 1fr 460px; height: calc(100vh - 58px); }
    .list { border-right:1px solid var(--border); overflow:auto; }
    .item { padding:10px 14px; border-bottom:1px solid var(--border); cursor:pointer; }
    .item:hover { background:#fafafa; }
    .item.active { background: var(--active); }
    .item .subject { font-size:14px; }
    .item.unseen .subject { font-weight:700; }
    .item .meta { color: var(--sub); font-size:12px; margin-top:3px; display:flex; justify-content:space-between; gap:8px; }
    .detail { overflow:auto; padding:16px 24px; }
    .detail h2 { margin:0 0 8px; font-size:18px; }
    .detail .meta { color: var(--sub); font-size:12px; margin-bottom:14px; }
    .detail .content { background:#fff; border:1px solid var(--border); border-radius:10px; padding:16px; }
    .profile { margin-top:16px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; }
    .profile h3 { margin:0 0 10px; font-size:16px; }
    .profile .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .profile .kv { font-size:13px; }
    .profile .kv span { color: var(--sub); display:inline-block; min-width:90px; }
    .compose { border-left:1px solid var(--border); padding:16px 16px; overflow:auto; }
    .compose h3 { margin:0 0 10px; font-size:16px; }
    .compose .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .compose label { width:60px; color:var(--sub); font-size:12px; }
    .compose input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
    .compose .editor { min-height:220px; border:1px solid var(--border); border-radius:10px; padding:12px; background:#fff; }
    .compose .actions { margin-top:10px; display:flex; gap:8px; }
    .muted { color:var(--sub); }
    .sub { color:var(--sub); font-size:12px; }
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <header>
    <h1>ðŸ“¥ Inbox</h1>
    <div class="toolbar">
      <button id="reload">Aktualisieren</button>
      <span id="status" class="sub"></span>
    </div>
  </header>
  <div class="container">
    <div class="list" id="list">
      <div class="sub" style="padding:12px 14px;">Lade â€¦</div>
    </div>
    <div class="detail" id="detail">
      <div class="sub">E-Mail auswÃ¤hlen â€¦</div>
    </div>
    <div class="compose" id="compose">
      <h3>Antwort</h3>
      <div class="row"><label>Empf.</label><input id="compose_to" placeholder="EmpfÃ¤nger" /></div>
      <div class="row"><label>Betreff</label><input id="compose_subject" placeholder="Betreff" /></div>
      <div id="compose_editor" class="editor" contenteditable="true"><div class="muted">Hier erscheint der Vorschlag â€¦</div></div>
      <div class="actions">
        <button id="btn_propose" disabled>Antwort vorschlagen</button>
        <button id="btn_send" disabled>Senden</button>
        <span id="compose_status" class="sub"></span>
      </div>
    </div>
  </div>

  <script>
    let currentUid = null;
    async function parseJsonSafe(res){
      const ct = res.headers.get('content-type') || '';
      const txt = await res.text();
      if(ct.includes('application/json')){
        try { return { __ok: res.ok, __status: res.status, ...(txt ? JSON.parse(txt) : {}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: 'UngÃ¼ltiges JSON vom Server', raw: txt }; }
      }
      // Fallback: leere OK-Antwort als Erfolg behandeln (manche Proxies strippen kleine JSON-Bodies)
      if(res.ok && (!txt || txt.trim() === '')){
        return { __ok: true, __status: res.status };
      }
      // Versuche JSON, sonst Fehlertext kapseln
      try { return { __ok: res.ok, __status: res.status, ...(JSON.parse(txt)||{}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: txt || 'Leere Antwort vom Server' }; }
    }
    async function loadInbox(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      status.textContent = 'lÃ¤dt â€¦';
      try{
        const res = await fetch('/api/emails/inbox?limit=20');
        const data = await parseJsonSafe(res);
        if(!data.__ok){ throw new Error(data.error || 'Inbox-Fehler'); }
        list.innerHTML = '';
        if(!data.items || !data.items.length){
          list.innerHTML = '<div class="sub">Keine E-Mails gefunden.</div>';
          status.textContent = '';
          return;
        }
        for(const it of data.items){
          const div = document.createElement('div');
          div.className = 'item' + (!it.seen ? ' unseen' : '');
          div.dataset.uid = it.uid;
          div.innerHTML = `
            <div class="subject">${escapeHtml(it.subject || '(ohne Betreff)')}</div>
            <div class="meta"><span>${escapeHtml(it.from || '')}</span><span>${escapeHtml(it.date || '')}</span></div>
          `;
          div.addEventListener('click', () => selectItem(it.uid, div));
          list.appendChild(div);
        }
        status.textContent = `${data.items.length} E-Mails geladen`;
      }catch(e){
        list.innerHTML = `<div class="sub">Fehler: ${e}</div>`;
        status.textContent = '';
      }
    }

    async function selectItem(uid, rowEl){
      // Active markieren
      document.querySelectorAll('.item.active').forEach(el => el.classList.remove('active'));
      rowEl.classList.add('active');
      currentUid = uid;
      // Draft-Controls aktivieren
      document.getElementById('btn_propose').disabled = false;
      document.getElementById('btn_send').disabled = false;
      // Thread laden
      const detail = document.getElementById('detail');
      detail.innerHTML = '<div class="sub">Lade Inhalt â€¦</div>';
      try{
        const res = await fetch(`/api/emails/thread?uid=${encodeURIComponent(uid)}`);
        const t = await parseJsonSafe(res);
        if(!t.__ok){ throw new Error(t.error || 'Thread-Fehler'); }
        const html = t.html || (t.text ? `<pre>${escapeHtml(t.text)}</pre>` : '<div class="sub">Kein Inhalt</div>');
        detail.innerHTML = `
          <h2>${escapeHtml(t.subject || '')}</h2>
          <div class="meta">Von: ${escapeHtml(t.from||'')} Â· An: ${escapeHtml(t.to||'')} Â· ${escapeHtml(t.date||'')}</div>
          <div class="content">${html}</div>
          <div class="profile" id="profile_panel">
            <h3>PROFIL</h3>
            <div class="grid">
              <div>
                <div class="kv"><span>Name</span><b id="prof_name">â€“</b></div>
                <div class="kv"><span>Eâ€‘Mail</span><b id="prof_email">â€“</b></div>
                <div class="kv"><span>Telefon</span><b id="prof_phone">â€“</b></div>
                <div class="kv"><span>Ort</span><b id="prof_city">â€“</b></div>
              </div>
              <div>
                <div class="kv"><span>Quelle</span><b id="prof_source">â€“</b></div>
                <div class="kv"><span>Letzter Kontakt</span><b id="prof_last">â€“</b></div>
                <div class="kv"><span>KanÃ¤le</span><b id="prof_channels">Eâ€‘Mail</b></div>
              </div>
            </div>
            <div style="margin-top:10px; font-size:13px;">
              <div class="sub" style="margin-bottom:6px;">Zusammenfassung</div>
              <div id="prof_summary">Noch keine Profildaten. Dieses Feld wird spÃ¤ter automatisch aus der Kommunikation erstellt.</div>
            </div>
          </div>
        `;
        // Als gelesen markieren (opt-in: beim Ã–ffnen)
        try{ await fetch('/api/emails/seen', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, seen:true})}); }catch(_){ }
        rowEl.classList.remove('unseen');
        // Prefetch: Draft im Hintergrund erzeugen
        try {
          const toInput = document.getElementById('compose_to');
          const subjInput = document.getElementById('compose_subject');
          const editor = document.getElementById('compose_editor');
          const res2 = await fetch('/api/emails/agent-compose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid, timeout_s: 8}) });
          const data2 = await parseJsonSafe(res2);
          if(data2 && data2.__ok && currentUid === uid){
            // Nur befÃ¼llen, wenn Editor noch leer/Marker enthÃ¤lt
            const htmlNow = (editor.innerHTML||'').trim();
            const isEmpty = !htmlNow || htmlNow.includes('Hier erscheint der Vorschlag');
            if(isEmpty){
              toInput.value = data2.to || '';
              subjInput.value = data2.subject || '';
              editor.innerHTML = data2.html || '<div class="muted">(leer)</div>';
              document.getElementById('compose_status').textContent = 'Vorschlag erstellt';
            }
          }
        } catch(_e) { /* still fine */ }
        // Profil-Panel mit Platzhalterdaten befÃ¼llen
        try {
          const from = t.from || '';
          const emailMatch = from.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
          const email = emailMatch ? emailMatch[0] : '';
          const nameMatch = from.replace(email, '').replace(/[<>]/g,'').trim();
          const name = nameMatch || (email ? email.split('@')[0] : '');
          renderProfilePlaceholder({
            name: name || 'â€“',
            email: email || 'â€“',
            phone: 'â€“',
            city: 'â€“',
            source: 'â€”',
            last: t.date || 'â€“',
            channels: 'Eâ€‘Mail',
            summary: 'Noch keine Zusammenfassung vorhanden.'
          });
        } catch(_) {}
      }catch(e){
        detail.innerHTML = `<div class="sub">Fehler: ${e}</div>`;
      }
    }

    async function proposeDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!currentUid){ status.textContent = 'Bitte zuerst eine E-Mail auswÃ¤hlen.'; return; }
      status.textContent = 'Vorschlag wird erstellt â€¦';
      try{
        // Erster Versuch (8s Timeout)
        let res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 8}) });
        let data = await parseJsonSafe(res);
        if(!data.__ok){
          // Bei 504 (compose_timeout/compose_empty) ein zweiter Versuch mit 20s Timeout
          if(data.__status === 504){
            status.textContent = 'Ausgelastet, zweiter Versuch (bis 20s) â€¦';
            res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 20}) });
            data = await parseJsonSafe(res);
          }
        }
        if(!data.__ok){
          throw new Error(data.error || ('Fehler (' + (data.__status||'') + ')'));
        }
        toInput.value = data.to || '';
        subjInput.value = data.subject || '';
        editor.innerHTML = data.html || '<div class="muted">(leer)</div>';
        status.textContent = 'Vorschlag erstellt';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    async function sendDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!toInput.value){ status.textContent = 'EmpfÃ¤nger fehlt.'; return; }
      status.textContent = 'Sende â€¦';
      try{
        const res = await fetch('/api/emails/send', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to: toInput.value, subject: subjInput.value, html: editor.innerHTML}) });
        const data = await parseJsonSafe(res);
        if(!data.__ok && data.error){ throw new Error(data.error); }
        status.textContent = 'Gesendet';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function renderProfilePlaceholder(p){
      const el = document.getElementById('profile_panel'); if(!el) return;
      const set = (id, val) => { const n = document.getElementById(id); if(n) n.textContent = val || 'â€“'; };
      set('prof_name', p.name);
      set('prof_email', p.email);
      set('prof_phone', p.phone);
      set('prof_city', p.city);
      set('prof_source', p.source);
      set('prof_last', p.last);
      set('prof_channels', p.channels);
      const sum = document.getElementById('prof_summary'); if(sum) sum.textContent = p.summary || 'â€“';
    }
    document.getElementById('reload').addEventListener('click', loadInbox);
    document.getElementById('btn_propose').addEventListener('click', proposeDraft);
    document.getElementById('btn_send').addEventListener('click', sendDraft);
    loadInbox();
  </script>
</body>
</html>
