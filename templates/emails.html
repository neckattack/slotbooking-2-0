<!doctype html>
<html lang="de">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox ‚Äì neckattack</title>
  <!-- Einfaches eingebettetes SVG-Favicon, damit kein 404 auf /favicon.ico entsteht -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%23111827'/%3E%3Ctext x='12' y='16' text-anchor='middle' font-size='11' fill='white' font-family='system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'%3EIQ%3C/text%3E%3C/svg%3E" />

    <style>
    :root { --border:#e5e7eb; --sub:#6b7280; --fg:#111827; --primary:#111827; --active:#f5f6f7; --hover:#f0f2f4; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; color: var(--fg); background:#fafafa; font-size:18px; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border); background:#ffffff; position:sticky; top:0; z-index:10; }
    .header-left { display:flex; align-items:center; gap:10px; }
    h1 { margin: 0; font-size:24px; display:flex; gap:8px; align-items:center; }
    .toolbar { display:flex; align-items:center; gap:12px; }
    button { background:var(--primary); color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:15px; }
    button:disabled { opacity:.6; cursor:default; }
    .container { display:grid; grid-template-columns: 420px 1fr; height: calc(100vh - 64px); }
    .list { border-right:1px solid var(--border); overflow-y:auto; overflow-x:hidden; background:#fff; }
    .item { padding:16px 18px; border-bottom:1px solid var(--border); cursor:pointer; overflow:hidden; }
    .item:hover { background: var(--hover); }
    .item.active { background: var(--active); border-left:3px solid var(--primary); padding-left:15px; }
    .item .subject { font-size:18px; line-height:1.4; }
    .item.unseen .subject { font-weight:700; }
    .item .meta { color: var(--sub); font-size:14px; margin-top:4px; display:flex; justify-content:space-between; gap:12px; }
    .item.answer-fade-out { opacity:0; transform:translateX(12px); transition:opacity 0.2s ease-out, transform 0.2s ease-out; }
    .detail { overflow:hidden; padding:20px 28px; background:#f9fafb; }
    .detail h2 { margin:0 0 10px; font-size:22px; }
    .detail .meta { color: var(--sub); font-size:14px; margin-bottom:16px; }
    .detail .content { background:#fff; border:1px solid var(--border); border-radius:10px; padding:20px; }
    /* E-Mail-Inhalt: eingebettete Bilder responsiv anzeigen.
       width/height aus dem HTML (z.B. 38x34) nicht erzwingen, sondern
       nat√ºrliche Gr√∂√üe nutzen und nur bei Bedarf herunterskalieren. */
    .detail .content img {
      display:block;
      max-width:100%;
      height:auto !important;
      width:auto !important;
    }
    .profile { margin-top:10px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:14px; width:100%; box-sizing:border-box; }
    .profile h3 { margin:0 0 12px; font-size:18px; }
    .profile .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .profile .kv { font-size:14px; }
    .profile .kv span { color: var(--sub); display:inline-block; min-width:90px; }
    .compose { position:fixed; top:64px; right:0; width:min(960px, 100vw); height:calc(100vh - 64px); border-left:1px solid var(--border); padding:18px 18px; overflow:auto; background:transparent; transform:translateX(100%); transition:transform 0.25s ease-out; z-index:50; }
    .compose.open { transform:translateX(0); }
    /* Inner Card des Compose-Panels im Tailwind-Stil (ohne Tailwind-Build) */
    .compose-inner {
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 18px 40px rgba(15,23,42,0.10);
      border:1px solid #e2e8f0;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .compose h3 { margin:0; font-size:18px; }
    .compose .row { display:flex; gap:10px; margin-bottom:8px; align-items:center; }
    .compose label { width:70px; color:var(--sub); font-size:13px; }
    .compose input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:15px; }
    .compose .editor {
      min-height:260px;
      border-radius:14px;
      padding:16px 18px;
      background:#f9fafb;
      font-size:15px;
      border:1px solid #e5e7eb;
      max-height:100%;
      overflow-y:auto; /* Antwortfeld intern scrollbar machen */
    }
    /* Absatzabst√§nde in der Antwort: etwas mehr Luft zwischen Paragraphen
       als bei einer normalen Zeile, ohne doppelte Leerzeilen zu erzeugen. */
    .compose .editor p {
      margin:0 0 0.7em;
    }
    .compose .editor p:last-child {
      margin-bottom:0;
    }
    .compose .actions { margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    /* Zweispaltiges Layout im Compose-Panel: links Antwort, rechts Themen (gleiche H√∂he, intern scrollbar) */
    .compose-body {
      display:flex;
      gap:18px;
      align-items:stretch;
      margin-top:8px;
      max-height:480px; /* gemeinsamer oberer Bereich; darunter Antwortstil-Block */
      overflow:hidden;
    }
    .compose-main,
    .compose-side,
    .compose-style {
      min-width:0;
      display:flex;
      flex-direction:column;
      min-height:0; /* wichtig f√ºr korrektes Scrollen der Inhalte */
    }
    /* Spaltenreihenfolge im Compose-Bereich: links Antwortstil, Mitte Editor (gr√∂√üte Spalte), rechts Themen (etwas breiter) */
    .compose-style {
      flex:0 0 230px; /* feste, schmale Stil-Spalte */
      order:0;
    }
    .compose-main {
      flex:3 1 0; /* Editor bleibt klar dominant */
      order:1;
    }
    .compose-side {
      flex:2 1 0; /* Themen-Spalte bekommt mehr Platz */
      order:2;
    }
    /* Editor nutzt den verf√ºgbaren Platz in der linken Spalte, Aktionen bleiben unten */
    .compose-main .editor {
      flex:1;
      min-height:0;
    }
    /* Themen-Spalte f√ºllt die volle H√∂he des oberen Bereichs und scrollt intern */
    .compose-side #compose_topics_mirror {
      flex:1;
      min-height:0;
      overflow:auto;
    }
    /* Antwortstil-Panel: volle Spaltenbreite f√ºr die Slider im modernen Card-Look */
    #compose_reply_prefs_block { width:100%; box-sizing:border-box; border-radius:14px; border:1px solid #e5e7eb; background:#f9fafb; padding:10px 14px 12px; }
    #compose_reply_prefs_block input[type="range"] {
      width:100%;
      display:block;
      margin:0; /* leichter Innenabstand links/rechts durch Padding der Card */
    }
    #compose_reply_prefs_block label > span {
      display:block;
      white-space:nowrap; /* Verhindert zweizeilige Darstellung wie in zwei Spalten */
    }
    .muted { color:var(--sub); }
    .sub { color:var(--sub); font-size:13px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:100; }
    .modal .box { background:#fff; border-radius:10px; padding:16px; width:320px; border:1px solid var(--border); }
    .modal .row { display:flex; gap:8px; margin:10px 0; align-items:center; }
    .modal label { width:90px; color:var(--sub); font-size:12px; }
    .modal input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
    .modal select { flex:1; padding:12px 14px; border:2px solid var(--border); border-radius:8px; font-size:15px; font-weight:500; background:#fff; cursor:pointer; transition:all 0.2s; appearance:none; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23111827' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; }
    .modal select:hover { border-color:#111827; }
    .modal select:focus { outline:none; border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,0.1); }
    .modal textarea { flex:1; padding:12px 14px; border:2px solid var(--border); border-radius:8px; font-size:14px; font-family:inherit; resize:vertical; transition:all 0.2s; }
    .modal textarea:hover { border-color:#111827; }
    .modal textarea:focus { outline:none; border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,0.1); }
    .sidebar { position:fixed; top:0; right:-320px; width:320px; height:100vh; background:#fff; box-shadow:-4px 0 20px rgba(0,0,0,0.1); z-index:200; transition:right 0.3s ease; overflow-y:auto; }
    .sidebar.open { right:0; }
    .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:199; display:none; transition:opacity 0.3s; }
    .sidebar-overlay.open { display:block; }
    .sidebar-header { padding:20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .sidebar-header h3 { margin:0; font-size:18px; }
    .sidebar-close { background:none; border:0; font-size:24px; cursor:pointer; color:var(--sub); padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; }
    .sidebar-close:hover { background:var(--hover); color:var(--fg); }
    .sidebar-menu { padding:0; margin:0; list-style:none; }
    .sidebar-menu li { border-bottom:1px solid var(--border); }
    .sidebar-menu li a { display:flex; align-items:center; gap:12px; padding:16px 20px; text-decoration:none; color:var(--fg); font-size:15px; transition:background 0.2s; }
    .sidebar-menu li a:hover { background:var(--hover); }
    .sidebar-menu li a .icon { font-size:20px; width:24px; }

    /* Detail layout: scrollable content (70%) + scrollbares Profil (30%) im gleichen Panel (Desktop) */
    .detail {
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .detail-scroll {
      flex:0 0 70%;
      min-height:0;
      overflow:auto;
      padding-right:4px;
    }
    .detail-splitter {
      flex:0 0 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:row-resize;
      user-select:none;
      background:#f3f4f6;
    }
    .detail-splitter::before {
      content:'';
      width:96px;
      height:4px;
      border-radius:999px;
      background:#d1d5db;
    }
    .detail-splitter:hover::before {
      background:#9ca3af;
    }
    .detail > .profile {
      flex:0 0 30%;
      min-height:0;
      overflow:auto;
    }

    /* Responsive Design for Mobile */
    @media (max-width: 768px) {
      /* Header wraps on mobile */
      header { flex-wrap:wrap; gap:8px; padding:10px; }
      h1 { font-size:16px; flex:1; min-width:0; }
      .toolbar { flex-wrap:wrap; width:100%; justify-content:flex-end; gap:6px; }
      .toolbar button { padding:6px 10px; font-size:13px; }
      #status { order:-1; width:100%; margin:0 0 4px 0 !important; text-align:center; }
      if(menuBtnAlt){
      menuBtnAlt.addEventListener('click', openSidebar);
    }
      /* Stack layout vertically on mobile */
      .container { 
        display:flex; 
        flex-direction:column; 
        height:auto; 
        min-height:calc(100vh - 100px); 
      }
      
      /* List takes full width, scroll horizontally disabled */
      .list { 
        border-right:none; 
        border-bottom:1px solid var(--border); 
        max-height:40vh; 
        width:100%; 
        overflow-x:hidden;
      }
      
      /* Detail takes full width (reset flex layout) */
      .detail { 
        width:100%; 
        min-height:300px;
        padding:12px;
        overflow-x:hidden;
        display:block;
      }
      .detail-scroll {
        padding-right:0;
        overflow:visible;
      }
      .detail > .profile {
        flex:none;
        max-height:none;
        overflow:visible;
      }
      
      /* Compose section on mobile */
      .compose { 
        border-left:none; 
        border-top:1px solid var(--border); 
        width:100%;
        padding:12px;
        overflow-x:hidden;
      }
      /* Auf Mobile: oberer Bereich nicht k√ºnstlich begrenzen, Spalten weiter untereinander */
      .compose-body {
        max-height:none;
        overflow:visible;
      }
      /* In der Mobile-Ansicht Compose-Spalten untereinander stapeln */
      .compose-body {
        flex-direction:column;
      }
      
      /* Make modals responsive */
      .modal .box { 
        width:90vw !important; 
        max-width:400px !important;
        max-height:85vh;
        overflow:auto;
      }
      
      /* Profile grid single column on mobile */
      .profile .grid { 
        grid-template-columns:1fr; 
      }
      
      /* Compose editor smaller on mobile */
      .compose .editor { 
        min-height:150px; 
        font-size:14px;
      }
      
      /* Actions wrap on mobile */
      .compose .actions { 
        flex-wrap:wrap; 
      }
      
      /* Detail content padding */
      .detail .content { 
        padding:12px; 
      }
    }

    /* Extra small devices */
    @media (max-width: 480px) {
      header { padding:8px; }
      h1 { font-size:14px; }
      .toolbar button { padding:5px 8px; font-size:12px; }
      .detail { padding:8px; }
      .compose { padding:8px; }
      .item { padding:8px 10px; }
      .profile { padding:10px; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="/static/icons.js"></script>
</head>
<body>
  <header>
    <div class="header-left">
      <h1 id="account_title">üì• Inbox</h1>
      <select id="folder_select" style="height:36px; padding:8px 16px; border-radius:8px; border:1px solid var(--border); font-size:15px; font-weight:500; min-width:150px; background:#ffffff; color:#111827;"></select>
    </div>
    <div class="toolbar">
      <span id="build_info" class="sub" style="font-size:11px; margin-right:8px; color:#6b7280; white-space:nowrap;">Build ‚Ä¶</span>
      <input id="inbox_search" type="text" placeholder="üîç Absender suchen..." style="flex:1; max-width:520px; height:44px; padding:10px 18px; border:1px solid var(--border); border-radius:999px; font-size:15px; min-width:320px;" />
      <button id="reload" title="Aktualisieren" style="width:34px; height:34px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:999px; background:#111827; color:#ffffff;">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 4a7 7 0 0 1 6.32 4H16.5a.75.75 0 0 0 0 1.5H21a.75.75 0 0 0 .75-.75V4.5a.75.75 0 0 0-1.5 0v1.46A8.5 8.5 0 0 0 12 2.5 8.25 8.25 0 0 0 4.3 7.09a.75.75 0 1 0 1.33.67A6.75 6.75 0 0 1 12 4Z" fill="white"/>
          <path d="M12 20a7 7 0 0 1-6.32-4H7.5a.75.75 0 0 0 0-1.5H3a.75.75 0 0 0-.75.75V19.5a.75.75 0 0 0 1.5 0v-1.46A8.5 8.5 0 0 0 12 21.5a8.25 8.25 0 0 0 7.7-4.59.75.75 0 0 0-1.33-.67A6.75 6.75 0 0 1 12 20Z" fill="white"/>
        </svg>
      </button>
      <button id="load_more_btn" style="background:transparent; color:#111827; border:0; display:none; padding:0; border-radius:0; font-size:13px; cursor:pointer;">‚úï</button>
      <span id="status" class="sub" style="margin-right:auto;"></span>
      <button id="user_badge" style="background:#111827; display:none; padding:6px 12px; border-radius:10px; font-size:13px;">üë§</button>
      <button id="menu_btn" style="background:#111827; font-size:14px; padding:8px 14px; display:flex; align-items:center; justify-content:center; border-radius:12px;" aria-label="Men√º √∂ffnen">‚ò∞</button>
    </div>
  </header>
  <div class="container">
    <div class="list" id="list"></div>
    <div class="detail" id="detail">
      <div class="sub">E-Mail ausw√§hlen ‚Ä¶</div>
    </div>
    <div class="compose" id="compose">
      <div class="compose-inner">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
          <h3 style="margin:0;">Antwort</h3>
          <button id="compose_close_btn" title="Antwort schlie√üen" style="display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:999px; background:#020617; color:#ffffff; border:0; font-size:14px; cursor:pointer;">‚úï</button>
        </div>
        <div class="compose-body">
          <div class="compose-style">
            <div id="compose_reply_prefs_block" class="sub" style="margin-top:0; font-size:11px; color:#111827;">
          <div style="display:flex; justify-content:flex-start; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; font-size:12px;">
            <span>‚úâÔ∏è Antwortstil</span>
          </div>
          <div id="compose_reply_prefs_status" class="sub" style="font-size:11px; margin-bottom:6px; color:#6b7280;">Antwortstil: Lade Einstellungen‚Ä¶</div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;">
              <span>L√§nge der Antwort <span id="cmp_length_label" class="muted">(Standard)</span></span>
              <input id="cmp_length" type="range" min="1" max="5" step="1" value="3" />
            </label>
            <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;">
              <span>F√∂rmlichkeit <span id="cmp_formality_label" class="muted">(Standard)</span></span>
              <input id="cmp_formality" type="range" min="1" max="5" step="1" value="3" />
            </label>
            <div style="display:flex; flex-direction:column; gap:4px; font-size:11px;">
              <div>
                <span style="margin-right:6px;">Anrede</span>
                <button type="button" id="cmp_sal_du" data-value="du" style="padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; font-size:10px; cursor:pointer; margin-right:4px;">Du</button>
                <button type="button" id="cmp_sal_sie" data-value="sie" style="padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; font-size:10px; cursor:pointer;">Sie</button>
              </div>
              <div>
                <span style="margin-right:6px;">Perspektive</span>
                <button type="button" id="cmp_pers_ich" data-value="ich" style="padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; font-size:10px; cursor:pointer; margin-right:4px;">Ich</button>
                <button type="button" id="cmp_pers_wir" data-value="wir" style="padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; font-size:10px; cursor:pointer;">Wir</button>
              </div>
            </div>
          </div>
          <div id="compose_reply_prefs_label" class="sub" style="margin-top:6px; font-size:11px; color:#6b7280; display:none;"></div>
        </div>
          </div>
          <div class="compose-main">
            <div class="row" style="position:relative; align-items:center;">
              <label>Empf.</label>
              <input id="compose_to" placeholder="Empf√§nger" />
              <div style="position:absolute; right:10px; top:50%; transform:translateY(-50%); font-size:10px; color:#6b7280; display:flex; align-items:center; gap:6px;">
                <button id="compose_cc_toggle" type="button" style="border:0; background:transparent; padding:0; cursor:pointer; color:inherit;">Cc</button>
                <button id="compose_bcc_toggle" type="button" style="border:0; background:transparent; padding:0; cursor:pointer; color:inherit;">Bcc</button>
              </div>
            </div>
            <div class="row" id="compose_cc_row" style="display:none;"><label>Cc</label><input id="compose_cc" placeholder="Cc" /></div>
            <div class="row" id="compose_bcc_row" style="display:none;"><label>Bcc</label><input id="compose_bcc" placeholder="Bcc" /></div>
            <div class="row"><label>Betreff</label><input id="compose_subject" placeholder="Betreff" /></div>
            <div style="margin:4px 0 6px; display:flex; align-items:center; justify-content:flex-end; gap:8px; font-size:11px; color:#6b7280;">
              <button id="btn_translate" type="button" class="inline-flex items-center justify-center" style="border:none; background:transparent; padding:2px; cursor:pointer; color:#4b5563;" title="Entwurf in Kontaktsprache √ºbersetzen">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                  <path d="m5 8 6 6"/>
                  <path d="m4 14 6-6 2-3"/>
                  <path d="M2 5h12"/>
                  <path d="M7 2h1"/>
                  <path d="m16 13 3 5 3-5"/>
                  <path d="M19 11v1"/>
                  <path d="M19 18v1"/>
                </svg>
              </button>
              <button id="btn_attach" type="button" class="inline-flex items-center justify-center" style="border:none; background:transparent; padding:2px; cursor:pointer; color:#4b5563;" title="Anhang hinzuf√ºgen">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                  <path d="M21.44 11.05 12 20.5a5 5 0 0 1-7.07-7.07l9.19-9.19a3.5 3.5 0 0 1 4.95 4.95L9.88 18.38a2 2 0 0 1-2.83-2.83L15.07 7.5"/>
                </svg>
              </button>
              <input id="compose_attachments" type="file" multiple style="display:none;" />
              <span id="compose_attachments_list" class="sub" style="font-size:11px; color:#6b7280; max-width:60%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></span>
            </div>
            <div id="compose_editor" class="editor" contenteditable="true"><div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div></div>
            <div class="actions" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <button id="btn_propose" disabled class="px-4 py-2 rounded-full bg-slate-900 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-1">
                <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <polyline points="23 4 23 10 17 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                  <polyline points="1 20 1 14 7 14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <span>Antwort vorschlagen / neu formulieren</span>
              </button>
              <button id="btn_send" disabled class="px-3 py-2 rounded-full bg-emerald-600 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center;">
                <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M3 12L21 3 14 21 12 13 3 12Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
              <span id="compose_status" class="sub" style="font-size:11px;"></span>
            </div>
          </div>
          <div class="compose-side">
            <div id="compose_topics_mirror" class="sub" style="margin-top:0; font-size:11px; overflow:auto;"></div>
          </div>
        </div>
        <!-- Debug-Panel f√ºr das Antwortmodul: zeigt Rohwerte aus contacts und reply_prefs -->
        <div id="compose_debug_block" class="sub" style="margin-top:8px; font-size:11px; color:#111827; border-radius:10px; border:1px dashed #cbd5f5; background:#eff6ff; padding:8px 10px;">
          <div style="font-weight:600; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
            <span>üõ†Ô∏è Debug Antwortmodul</span>
            <span style="font-size:10px; color:#6b7280;">(Rohwerte aus contacts / reply_prefs)</span>
            <button id="compose_debug_history_btn" type="button" style="margin-left:auto; border:0; padding:3px 8px; border-radius:999px; font-size:10px; cursor:pointer; background:#e5e7eb; color:#374151;">History-Debug</button>
          </div>
          <div style="display:flex; flex-direction:column; gap:2px; font-size:10px; font-family:monospace;">
            <div><span class="muted">contact_id:</span> <span id="compose_debug_contact_id">(noch nicht geladen)</span></div>
            <div><span class="muted">contact_email:</span> <span id="compose_debug_contact_email">(noch nicht geladen)</span></div>
            <div><span class="muted">contact_name:</span> <span id="compose_debug_contact_name">(noch nicht geladen)</span></div>
            <div><span class="muted">style_source:</span> <span id="compose_debug_style_source">(noch nicht geladen)</span></div>
            <div><span class="muted">length_level:</span> <span id="compose_debug_length">(noch nicht geladen)</span></div>
            <div><span class="muted">formality_level:</span> <span id="compose_debug_formality">(noch nicht geladen)</span></div>
            <div><span class="muted">salutation_mode:</span> <span id="compose_debug_salutation">(noch nicht geladen)</span></div>
            <div><span class="muted">persona_mode:</span> <span id="compose_debug_persona">(noch nicht geladen)</span></div>
            <div><span class="muted">reply_greeting_template:</span> <span id="compose_debug_greeting">(noch nicht geladen)</span></div>
            <div><span class="muted">reply_closing_template:</span> <span id="compose_debug_closing">(noch nicht geladen)</span></div>
          </div>
          <div id="compose_debug_warnings" style="margin-top:4px; font-size:10px; color:#b45309; white-space:pre-wrap;"></div>
          <pre id="compose_debug_history" style="margin-top:4px; font-size:10px; font-family:monospace; max-height:140px; overflow:auto; white-space:pre-wrap; background:#dbeafe; border-radius:6px; padding:6px; display:none;"></pre>
        </div>
      </div>
    </div>

  <!-- Simple Image Lightbox for inline email images -->
  <div id="image_lightbox" class="modal" style="z-index:300;">
    <div class="box" style="width:auto; max-width:90vw; max-height:90vh; padding:0; border:none; background:transparent; box-shadow:none;">
      <div style="position:relative;">
        <button id="image_lightbox_close" style="position:absolute; top:-32px; right:-32px; background:#111827; color:#fff; border-radius:999px; width:28px; height:28px; border:0; cursor:pointer; font-size:16px; line-height:1;">‚úï</button>
        <img id="image_lightbox_img" src="" alt="Bild" style="display:block; max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.35);" />
      </div>
    </div>
  </div>

  <!-- Login Modal (required at app start) -->
  <div id="login_modal" class="modal" style="display:none;">
    <div class="box">
      <h3 style="margin:0 0 10px;">Login</h3>
      <div class="row"><label>E‚ÄëMail</label><input id="login_email" placeholder="you@domain.com"></div>
      <div class="row"><label>Passwort</label><input id="login_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="login_debug" style="background:#6b7280;">Debug</button>
        <button id="login_submit">Login</button>
      </div>
      <div id="login_msg" class="sub" style="margin-top:8px; white-space:pre-wrap; text-align:left;"></div>
    </div>
  </div>

  <!-- E-Mail Settings Modal -->
  <div id="email_settings_modal" class="modal">
    <div class="box" style="width:480px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">E‚ÄëMail Einstellungen</h3>
      <div style="margin-bottom:12px; padding:10px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; display:flex; flex-direction:column; gap:8px;">
        <div class="row" style="margin:0; align-items:center;">
          <label style="width:100px;">Account</label>
          <select id="email_account_select" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="">Neuer Account ‚Ä¶</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">IMAP (Empfang)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="imap_host" placeholder="imap.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="imap_port" type="number" placeholder="993"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="imap_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="imap_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="imap_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
          </select>
        </div>
        <div id="imap_port_hint" class="sub" style="margin-top:8px; padding:8px; background:#fef3c7; border:1px solid #fbbf24; border-radius:4px; display:none;">
          üí° <span id="imap_port_hint_text"></span>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">SMTP (Versand)</h4>
        <div class="row"><label style="width:100px;">Host</label><input id="smtp_host" placeholder="smtp.example.com"></div>
        <div class="row"><label style="width:100px;">Port</label><input id="smtp_port" type="number" placeholder="465"></div>
        <div class="row"><label style="width:100px;">Benutzername</label><input id="smtp_user" placeholder="user@example.com"></div>
        <div class="row"><label style="width:100px;">Passwort</label><input id="smtp_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label style="width:100px;">Security</label>
          <select id="smtp_security" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
            <option value="ssl">SSL</option>
            <option value="starttls">STARTTLS</option>
            <option value="auto">Auto</option>
          </select>
        </div>
        <div id="smtp_port_hint" class="sub" style="margin-top:8px; padding:8px; background:#fef3c7; border:1px solid #fbbf24; border-radius:4px; display:none;">
          üí° <span id="smtp_port_hint_text"></span>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">Signatur</h4>
        <div class="sub" style="margin-bottom:6px;">
          Freier Text oder HTML. Hier kannst du auch ein Bild per &lt;img src="https://..."&gt; einbinden.
        </div>
        <textarea id="email_signature_html" rows="4" placeholder="--\nBeste Gr√º√üe\nChris" style="width:100%; font-size:13px; padding:8px 10px; border:1px solid var(--border); border-radius:6px; resize:vertical; margin-bottom:8px;"></textarea>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="file" id="email_signature_image" accept="image/*" style="flex:1; font-size:12px;" />
          <button id="email_signature_upload_btn" type="button" style="background:#e5e7eb; color:#111827; border:1px solid #d1d5db; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer; white-space:nowrap;">Bild hochladen</button>
        </div>
        <div id="email_signature_img_status" class="sub" style="margin-top:4px;"></div>
      </div>
      <div style="margin-bottom:12px; padding:12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px;">
        <button id="smtp_test_btn" style="background:#0284c7; color:#fff; width:100%;">üîß SMTP-Verbindung testen</button>
        <div id="smtp_test_result" class="sub" style="margin-top:8px;"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:12px;">
        <button id="email_account_delete" title="Account l√∂schen" style="background:transparent; color:#dc2626; border:0; padding:0 4px; font-size:18px;">üóë</button>
        <div style="display:flex; gap:8px;">
          <button id="email_settings_cancel" style="background:#6b7280;">Abbrechen</button>
          <button id="email_settings_save">Speichern</button>
        </div>
      </div>
      <div id="email_settings_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="user_management_modal" class="modal">
    <div class="box" style="width:640px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 12px;">üë• User-Verwaltung</h3>
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <button id="btn_new_user" style="background:#059669;">‚ûï Neuer User</button>
      </div>
      <div id="user_list" style="background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:12px; min-height:200px;">
        <div class="sub">Lade User...</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="user_management_close" style="background:#6b7280;">Schlie√üen</button>
      </div>
      <div id="user_management_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Sidebar Menu -->
  <div class="sidebar-overlay" id="sidebar_overlay"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3 style="display:flex; align-items:center; gap:8px;"><span class="icon" data-icon="settings"></span><span>Einstellungen</span></h3>
      <button class="sidebar-close" id="sidebar_close">‚úï</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" id="sidebar_profile"><span class="icon" data-icon="user"></span> Profil</a></li>
      <li><a href="#" id="sidebar_agent"><span class="icon" data-icon="settings"></span> Agent-Setup</a></li>
      <li><a href="#" id="sidebar_knowledge"><span class="icon" data-icon="book"></span> Wissensdatenbank</a></li>
      <li><a href="#" id="sidebar_contacts"><span class="icon" data-icon="users"></span> Kontakte</a></li>
      <li><a href="#" id="sidebar_email"><span class="icon" data-icon="mail"></span> E-Mail-Einstellungen</a></li>
      <li id="sidebar_users_item" style="display:none;"><a href="#" id="sidebar_users"><span class="icon" data-icon="users"></span> User-Verwaltung</a></li>
      <li style="border-top:2px solid var(--border);"><a href="#" id="sidebar_logout" style="color:#dc2626;">Logout</a></li>
    </ul>
  </div>

  <!-- Profile Modal -->
  <div id="profile_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">üë§ Mein Profil</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="profile_email" disabled style="background:#f3f4f6;"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="profile_first" placeholder="Vorname"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="profile_last" placeholder="Nachname"></div>
      <div class="row"><label style="width:100px;">Rolle</label><input id="profile_role" disabled style="background:#f3f4f6;"></div>
      <div class="row"><label style="width:100px;">Sprache</label>
        <select id="profile_language" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
          <option value="">(nicht gesetzt)</option>
          <option value="de">Deutsch</option>
          <option value="en">Englisch</option>
          <option value="fr">Franz√∂sisch</option>
          <option value="es">Spanisch</option>
          <option value="it">Italienisch</option>
          <option value="nl">Niederl√§ndisch</option>
          <option value="pl">Polnisch</option>
          <option value="pt">Portugiesisch</option>
          <option value="sv">Schwedisch</option>
          <option value="da">D√§nisch</option>
          <option value="tr">T√ºrkisch</option>
          <option value="ja">Japanisch</option>
          <option value="zh">Chinesisch (vereinfacht)</option>
        </select>
      </div>
      <div style="border-top:1px solid var(--border); margin:16px 0; padding-top:16px;">
        <h4 style="margin:0 0 8px; font-size:14px;">üîí Passwort √§ndern (optional)</h4>
        <div class="row"><label style="width:100px;">Neu</label><input id="profile_new_pass" type="password" placeholder="min. 6 Zeichen"></div>
        <div class="row"><label style="width:100px;">Wiederholen</label><input id="profile_confirm_pass" type="password" placeholder="best√§tigen"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="profile_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="profile_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="profile_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- New User Modal -->
  <div id="new_user_modal" class="modal">
    <div class="box" style="width:420px;">
      <h3 style="margin:0 0 12px;">‚ûï Neuer User</h3>
      <div class="row"><label style="width:100px;">E‚ÄëMail</label><input id="new_user_email" placeholder="user@example.com"></div>
      <div class="row"><label style="width:100px;">Vorname</label><input id="new_user_first" placeholder="Max"></div>
      <div class="row"><label style="width:100px;">Nachname</label><input id="new_user_last" placeholder="Mustermann"></div>
      <div class="row"><label style="width:100px;">Passwort</label><input id="new_user_pass" type="password" placeholder="min. 6 Zeichen"></div>
      <div class="row"><label style="width:100px;">Rolle</label>
        <select id="new_user_role" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superadmin">Superadmin</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="new_user_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="new_user_save" style="background:#059669;">Erstellen</button>
      </div>
      <div id="new_user_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Agent Setup Modal -->
  <div id="agent_setup_modal" class="modal">
    <div class="box" style="width:520px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin:0 0 12px;">ü§ñ Agent-Setup</h3>
      
      <div class="row">
        <label style="width:120px;">Agent-Rolle</label>
        <select id="agent_role">
          <option value="">-- Bitte w√§hlen --</option>
          <option value="Vertrieb">Vertrieb</option>
          <option value="Support">Support</option>
          <option value="Manager">Manager</option>
          <option value="Controller">Controller</option>
          <option value="HR">HR / Personalwesen</option>
          <option value="Sonstige">Sonstige</option>
        </select>
      </div>
      
      <div class="row" style="align-items:flex-start; margin-top:16px;">
        <label style="width:120px; padding-top:12px;">Anweisungen</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="agent_instructions" placeholder="z.B. 'Antworte immer kurz und h√∂flich...'" rows="5" maxlength="500" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Max. 500 Zeichen</small>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="agent_setup_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="agent_setup_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="agent_setup_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Knowledge Base Modal -->
  <div id="knowledge_modal" class="modal">
    <div class="box" style="width:600px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin:0 0 12px;">üìö Wissensdatenbank</h3>
      
      <div class="row" style="align-items:flex-start;">
        <label style="width:140px; padding-top:12px;">FAQ-Text</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="knowledge_faq" placeholder="Strukturiere deine FAQs nach Rollen, z.B.:&#10;&#10;## FAQ f√ºr Kunden&#10;...&#10;&#10;## FAQ f√ºr Masseure&#10;...&#10;&#10;## FAQ f√ºr internes Team&#10;..." rows="12" maxlength="5000" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Max. 5000 Zeichen ¬∑ Optional nach Rollenbl√∂cken (Kunden / Masseure / intern) gliedern</small>
        </div>
      </div>
      
      <div class="row" style="align-items:flex-start; margin-top:16px;">
        <label style="width:140px; padding-top:12px;">Dokument-Links</label>
        <div style="flex:1; display:flex; flex-direction:column;">
          <textarea id="knowledge_links" placeholder="Links zu Dokumenten (einer pro Zeile)&#10;&#10;z.B.&#10;https://firma.de/faq.pdf&#10;https://firma.de/preisliste.pdf&#10;https://firma.de/handbuch.docx" rows="6" maxlength="2000" style="width:100%;"></textarea>
          <small class="sub" style="margin-top:4px;">Optional - Ein Link pro Zeile, max. 2000 Zeichen</small>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="knowledge_cancel" style="background:#6b7280;">Abbrechen</button>
        <button id="knowledge_save" style="background:#059669;">Speichern</button>
      </div>
      <div id="knowledge_msg" class="sub" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div id="contacts_modal" class="modal">
    <div class="box" style="width:700px; max-height:90vh; overflow:auto;">
      <h3 style="margin:0 0 16px;">üìá Kontakte</h3>
      <div style="margin-bottom:16px;">
        <input id="contacts_search" type="text" placeholder="üîç Suche nach Name oder E-Mail..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; font-size:14px;">
      </div>
      <div id="contacts_list" style="min-height:200px;">
        <div class="sub" style="text-align:center; padding:20px;">Lade Kontakte...</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button id="contacts_close" style="background:#6b7280;">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Contact Detail Modal -->
  <div id="contact_detail_modal" class="modal">
    <div class="box" style="width:800px; max-height:90vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
        <div>
          <h3 id="contact_detail_name" style="margin:0 0 4px;">Kontakt</h3>
          <div class="sub" id="contact_detail_email">email@example.com</div>
        </div>
        <button id="contact_detail_close" style="background:#6b7280; padding:8px 12px;">‚úï</button>
      </div>
      <div class="sub" style="margin-bottom:4px;">
        <strong id="contact_detail_count">0</strong> E-Mails insgesamt
      </div>
      <div id="contact_reply_prefs_status" class="sub" style="margin-bottom:12px; font-size:11px; color:#6b7280;">
        Antwortstil: Lade Einstellungen‚Ä¶
      </div>
      <div id="contact_detail_emails" style="border-top:1px solid var(--border); padding-top:16px;">
        <div class="sub" style="text-align:center; padding:20px;">Lade E-Mails...</div>
      </div>
    </div>
  </div>

  <script>
    let currentUid = null;
    // Load email limit from localStorage or default to 200, damit mehr Mails sichtbar sind
    let currentEmailLimit = parseInt(localStorage.getItem('emailLimit')) || 200;
    // Aktueller E-Mail-Account (Multi-Account-Unterst√ºtzung)
    let currentAccountId = null;
    // E-Mail-Accounts f√ºr Einstellungen (Verwaltung im Modal)
    let emailAccounts = [];
    let currentSettingsAccountId = null;
    // Inbox filtering: 'focus' (wichtig), 'normal' (Standard) vs 'unwichtig' (Newsletter etc.)
    let inboxFilter = 'focus';
    // Answer filter: 'unanswered' vs 'all'/'answered' ‚Äì Standard: nur unbeantwortete Mails zeigen
    // Basis ist das persistente Feld is_replied aus der Datenbank (IMAP-Flag \Answered).
    let inboxAnswerFilter = 'unanswered';
    let inboxEmails = [];
    // Manuelle Wichtigkeitsregeln pro Absender (vom Server und/oder localStorage geladen)
    let importanceRules = [];
    let inboxSearchQuery = '';
    // Aktueller Ordner (DB-Key, z.B. 'inbox', 'archive', 'all')
    let currentFolder = 'inbox';
    // Verf√ºgbare Ordner f√ºr den aktuellen Account
    let availableFolders = [];
    const accountFolderCache = {};
    // Aktueller Kontakt & dessen Reply-Preferences (f√ºr Compose-Panel)
    let currentContactId = null;
    let currentContactName = null;
    let currentContactEmail = null;
    let currentReplyPrefs = null;

    // "Stil anpassen" im Compose-Panel √∂ffnet das Kontakt-Detail-Modal f√ºr den aktuellen Kontakt
    (function(){
      try{
        const editBtn = document.getElementById('compose_reply_prefs_edit');
        if(editBtn){
          editBtn.onclick = () => {
            if(!currentContactId){
              alert('Kein Kontakt zur aktuellen E-Mail erkannt.');
              return;
            }
            const name = currentContactName || currentContactEmail || 'Kontakt';
            const email = currentContactEmail || '';
            openContactDetailModal(currentContactId, name, email);
          };
        }
      }catch(_e){}
    })();

// Einfaches Kontextmen√º f√ºr E-Mail-Zeilen (z.B. "Als gelesen/ungelesen markieren")
let inboxContextMenuEl = null;
let inboxContextMenuCurrentItem = null; // { email: it, row: div }

function ensureInboxContextMenu(){
  if(inboxContextMenuEl) return inboxContextMenuEl;
  const el = document.createElement('div');
  el.id = 'inbox_context_menu';
  el.style.cssText = 'position:fixed; z-index:300; background:#fff; border:1px solid var(--border); border-radius:6px; box-shadow:0 10px 30px rgba(0,0,0,0.15); font-size:13px; padding:4px 0; min-width:200px; display:none;';
  el.innerHTML = '<button type="button" id="ctx_toggle_read" style="width:100%; text-align:left; padding:8px 14px; border:0; background:#111827; color:#f9fafb; cursor:pointer; font-size:13px;">Als gelesen markieren</button>';
  document.body.appendChild(el);
  // Globaler Klick schlie√üt Men√º
  document.addEventListener('click', (ev) => {
    if(!el || el.style.display === 'none') return;
    if(!el.contains(ev.target)){ el.style.display = 'none'; }
  });
  // Klick auf Men√ºeintrag: gelesen/ungelesen umschalten
  const btn = el.querySelector('#ctx_toggle_read');
  if(btn){
    btn.addEventListener('click', async () => {
      try{
        const item = inboxContextMenuCurrentItem;
        if(!item || !item.email || !item.row) return;
        const it = item.email;
        const div = item.row;
        const newSeen = !it.is_read;
        await fetch('/api/emails/seen', {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: it.uid, seen: newSeen })
        });
        it.is_read = newSeen ? 1 : 0;
        if(newSeen){
          div.classList.remove('unseen');
        } else {
          div.classList.add('unseen');
        }
      }catch(_e){ }
      el.style.display = 'none';
    });
  }
  inboxContextMenuEl = el;
  return el;
}
    async function parseJsonSafe(res){
      const ct = res.headers.get('content-type') || '';
      const txt = await res.text();
      if(ct.includes('application/json')){
        try { return { __ok: res.ok, __status: res.status, ...(txt ? JSON.parse(txt) : {}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: 'Ung√ºltiges JSON vom Server', raw: txt }; }
      }
      // Fallback: leere OK-Antwort als Erfolg behandeln (manche Proxies strippen kleine JSON-Bodies)
      if(res.ok && (!txt || txt.trim() === '')){
        return { __ok: true, __status: res.status };
      }
      // Versuche JSON, sonst Fehlertext kapseln
      try { return { __ok: res.ok, __status: res.status, ...(JSON.parse(txt)||{}) }; } catch(_){ return { __ok: res.ok, __status: res.status, error: txt || 'Leere Antwort vom Server' }; }
    }
    
    // Format customer profile with HTML structure
    function formatCustomerProfile(text){
      if(!text) return text;
      
      // Split by numbered sections (1., 2., 3., etc.) or double asterisks
      let html = text;
      
      // Format bold sections: **Text:** -> <strong>Text:</strong>
      html = html.replace(/\*\*([^*]+):\*\*/g, '<strong style="color:#7c3aed;font-size:1.05em;">$1:</strong>');
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      // Format numbered sections: 1. **Title** -> <h4>Title</h4>
      html = html.replace(/(\d+)\.\s+\*\*([^*]+)\*\*/g, '<h4 style="margin:12px 0 6px 0;color:#7c3aed;font-size:1.1em;">$1. $2</h4>');
      
      // Format bullet points: ‚Ä¢ or - at line start
      html = html.replace(/^[‚Ä¢\-]\s+(.+)$/gm, '<div style="margin-left:16px;margin-bottom:4px;">‚Ä¢ $1</div>');
      
      // Format paragraphs: double line breaks
      html = html.split('\n\n').map(para => {
        para = para.trim();
        if(!para) return '';
        // Don't wrap if already has HTML tags
        if(para.includes('<h4') || para.includes('<div')) return para;
        return `<p style="margin:8px 0;line-height:1.6;">${para}</p>`;
      }).join('');
      
      // Single line breaks to <br>
      html = html.replace(/\n/g, '<br>');
      
      return html;
    }
    
    // Hilfsfunktion: aus "Name <mail@domain>" nur "mail@domain" extrahieren
    function normalizeEmailAddress(str){
      if(!str) return '';
      const s = String(str).trim().toLowerCase();
      const m = /<([^>]+)>/.exec(s);
      if(m) return m[1].trim();
      return s;
    }

    // Einfache Wichtigkeits-Heuristik pro E-Mail
    // R√ºckgabe: 'focus' | 'normal' | 'unwichtig'
    function getImportanceBucket(it){
      const fromAddr = normalizeEmailAddress(it.from_addr || it.from || '');
      const subject = (it.subject || '').toLowerCase();
      const emailCount = it.contact_email_count || 0;

      // 1) Manuelle Regel wins
      if(importanceRules && importanceRules.length){
        const m = importanceRules.find(r => r.pattern === fromAddr);
        if(m && m.bucket){
          return m.bucket;
        }
      }

      const newsletterLike = /(no-?reply|newsletter|news@|mailer@|noreply)/.test(fromAddr) ||
                             subject.includes('newsletter') || subject.includes('angebote') || subject.includes('sale');

      // Sehr unwichtig: klare Newsletter / No-Reply / Massenmails
      if(newsletterLike){
        persistAutoImportanceRule(fromAddr, 'unwichtig');
        return 'unwichtig';
      }

      // Fokus: eigene Domain oder viele Nachrichten von diesem Kontakt
      if(fromAddr.includes('@neckattack.') || emailCount >= 3){
        persistAutoImportanceRule(fromAddr, 'focus');
        return 'focus';
      }

      // Rest: normal
      persistAutoImportanceRule(fromAddr, 'normal');
      return 'normal';
    }

    // Speichert eine automatisch getroffene Wichtigkeits-Entscheidung als Regel,
    // falls noch keine manuelle Regel f√ºr diesen Absender existiert.
    function persistAutoImportanceRule(fromAddr, bucket){
      if(!fromAddr || !bucket) return;
      const addr = normalizeEmailAddress(fromAddr);
      if(!addr) return;
      // Wenn bereits eine Regel f√ºr diesen Absender existiert, nichts tun
      if(importanceRules && importanceRules.some(r => r.pattern === addr)) return;

      importanceRules = (importanceRules || []).concat([{ pattern: addr, bucket }]);
      try{
        localStorage.setItem('importance_rules', JSON.stringify(importanceRules));
      }catch(_e_ls_auto){ }

      // Asynchron zum Server schicken (fire & forget)
      try{
        fetch('/api/emails/importance-rules', {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ from_addr: addr, bucket })
        }).catch(() => {});
      }catch(_e_auto){ }
    }

    // Datumsformatierung f√ºr die Inbox-Liste rein auf Basis der deutschen Datumsstrings
    // Erwartete Eingabe z.B.: "09.01.2026 21:32" oder "09.01. 21:32" oder "09.01.2026"
    // - Heute: HH:MM (aus dem String extrahiert)
    // - Gestern: 'gestern'
    // - √Ñlter: dd.MM. (ohne Jahr)
    function formatListDate(raw){
      if(!raw) return '';
      const cleaned = String(raw).trim();

      const now = new Date();
      const ddNow = String(now.getDate()).padStart(2, '0');
      const mmNow = String(now.getMonth() + 1).padStart(2, '0');
      const yyyyNow = String(now.getFullYear());

      const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      const ddY = String(yesterday.getDate()).padStart(2, '0');
      const mmY = String(yesterday.getMonth() + 1).padStart(2, '0');
      const yyyyY = String(yesterday.getFullYear());

      const todayKeyFull = `${ddNow}.${mmNow}.${yyyyNow}`;
      const todayKeyShort = `${ddNow}.${mmNow}.`;
      const yKeyFull = `${ddY}.${mmY}.${yyyyY}`;
      const yKeyShort = `${ddY}.${mmY}.`;

      // Heute: Datumsteil entspricht heute -> Uhrzeit rausziehen
      if(cleaned.startsWith(todayKeyFull) || cleaned.startsWith(todayKeyShort)){
        const mTime = /(\d{1,2}:\d{2})$/.exec(cleaned);
        if(mTime){
          return mTime[1];
        }
        return 'heute';
      }

      // Gestern: Datumsteil entspricht gestern
      if(cleaned.startsWith(yKeyFull) || cleaned.startsWith(yKeyShort)){
        return 'gestern';
      }

      // Fallback: immer kurzes Datum dd.MM.
      const mDate = /^([0-3]\d)\.([0-1]\d)\./.exec(cleaned);
      if(mDate){
        return `${mDate[1]}.${mDate[2]}.`;
      }
      return cleaned;
    }

    function setupInboxFilterToggle(){
      const list = document.getElementById('list');
      if(!list) return;
      // Toggle soll innerhalb der linken Listenspalte direkt √ºber den Items sitzen
      if(document.getElementById('inbox_filter_toggle')) return;
      const toggle = document.createElement('div');
      toggle.id = 'inbox_filter_toggle';
      // Sticky am oberen Rand der Listenspalte halten
      toggle.style.cssText = 'position:sticky; top:0; z-index:5; display:flex; justify-content:space-between; gap:8px; align-items:center; padding:4px 8px 8px 8px; margin:0 0 4px 0; font-size:12px; background:#ffffff; border-bottom:1px solid var(--border);';
      toggle.innerHTML = `
      <div id="inbox_bucket_group" style="display:inline-flex; background:#e5e7eb; border-radius:999px; padding:2px; flex:1;">
        <button id="filter_focus" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:#fff; color:#111827; font-weight:600;">Fokus</button>
        <button id="filter_normal" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:transparent; color:#4b5563;">Normal</button>
        <button id="filter_other" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:transparent; color:#4b5563;">Unwichtig</button>
        <button id="filter_all" type="button" style="border:0; padding:4px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:transparent; color:#4b5563;">Alle</button>
      </div>
      <div style="position:relative; margin-left:auto;">
        <button id="answer_filter_toggle" type="button" style="border:0; display:inline-flex; align-items:center; justify-content:center; padding:0 10px; height:28px; border-radius:999px; cursor:pointer; background:#e5e7eb; color:#111827;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <line x1="21" y1="4" x2="14" y2="4" />
            <line x1="10" y1="4" x2="3" y2="4" />
            <line x1="21" y1="12" x2="12" y2="12" />
            <line x1="8" y1="12" x2="3" y2="12" />
            <line x1="21" y1="20" x2="16" y2="20" />
            <line x1="12" y1="20" x2="3" y2="20" />
            <line x1="14" y1="2" x2="14" y2="6" />
            <line x1="8" y1="10" x2="8" y2="14" />
            <line x1="16" y1="18" x2="16" y2="22" />
          </svg>
          <span id="answer_filter_label" style="display:none;">Alle E-Mails</span>
        </button>
        <div id="answer_filter_menu" style="position:absolute; top:36px; right:0; background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 8px 20px rgba(15,23,42,0.2); padding:4px 0; min-width:150px; font-size:12px; z-index:10; display:none; color:#111827;">
          <button data-answer-value="all" type="button" style="width:100%; text-align:left; padding:6px 10px; border:0; background:transparent; cursor:pointer; display:flex; align-items:center; gap:6px; color:#111827;">
            <span class="answer_filter_check" style="width:14px; text-align:center; font-size:11px;">‚úì</span>
            <span>Alle E-Mails</span>
          </button>
          <button data-answer-value="unanswered" type="button" style="width:100%; text-align:left; padding:6px 10px; border:0; background:transparent; cursor:pointer; display:flex; align-items:center; gap:6px; color:#111827;">
            <span class="answer_filter_check" style="width:14px; text-align:center; font-size:11px; opacity:.2;">‚úì</span>
            <span>Unbeantwortet</span>
          </button>
          <button data-answer-value="answered" type="button" style="width:100%; text-align:left; padding:6px 10px; border:0; background:transparent; cursor:pointer; display:flex; align-items:center; gap:6px; color:#111827;">
            <span class="answer_filter_check" style="width:14px; text-align:center; font-size:11px; opacity:.2;">‚úì</span>
            <span>Beantwortet</span>
          </button>
        </div>
      </div>
      `;
      // In die Listenspalte einf√ºgen, direkt vor dem ersten Inhalt
      list.insertBefore(toggle, list.firstChild);
      const btnFocus = document.getElementById('filter_focus');
      const btnNormal = document.getElementById('filter_normal');
      const btnOther = document.getElementById('filter_other');
      const btnAll = document.getElementById('filter_all');
      const answerToggle = document.getElementById('answer_filter_toggle');
      const answerLabel = document.getElementById('answer_filter_label');
      const answerMenu = document.getElementById('answer_filter_menu');
      const folderSelect = document.getElementById('folder_select');
      const updateButtons = () => {
        // Fokus
        if(inboxFilter === 'focus'){
          btnFocus.style.background = '#fff';
          btnFocus.style.color = '#111827';
          btnFocus.style.fontWeight = '600';
        } else {
          btnFocus.style.background = 'transparent';
          btnFocus.style.color = '#4b5563';
          btnFocus.style.fontWeight = '400';
        }
        // Normal
        if(inboxFilter === 'normal'){
          btnNormal.style.background = '#fff';
          btnNormal.style.color = '#111827';
          btnNormal.style.fontWeight = '600';
        } else {
          btnNormal.style.background = 'transparent';
          btnNormal.style.color = '#4b5563';
          btnNormal.style.fontWeight = '400';
        }
        // Unwichtig
        if(inboxFilter === 'unwichtig'){
          btnOther.style.background = '#fff';
          btnOther.style.color = '#111827';
          btnOther.style.fontWeight = '600';
        } else {
          btnOther.style.background = 'transparent';
          btnOther.style.color = '#4b5563';
          btnOther.style.fontWeight = '400';
        }

        // Alle Buckets
        if(inboxFilter === 'all'){
          if(btnAll){
            btnAll.style.background = '#fff';
            btnAll.style.color = '#111827';
            btnAll.style.fontWeight = '600';
          }
        } else if(btnAll){
          btnAll.style.background = 'transparent';
          btnAll.style.color = '#4b5563';
          btnAll.style.fontWeight = '400';
        }

        // Antwort-Filter (Alle E-Mails vs. Unbeantwortet) im Dropdown markieren
        if(answerMenu){
          const options = answerMenu.querySelectorAll('button[data-answer-value]');
          options.forEach(btn => {
            const val = btn.getAttribute('data-answer-value');
            const check = btn.querySelector('.answer_filter_check');
            const active = val === inboxAnswerFilter;
            if(check){
              check.style.opacity = active ? '1' : '.2';
            }
            btn.style.background = active ? '#f3f4f6' : 'transparent';
          });
        }
      };
      btnFocus.addEventListener('click', () => { inboxFilter = 'focus'; updateButtons(); renderInboxList(); });
      btnNormal.addEventListener('click', () => { inboxFilter = 'normal'; updateButtons(); renderInboxList(); });
      btnOther.addEventListener('click', () => { inboxFilter = 'unwichtig'; updateButtons(); renderInboxList(); });
      if(btnAll){
        btnAll.addEventListener('click', () => { inboxFilter = 'all'; updateButtons(); renderInboxList(); });
      }

      if(answerToggle && answerMenu){
        // Icon √∂ffnet/schlie√üt das Dropdown
        answerToggle.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const isOpen = answerMenu.style.display === 'block';
          answerMenu.style.display = isOpen ? 'none' : 'block';
        });

        // Auswahl im Dropdown setzt den Filterzustand
        answerMenu.querySelectorAll('button[data-answer-value]').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const val = btn.getAttribute('data-answer-value') || 'all';
            inboxAnswerFilter = val;
            answerMenu.style.display = 'none';
            updateButtons();
            renderInboxList();
          });
        });

        // Klick au√üerhalb schlie√üt das Men√º
        document.addEventListener('click', (ev) => {
          if(!answerMenu.contains(ev.target) && ev.target !== answerToggle && !answerToggle.contains(ev.target)){
            answerMenu.style.display = 'none';
          }
        });
      }

      // Folder-Select mit verf√ºgbaren Ordnern f√ºllen
      if(folderSelect){
        updateFolderSelectOptions();
        folderSelect.addEventListener('change', () => {
          currentFolder = folderSelect.value || 'inbox';
          // Beim Ordnerwechsel neu laden, damit DB/Server-Zahlen stimmen
          loadInbox();
        });
      }

      // Reload-Button: expliziten IMAP-Sync ansto√üen und danach die Ansicht aktualisieren
      const reloadBtn = document.getElementById('reload');
      if(reloadBtn){
        reloadBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          // Erneuten Auto-Sync erlauben und im Hintergrund alle Ordner synchronisieren
          autoSyncFinishedOnce = false;
          autoSyncAllFoldersBackground();
        });
      }
      updateButtons();
    }

    function updateFolderSelectOptions(){
      const folderSelect = document.getElementById('folder_select');
      if(!folderSelect) return;
      folderSelect.innerHTML = '';
      // Wenn noch keine Folders geladen wurden, Standard-Eintr√§ge setzen
      let folders = availableFolders && availableFolders.length ? [...availableFolders] : [
        { db_key: 'inbox', label: 'Posteingang' }
      ];
      // "Alle Ordner" immer als letzten Eintrag anh√§ngen
      folders.push({ db_key: 'all', label: 'Alle Ordner' });
      for(const f of folders){
        const opt = document.createElement('option');
        opt.value = f.db_key;
        opt.textContent = f.label;
        if(f.db_key === currentFolder){ opt.selected = true; }
        folderSelect.appendChild(opt);
      }
    }

    async function loadFoldersForCurrentAccount(){
      if(!currentAccountId){ return; }
      const cacheKey = String(currentAccountId);
      if(accountFolderCache[cacheKey]){
        availableFolders = accountFolderCache[cacheKey];
        updateFolderSelectOptions();
        return;
      }
      try{
        const res = await fetch(`/api/emails/folders?account_id=${encodeURIComponent(currentAccountId)}`, {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(!data.__ok || !Array.isArray(data.folders)){
          return;
        }
        availableFolders = (data.folders || []).map(f => ({
          db_key: f.db_key || (f.imap_name || '').toLowerCase() || 'inbox',
          label: f.label || f.imap_name || 'Ordner',
          imap_name: f.imap_name || 'INBOX'
        }));
        accountFolderCache[cacheKey] = availableFolders;
        // Standard-Folder, falls currentFolder noch nicht gesetzt ist
        if(!currentFolder || currentFolder === 'inbox'){
          const inboxFolder = availableFolders.find(f => f.db_key === 'inbox') || availableFolders[0];
          if(inboxFolder){ currentFolder = inboxFolder.db_key; }
        }
        updateFolderSelectOptions();
      }catch(_){
        // Wenn Ordnerliste nicht geladen werden kann, bleiben wir bei Default
      }
    }

    function getImapFolderForSync(){
      // Wenn "Alle Ordner" gew√§hlt ist, synchronisieren wir aktuell nur INBOX
      if(currentFolder === 'all'){
        return 'INBOX';
      }
      const f = (availableFolders || []).find(x => x.db_key === currentFolder);
      if(f && f.imap_name){
        return f.imap_name;
      }
      // Harte Fallback-Strategie: immer INBOX, wenn nichts Sinnvolles gefunden wird
      return 'INBOX';
    }

    // Automatischer Hintergrund-Sync √ºber alle relevanten Ordner
    let isAutoSyncRunning = false;
    let autoSyncAbort = false;
    let autoSyncStatusInterval = null;
    let autoSyncFinishedOnce = false;

    async function autoSyncAllFoldersBackground(){
      if(isAutoSyncRunning || autoSyncFinishedOnce){ return; }
      if(!currentAccountId){ return; }
      const status = document.getElementById('status');
      if(status){ status.textContent = 'Hintergrund-Sync gestartet‚Ä¶'; }

      // Kleine Status-Animation im 5-Sekunden-Rhythmus, bis die ersten Zahlen
      // vom Server kommen oder der Sync beendet ist.
      if(autoSyncStatusInterval){
        clearInterval(autoSyncStatusInterval);
        autoSyncStatusInterval = null;
      }
      autoSyncStatusInterval = setInterval(() => {
        if(!isAutoSyncRunning){
          clearInterval(autoSyncStatusInterval);
          autoSyncStatusInterval = null;
          return;
        }
        const s = document.getElementById('status');
        if(!s) return;
        const variants = [
          'Hintergrund-Sync gestartet‚Ä¶',
          'Hintergrund-Sync l√§uft‚Ä¶',
          'Hintergrund-Sync pr√ºft weitere Ordner‚Ä¶'
        ];
        const idx = Math.floor(Date.now() / 5000) % variants.length;
        // Nur √ºberschreiben, solange noch keine detaillierten Zahlen angezeigt werden
        if(!/E-Mails im Ordner/.test(s.textContent)){
          s.textContent = variants[idx];
        }
      }, 5000);

      isAutoSyncRunning = true;
      autoSyncAbort = false;
      let anySyncedInRun = false;

      try{
        // Sicherstellen, dass wir eine frische Ordnerliste haben
        await loadFoldersForCurrentAccount();
        const folders = (availableFolders || []).filter(f => {
          const key = (f.db_key || '').toLowerCase();
          // Spam / Trash standardm√§√üig √ºberspringen
          if(key === 'spam' || key === 'trash'){ return false; }
          return true;
        });

        const foldersToSync = folders.length ? folders : [{ imap_name: 'INBOX', db_key: 'inbox', label: 'Posteingang' }];

        for(const f of foldersToSync){
          if(autoSyncAbort){ break; }
          const imapFolder = f.imap_name || 'INBOX';
          // Pro Ordner einige 200er-Batches ziehen, bis nichts mehr neu kommt
          for(let i=0; i<5; i++){
            if(autoSyncAbort){ break; }
            try{
              const syncRes = await fetch('/api/emails/sync', {
                method: 'POST',
                headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                body: JSON.stringify({ limit: 200, account_id: currentAccountId, folder: imapFolder })
              });
              const syncData = await parseJsonSafe(syncRes);
              if(!syncData.__ok){
                break;
              }
              const syncedCount = typeof syncData.synced === 'number' ? syncData.synced : 0;
              if(status && typeof syncData.total_on_server === 'number'){
                // Sobald wir echte Zahlen haben, die kleine Text-Animation beenden
                if(autoSyncStatusInterval){
                  clearInterval(autoSyncStatusInterval);
                  autoSyncStatusInterval = null;
                }

                // 2. Call im Hintergrund: nur historische Themen nachladen (ohne skip_history), damit die UI bereits steht
                fetch(`/api/emails/${t.id}/reply-prep?debug_raw=1`, { headers: getAuthHeaders() })
                  .then(res => parseJsonSafe(res))
                  .then(histData => {
                    const histTopics = histData.topics || [];
                    if(!histTopics.length) return;

                    // Historische Themen-HTML wie oben erzeugen und nur in den Container schreiben
                    const histContainer = prepTopics.querySelector('#historical_topics_container');
                    const headerExists = prepTopics.querySelector('#historical_topics_toggle');
                    const historicalHtml2 = histTopics.map(tp => {
                      const ageTxt = (tp.age_days != null) ? ` ¬∑ seit ${tp.age_days} Tagen` : '';
                      const meta = `${tp.email_count || 0} E-Mails${ageTxt}`;
                      const optHtml = (tp.reply_options || []).map((opt, idx) => {
                        return `<button class="reply-opt-btn" data-topic-id="${tp.id}" data-opt-id="${opt.id}" data-snippet="${encodeURIComponent(opt.snippet || '')}" style="border:0; padding:3px 6px; border-radius:4px; font-size:11px; margin:2px 4px 2px 0; cursor:pointer; background:#e5e7eb; color:#374151;">${escapeHtml(opt.label || '')}</button>`;
                      }).join('');
                      const mailsHtml = (tp.emails || []).slice(0,5).map(em => {
                        const text = `${em.received_at || ''} ‚Äì ${em.subject || ''}`;
                        return `<div style="font-size:11px; cursor:pointer; text-decoration:underline;" data-email-id="${em.id}" class="reply-prep-email-link">${escapeHtml(text)}</div>`;
                      }).join('');
                      return `
                        <div class="reply-prep-topic" data-kind="historical" data-topic-id="${tp.id}" style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#f9fafb; border:1px solid #e5e7eb; position:relative;">
                          <span class="reply-prep-close" data-kind="historical" data-topic-id="${tp.id}" style="position:absolute; right:6px; top:4px; color:#b91c1c; font-weight:bold; cursor:pointer;">√ó</span>
                          <div style="font-size:12px; font-weight:500; margin-bottom:2px;">${escapeHtml(tp.label || '(ohne Titel)')}</div>
                          <div class="sub" style="font-size:11px; margin-bottom:4px;">${escapeHtml(meta)}</div>
                          <div style="margin-bottom:4px;">${optHtml}</div>
                          ${mailsHtml ? `<div style="font-size:11px; margin-top:2px;"><span class="muted">Relevante E-Mails:</span></div>${mailsHtml}` : ''}
                          <div style="margin-top:4px; border-top:1px dashed #e5e7eb; padding-top:4px;">
                            <div class="sub" style="font-size:10px; margin-bottom:2px;">Manuelle Antwort (Stichworte):</div>
                            <div style="display:flex; gap:4px; align-items:flex-start;">
                              <textarea class="reply-manual-note" data-topic-label="${escapeHtml(tp.label || '')}" data-topic-expl="" rows="2" placeholder="Eigene Stichworte zur Antwort..." style="flex:1; font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid #e5e7eb; resize:vertical;"></textarea>
                              <button class="reply-manual-btn" data-kind="historical" data-topic-id="${tp.id}" style="border:0; padding:4px 6px; border-radius:4px; font-size:11px; cursor:pointer; background:#6366f1; color:#ffffff; white-space:nowrap;">Manuell formulieren</button>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('');

                    let container = histContainer;
                    if(!container){
                      // Header + Container neu einf√ºgen, falls beim ersten Call keine Topics da waren
                      prepTopics.insertAdjacentHTML('beforeend', `
                        <div class="sub" style="font-size:10px; text-transform:uppercase; letter-spacing:0.03em; margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                          <span>Offene Themen aus bisherigen E-Mails</span>
                          <button id="historical_topics_toggle" type="button" style="border:0; padding:3px 8px; border-radius:999px; font-size:10px; cursor:pointer; background:#e5e7eb; color:#374151; white-space:nowrap;">anzeigen</button>
                        </div>
                        <div id="historical_topics_container" style="margin-top:4px; display:none;"></div>
                      `);
                      container = prepTopics.querySelector('#historical_topics_container');
                      const histToggle2 = prepTopics.querySelector('#historical_topics_toggle');
                      if(histToggle2 && container){
                        histToggle2.addEventListener('click', () => {
                          const isHidden = container.style.display === 'none' || !container.style.display;
                          container.style.display = isHidden ? 'block' : 'none';
                          histToggle2.textContent = isHidden ? 'ausblenden' : 'anzeigen';
                        });
                      }
                    }
                    if(container){
                      container.innerHTML = historicalHtml2;
                    }
                  }).catch(() => {});
                const totalOnServer = syncData.total_on_server;
                const inDb = typeof syncData.total_in_db_folder === 'number'
                  ? syncData.total_in_db_folder
                  : (typeof syncData.total_in_db === 'number' ? syncData.total_in_db : 0);
                const pct = totalOnServer > 0 ? Math.round((inDb / totalOnServer) * 100) : 0;
                status.textContent = `${inDb.toLocaleString('de-DE')} / ${totalOnServer.toLocaleString('de-DE')} E-Mails im Ordner "${f.label || f.db_key}" synchronisiert (${pct}%)`;
              }
              // Wenn nichts Neues mehr kam, zum n√§chsten Ordner springen
              if(syncedCount <= 0){
                break;
              }
              anySyncedInRun = true;
            }catch(_){
              break;
            }
          }
        }
      }finally{
        // Wenn in diesem Lauf keine einzige neue Mail synchronisiert wurde und
        // der Vorgang nicht aktiv abgebrochen wurde, markieren wir den Auto-Sync
        // als abgeschlossen, damit er nicht erneut gestartet wird.
        if(!autoSyncAbort && !anySyncedInRun){
          autoSyncFinishedOnce = true;
        }

        isAutoSyncRunning = false;
        autoSyncAbort = false;
        if(autoSyncStatusInterval){
          clearInterval(autoSyncStatusInterval);
          autoSyncStatusInterval = null;
        }
        // Danach aktuelle Ansicht neu laden
        try {
          await loadInbox();
        } catch(_) {}
      }
    }

    function renderInboxList(){
      const list = document.getElementById('list');
      const status = document.getElementById('status');
      if(!list) return;
      const toggle = document.getElementById('inbox_filter_toggle');
      const bucketGroup = document.getElementById('inbox_bucket_group');
      const answerToggle = document.getElementById('answer_filter_toggle');
      // Bucket-Toggle (Fokus/Normal/Unwichtig) nur im Posteingang anzeigen,
      // Ordner-Dropdown aber immer sichtbar lassen. Au√üerhalb des Posteingangs
      // bleibt der Platz erhalten, damit das Dropdown nicht springt.
      if(bucketGroup){
        if(currentFolder === 'inbox'){
          bucketGroup.style.visibility = 'visible';
          bucketGroup.style.pointerEvents = 'auto';
        } else {
          bucketGroup.style.visibility = 'hidden';
          bucketGroup.style.pointerEvents = 'none';
        }
      }
      // Antwort-Filter nur im Posteingang und ggf. Archiv sinnvoll anzeigen
      if(answerToggle){
        if(currentFolder === 'inbox' || currentFolder === 'archive'){
          answerToggle.style.visibility = 'visible';
          answerToggle.style.pointerEvents = 'auto';
        } else {
          answerToggle.style.visibility = 'hidden';
          answerToggle.style.pointerEvents = 'none';
        }
      }
      // Nur die E-Mail-Items unterhalb des Toggles leeren
      if(toggle){
        while(list.lastChild && list.lastChild !== toggle){
          list.removeChild(list.lastChild);
        }
      } else {
        list.innerHTML = '';
      }
      if(!inboxEmails || !inboxEmails.length){
        // Toggle-Leiste sichtbar lassen, nur darunter einen Hinweis anzeigen
        if(toggle){
          while(list.lastChild && list.lastChild !== toggle){
            list.removeChild(list.lastChild);
          }
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'sub';
          emptyDiv.style.padding = '20px';
          emptyDiv.style.textAlign = 'center';
          emptyDiv.textContent = 'Keine E-Mails in dieser Ansicht.';
          list.appendChild(emptyDiv);
        } else {
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'sub';
          emptyDiv.style.padding = '20px';
          emptyDiv.style.textAlign = 'center';
          emptyDiv.textContent = 'Keine E-Mails in dieser Ansicht.';
          list.appendChild(emptyDiv);
        }
        if(status) status.textContent = '';
        return;
      }
      
      const q = (inboxSearchQuery || '').trim().toLowerCase();

      let baseFiltered;
      if(currentFolder !== 'inbox' || q || inboxFilter === 'all'){
        // In anderen Ordnern (Gesendet, etc.), bei aktiver Suche
        // oder explizit gew√§hltem "Alle" keine Bucket-Filterung anwenden
        baseFiltered = inboxEmails.slice();
      } else {
        // Nur im Posteingang ohne aktive Suche nach Buckets filtern
        baseFiltered = inboxEmails.filter(it => {
          const bucket = getImportanceBucket(it);
          if(inboxFilter === 'focus') return bucket === 'focus';
          if(inboxFilter === 'unwichtig') return bucket === 'unwichtig';
          // normal: nur Mails mit Bucket "normal" anzeigen
          return bucket === 'normal';
        });
      }

      // Antwort-Filter anwenden basierend auf persistenter Antwort-Info (is_replied):
      //  - all: keine Einschr√§nkung
      //  - unanswered: Mails ohne is_replied
      //  - answered: Mails, die bereits beantwortet wurden (is_replied === 1)
      // Wichtig: Bei aktiver Suche (q != '') KEIN Antwort-Filtering, damit alle
      // Suchtreffer sichtbar sind, unabh√§ngig von beantwortet/unbeantwortet.
      let answerFiltered = baseFiltered;
      if(!q){
        if(inboxAnswerFilter === 'unanswered'){
          answerFiltered = baseFiltered.filter(it => !it.is_replied);
        } else if(inboxAnswerFilter === 'answered'){
          answerFiltered = baseFiltered.filter(it => !!it.is_replied);
        }
      }

      // Wichtig: Wenn eine Suche aktiv ist (q != ''), haben wir die eigentliche
      // Textsuche bereits im Backend gemacht (/api/emails/search sucht in
      // From/To/Subject/Body). In diesem Fall sollen wir die vom Server
      // gelieferten Ergebnisse NICHT noch einmal clientseitig nach From/To/
      // Betreff filtern, sonst gehen Treffer verloren, die nur im Body
      // vorkommen (z.B. "kasia" im Mailtext).
      const filtered = q ? answerFiltered.slice() : answerFiltered;
      if(!filtered.length){
        // Toggle-Leiste sichtbar lassen, nur darunter einen Hinweis anzeigen
        if(toggle){
          while(list.lastChild && list.lastChild !== toggle){
            list.removeChild(list.lastChild);
          }
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'sub';
          emptyDiv.style.padding = '20px';
          emptyDiv.style.textAlign = 'center';
          emptyDiv.textContent = 'Keine E-Mails in dieser Ansicht.';
          list.appendChild(emptyDiv);
        } else {
          list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Keine E-Mails in dieser Ansicht.</div>';
        }
        if(status){
          try{
            status.textContent = '0 E-Mails in dieser Ansicht';
          }catch(_e_stat0){ }
        }
        return;
      }
      if(status){
        try{
          status.textContent = `${filtered.length.toLocaleString('de-DE')} E-Mails in dieser Ansicht`;
        }catch(_e_stat){ }
      }

      for(const it of filtered){
        const div = document.createElement('div');
        div.className = 'item' + (!it.is_read ? ' unseen' : '');
        div.dataset.uid = it.uid;
        const bucket = getImportanceBucket(it);

        const isAnswered = !!it.is_replied;
        const hasAttach = !!it.has_attachments;
        const attachIcon = hasAttach
          ? (window.getIconSvg ? window.getIconSvg('paperclip', { size: 14 }) : 'üìé')
          : '';

        const fromLabel = escapeHtml(it.from || '');
        const dateLabel = escapeHtml(formatListDate(it.date || ''));

        // In der Ansicht "normal" immer beide Pfeile anzeigen,
        // in den Extremansichten nur Up bzw. Down.
        let canUp = true;
        let canDown = true;
        if(inboxFilter === 'focus'){
          canUp = false;
          canDown = bucket !== 'unwichtig';
        } else if(inboxFilter === 'unwichtig'){
          canDown = false;
          canUp = bucket !== 'focus';
        } else {
          // normal: immer beide Pfeile sichtbar
          canUp = true;
          canDown = true;
        }

        div.innerHTML = `
  <div class="group" style="position:relative; display:flex; align-items:center; justify-content:space-between; gap:8px;">
    <div style="flex:1 1 auto; min-width:0; padding-right:80px;">
      <div class="subject" style="display:flex; align-items:center; gap:6px;">
        ${attachIcon ? `<span class="item-attach-indicator" title="Anhang vorhanden" style="display:inline-flex; align-items:center; justify-content:center; color:#4b5563;">${attachIcon}</span>` : ''}
        <span>${escapeHtml(it.subject || '(ohne Betreff)')}</span>
      </div>
      <div class="meta flex items-center justify-between text-xs text-slate-500">
        <span>${fromLabel}</span>
        <span>${dateLabel}${isAnswered ? ' ‚Ü©Ô∏é' : ''}</span>
      </div>
    </div>
    <div class="item-actions-wrapper" style="position:absolute; top:-16px; bottom:-16px; right:-24px; left:auto; display:flex; align-items:center; justify-content:flex-end;">
      <div class="item-actions-inner" style="display:flex; flex-direction:row-reverse; align-items:center; justify-content:flex-end; gap:8px; padding:0 10px; height:100%; border-radius:12px; background:rgba(255,255,255,0.96); border:1px solid #e2e8f0; box-shadow:0 4px 10px rgba(15,23,42,0.08);">
        <div class="item-actions" style="display:flex; align-items:center; gap:8px; height:100%;">
          <button class="item-contact" type="button" title="Kontakt √∂ffnen" style="display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#0f172a; padding:0; cursor:pointer;"></button>
          <button class="item-read-toggle" type="button" title="Als gelesen/ungelesen markieren" style="display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#0f172a; padding:0; cursor:pointer;"></button>
          <button class="item-archive" type="button" title="Archivieren" style="display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#0f172a; padding:0; cursor:pointer;"></button>
        </div>
        <div class="importance-controls" data-bucket="${bucket}" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; font-size:10px; margin-left:4px;">
          ${canUp ? `<button class="imp-up" type="button" title="Wichtiger" style="display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#0f172a; padding:0; cursor:pointer;">${window.getIconSvg ? window.getIconSvg('chevron-up', {size:12}) : '‚Üë'}</button>` : ''}
          ${canDown ? `<button class="imp-down" type="button" title="Unwichtiger" style="display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; color:#0f172a; padding:0; cursor:pointer;">${window.getIconSvg ? window.getIconSvg('chevron-down', {size:12}) : '‚Üì'}</button>` : ''}
        </div>
      </div>
    </div>
  </div>
`;

        // Klick auf Zeile √∂ffnet Mail, aber Pfeile und Aktions-Icons sollen nur ihre eigene Funktion ausf√ºhren
        div.addEventListener('click', (ev) => {
          const target = ev.target;
          if(!target) return;
          if(target.classList.contains('imp-up') || target.classList.contains('imp-down') ||
             target.classList.contains('item-contact') || target.classList.contains('item-read-toggle')){
            return;
          }
          selectItem(it.uid, div);
        });

        // Hover: Aktionsleiste per JS ein-/ausblenden und von rechts einsliden
        const actionsWrapper = div.querySelector('.item-actions-wrapper');
        const actionsInner = div.querySelector('.item-actions-inner');
        if(actionsWrapper && actionsInner){
          actionsInner.style.transform = 'translateX(100%)';
          actionsInner.style.opacity = '0';
          actionsInner.style.pointerEvents = 'none';
          actionsInner.style.transition = 'transform 0.15s ease-out, opacity 0.15s ease-out';
          div.addEventListener('mouseenter', () => {
            actionsInner.style.transform = 'translateX(0)';
            actionsInner.style.opacity = '1';
            actionsInner.style.pointerEvents = 'auto';
          });
          div.addEventListener('mouseleave', () => {
            actionsInner.style.transform = 'translateX(100%)';
            actionsInner.style.opacity = '0';
            actionsInner.style.pointerEvents = 'none';
          });
        }

        // Rechtsklick: kleines Kontextmen√º √∂ffnen
        div.addEventListener('contextmenu', (ev) => {
          ev.preventDefault();
          const menu = ensureInboxContextMenu();
          if(!menu) return;
          inboxContextMenuCurrentItem = { email: it, row: div };
          const btn = menu.querySelector('#ctx_toggle_read');
          if(btn){
            const isRead = !!it.is_read;
            btn.textContent = isRead ? 'Als ungelesen markieren' : 'Als gelesen markieren';
          }
          const x = ev.clientX;
          const y = ev.clientY;
          menu.style.left = x + 'px';
          menu.style.top = y + 'px';
          menu.style.display = 'block';
        });

        const controls = div.querySelector('.importance-controls');
        if(controls){
          const fromAddr = normalizeEmailAddress(it.from_addr || it.from || '');

          const applyBucketChange = (newBucket) => {
            if(!newBucket) return;
            // Lokal updaten
            importanceRules = (importanceRules || []).filter(r => r.pattern !== fromAddr);
            importanceRules.push({pattern: fromAddr, bucket: newBucket});

            // Auch im localStorage spiegeln, damit √Ñnderungen einen Reload √ºberleben
            try{
              localStorage.setItem('importance_rules', JSON.stringify(importanceRules));
            }catch(_e){ }

            // Zum Server schicken (fire & forget)
            try{
              fetch('/api/emails/importance-rules', {
                method: 'POST',
                headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                body: JSON.stringify({ from_addr: fromAddr, bucket: newBucket })
              }).catch(() => {});
            }catch(_){ }

            // Liste mit neuer Wichtigkeit neu rendern
            renderInboxList();
          };

          const upBtn = controls.querySelector('.imp-up');
          const downBtn = controls.querySelector('.imp-down');
          if(upBtn){
            upBtn.addEventListener('click', (ev) => {
              ev.stopPropagation();
              const b = getImportanceBucket(it);
              const next = (b === 'unwichtig') ? 'normal' : 'focus';
              applyBucketChange(next);
            });
          }
          if(downBtn){
            downBtn.addEventListener('click', (ev) => {
              ev.stopPropagation();
              const b = getImportanceBucket(it);
              const next = (b === 'focus') ? 'normal' : 'unwichtig';
              applyBucketChange(next);
            });
          }
        }

        // Aktions-Icons: Kontakt √∂ffnen und gelesen/ungelesen toggeln
        const contactBtn = div.querySelector('.item-contact');
        if(contactBtn){
          if(window.getIconSvg){
            contactBtn.innerHTML = window.getIconSvg('user', {size:18});
          } else {
            contactBtn.textContent = 'üë§';
          }
        }
        if(contactBtn && it.contact_id){
          contactBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const name = it.contact_name || it.from || (it.from_addr || '');
            const email = it.from_addr || it.from || '';
            openContactDetailModal(it.contact_id, name, email);
          });
        }

        const readToggleBtn = div.querySelector('.item-read-toggle');
        if(readToggleBtn){
          if(window.getIconSvg){
            readToggleBtn.innerHTML = window.getIconSvg('eye', {size:18});
          } else {
            readToggleBtn.textContent = 'üëÅÔ∏è';
          }
          readToggleBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const newSeen = !it.is_read;
            try{
              await fetch('/api/emails/seen', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: it.uid, seen: newSeen })
              });
              it.is_read = newSeen;
              if(newSeen){
                div.classList.remove('unseen');
              } else {
                if(!div.classList.contains('unseen')) div.classList.add('unseen');
              }
              renderInboxList();
            }catch(_e_seen){}
          });
        }

        const archiveBtn = div.querySelector('.item-archive');
        if(archiveBtn){
          if(window.getIconSvg){
            archiveBtn.innerHTML = window.getIconSvg('archive', {size:18});
          } else {
            archiveBtn.textContent = 'üì•';
          }
        }
        if(archiveBtn && currentFolder === 'inbox'){
          archiveBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            try{
              await fetch('/api/emails/move', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: it.uid, target_folder: 'archive' })
              });
              inboxEmails = inboxEmails.filter(e => e.uid !== it.uid);
              renderInboxList();
            }catch(_e_move){}
          });
        }

        list.appendChild(div);
      }
    }

    // Suche nach Absendername / -E-Mail initialisieren und Build-Info laden
    document.addEventListener('DOMContentLoaded', () => {
      // Build-Info aus Backend holen, damit der Header immer den aktuellen Commit zeigt.
      try{
        fetch('/api/build-info')
          .then(res => res.ok ? res.json() : null)
          .then(data => {
            if(!data || !data.build) return;
            const el = document.getElementById('build_info');
            if(el){ el.textContent = `Build ${data.build}`; }
          })
          .catch(() => {});
      }catch(_e_build){ }

      // Signatur f√ºr den aktuellen User (falls vorhanden) einmalig laden,
      // damit sie sp√§ter automatisch unter die Antwort gesetzt werden kann.
      (async () => {
        try{
          if(typeof getUserEmail !== 'function') return;
          const userEmail = getUserEmail();
          if(!userEmail) return;
          const res = await fetch(`/api/user/email-settings?user_email=${encodeURIComponent(userEmail)}`, {
            headers: getAuthHeaders()
          });
          const data = await parseJsonSafe(res);
          if(data && (data.signature_html || data.signature)){
            currentSignatureHtml = data.signature_html || data.signature || '';
            try{ localStorage.setItem('email_signature_html', currentSignatureHtml || ''); }catch(_e_ls0){}
            return;
          }
        }catch(_e_sig){}

        // Fallback: Signatur aus localStorage laden, falls Server nichts liefert
        try{
          const cachedSig = localStorage.getItem('email_signature_html') || '';
          if(cachedSig){ currentSignatureHtml = cachedSig; }
        }catch(_e_ls_fallback){}
      })();

      const searchInput = document.getElementById('inbox_search');
      if(searchInput){
        searchInput.addEventListener('input', () => {
          inboxSearchQuery = searchInput.value || '';
          const q = (inboxSearchQuery || '').trim();
          if(!q){
            // Zur√ºck zur normalen Listenansicht
            loadInbox();
          } else {
            // DB-basierte Suche √ºber alle synchronisierten Mails im aktuellen Ordner
            searchInbox(q);
          }
        });
      }
    });

    let isLoadingMore = false;
    let currentSearchToken = 0;
    let activeSearchToken = 0;
    let currentSearchQuery = '';
    let currentSignatureHtml = '';

    async function searchInbox(query){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      currentSearchQuery = (query || '').trim();
      const myToken = ++currentSearchToken;
      activeSearchToken = myToken;
      if(status) status.textContent = `Suche nach "${currentSearchQuery}" ‚Ä¶`;
      try{
        if(!currentAccountId){
          await ensureEmailAccountsLoaded();
          if(!currentAccountId){
            if(list) list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Kein E-Mail-Account konfiguriert.</div>';
            if(status) status.textContent = '';
            return;
          }
        }
        const res = await fetch(`/api/emails/search?folder=${encodeURIComponent(currentFolder)}&account_id=${encodeURIComponent(currentAccountId)}&q=${encodeURIComponent(currentSearchQuery)}`, {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(!data || data.error){
          if(status) status.textContent = data && data.error ? data.error : 'Fehler bei der Suche';
          return;
        }
        // Nur noch die Antwort der aktuellsten Suche √ºbernehmen
        if(myToken !== activeSearchToken){
          return;
        }
        inboxEmails = data.emails || [];
        renderInboxList();
        if(status){
          try{
            const total = (data.total || inboxEmails.length) || 0;
            status.textContent = `${total.toLocaleString('de-DE')} Treffer f√ºr "${currentSearchQuery}"`;
          }catch(_e_total){}
        }
      }catch(_e_search){
        if(status) status.textContent = 'Fehler bei der Suche';
      }
    }

    async function loadInbox(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      const hasActiveSearch = !!(currentSearchQuery && currentSearchQuery.trim());
      if(status && !hasActiveSearch){
        status.textContent = 'l√§dt ‚Ä¶';
      }
      // Kleine Ladeanzeige nur, wenn noch keine E-Mails gerendert sind
      if(list && (!inboxEmails || !inboxEmails.length)){
        list.innerHTML = '<div class="sub" style="padding:8px 12px;">Lade E-Mails ‚Ä¶</div>';
      }
      try{
        if(!currentAccountId){
          // Ohne Account keine Anfragen; versuche Accounts zu laden
          await ensureEmailAccountsLoaded();
          if(!currentAccountId){
            list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Kein E-Mail-Account konfiguriert.</div>';
            status.textContent = '';
            return;
          }
        }
        // Load emails from database with current limit
        const res = await fetch(`/api/emails/list?folder=${encodeURIComponent(currentFolder)}&limit=${currentEmailLimit}&account_id=${encodeURIComponent(currentAccountId)}`, {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(!data.__ok){ 
          // Check if user needs to configure email settings
          if(data.error && (data.error.includes('configure email settings') || data.error.includes('IMAP settings'))){
            list.innerHTML = `
              <div style="padding:20px; text-align:center;">
                <div style="font-size:48px; margin-bottom:16px;">üìß</div>
                <div style="font-size:16px; font-weight:600; margin-bottom:8px;">E-Mail-Einstellungen fehlen</div>
                <div class="sub" style="margin-bottom:16px;">Bitte konfigurieren Sie zuerst Ihre IMAP/SMTP-Zugangsdaten</div>
                <button id="setup_email_btn" style="background:#059669; color:#fff; border:0; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px;">‚öôÔ∏è E-Mail-Einstellungen konfigurieren</button>
              </div>
            `;
            document.getElementById('setup_email_btn').addEventListener('click', openEmailSettingsModal);
            status.textContent = '';
            return;
          }
          throw new Error(data.error || 'Inbox-Fehler'); 
        }
        
        // Check if initial sync is needed
        if(data.total_all_folders === 0){
          await showInitialSyncDialog();
          return;
        }
        
        // Store emails f√ºr Grundansicht nur aktualisieren, wenn keine aktive Suche l√§uft
        if(!hasActiveSearch){
          inboxEmails = data.emails || [];
          setupInboxFilterToggle();
          renderInboxList();
        }
        
        // Automatischer Hintergrund-Sync: Button als "Abbrechen" verwenden
        const loadMoreBtn = document.getElementById('load_more_btn');
        const totalInDB = data.total || 0;
        if(!hasActiveSearch && data.can_sync_more && !isAutoSyncRunning && !autoSyncFinishedOnce){
          if(loadMoreBtn){
            loadMoreBtn.style.display = 'inline-flex';
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = window.getIconSvg ? window.getIconSvg('circle-x', {size:18}) : '‚úï';
            loadMoreBtn.title = 'Hintergrund-Sync abbrechen';
            loadMoreBtn.onclick = () => {
              autoSyncAbort = true;
              loadMoreBtn.disabled = true;
              if(status){ status.textContent = 'Synchronisierung wird beendet‚Ä¶'; }
            };
          }
          if(status){
            status.textContent = `${totalInDB.toLocaleString('de-DE')} E-Mails in DB ‚Äì Hintergrund-Sync l√§uft‚Ä¶`;
          }
          // Auto-Sync bewusst "fire and forget" starten
          autoSyncAllFoldersBackground();
        } else {
          if(loadMoreBtn){
            loadMoreBtn.style.display = 'none';
          }
          if(status){
            status.textContent = `${totalInDB.toLocaleString('de-DE')} E-Mails in DB`;
          }
        }
      }catch(e){
        list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${e}</div>`;
        status.textContent = '';
      }
    }

    // Aktualisieren: kurze Serversynchronisation f√ºr den aktuellen Ordner + Reload
    async function refreshInbox(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      if(status) status.textContent = 'Suche nach neuen E-Mails...';
      try{
        if(!currentAccountId){
          await ensureEmailAccountsLoaded();
          if(!currentAccountId){
            if(list) list.innerHTML = '<div class="sub" style="padding:20px; text-align:center;">Kein E-Mail-Account konfiguriert.</div>';
            if(status) status.textContent = '';
            return;
          }
        }
        // Ziehe bis zu 200 neueste E-Mails f√ºr den aktuellen Ordner vom Server
          const syncRes = await fetch('/api/emails/sync', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({ limit: 200, account_id: currentAccountId, folder: getImapFolderForSync() })
          });
        await parseJsonSafe(syncRes); // Fehler werden unten generisch behandelt
      }catch(e){
        // Still, wir zeigen den Fehler beim eigentlichen Reload an
      }
      // Immer Inbox neu laden, um ggf. neue DB-Eintr√§ge zu zeigen
      await loadInbox();
    }

    // Einfaches Infinite-Scroll: wenn der Nutzer in der linken Liste fast unten ist,
    // automatisch mehr E-Mails nachladen (Limit erh√∂hen) ohne Button-Klick.
    (function setupInfiniteScroll(){
      const list = document.getElementById('list');
      if(!list) return;
      list.addEventListener('scroll', async () => {
        if(isLoadingMore) return;
        const threshold = 80; // px vor dem tats√§chlichen Ende
        if(list.scrollTop + list.clientHeight >= list.scrollHeight - threshold){
          // Nur im Posteingang automatisch nachladen
          if(currentFolder !== 'inbox') return;
          isLoadingMore = true;
          let loadingMoreEl = document.getElementById('list_loading_more');
          if(!loadingMoreEl && list){
            loadingMoreEl = document.createElement('div');
            loadingMoreEl.id = 'list_loading_more';
            loadingMoreEl.className = 'sub';
            loadingMoreEl.style.cssText = 'padding:6px 10px; text-align:left; color:#6b7280;';
            loadingMoreEl.textContent = 'Lade weitere E-Mails ‚Ä¶';
            list.appendChild(loadingMoreEl);
          }
          try{
            // Limit schrittweise erh√∂hen und in localStorage merken
            currentEmailLimit = currentEmailLimit + 100;
            try{ localStorage.setItem('emailLimit', String(currentEmailLimit)); }catch(_e){}
            await loadInbox();
          }finally{
            isLoadingMore = false;
            const el = document.getElementById('list_loading_more');
            if(el && el.parentNode){ el.parentNode.removeChild(el); }
          }
        }
      });
    })();
    
    // Manuelles Nachladen wird nicht mehr ben√∂tigt, da der Sync nun automatisch
    // im Hintergrund l√§uft. Die Funktion bleibt als Stub erhalten, falls alte
    // Event-Handler im DOM existieren.
    async function loadMoreEmails(){
      // Kein manueller Sync mehr ‚Äì alles l√§uft √ºber autoSyncAllFoldersBackground().
      return;
    }
    
    async function showInitialSyncDialog(){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      
      status.textContent = 'Pr√ºfe Postfach...';
      
      // Count emails on server
      try{
        const countRes = await fetch('/api/emails/sync', {
          method: 'POST',
          headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({ count_only: true, account_id: currentAccountId })
        });
        const countData = await parseJsonSafe(countRes);
        
        if(!countData.__ok){
          status.textContent = 'Fehler beim Z√§hlen';
          list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${countData.error}</div>`;
          return;
        }
        
        const total = countData.total_on_server;
        status.textContent = '';
        
        // Show dialog
        list.innerHTML = `
          <div style="padding:40px; text-align:center;">
            <div style="font-size:48px; margin-bottom:16px;">üì¨</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Postfach noch nicht synchronisiert</div>
            <div class="sub" style="margin-bottom:24px;">Es wurden <strong>${total} E-Mails</strong> auf dem Server gefunden.<br>Wie viele m√∂chten Sie laden?</div>
            
            <div style="display:flex; flex-direction:column; gap:10px; max-width:400px; margin:0 auto;">
              <button class="sync-btn" data-limit="20" style="background:#059669; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 20 E-Mails
              </button>
              <button class="sync-btn" data-limit="50" style="background:#0284c7; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 50 E-Mails
              </button>
              <button class="sync-btn" data-limit="100" style="background:#7c3aed; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 100 E-Mails
              </button>
              <button class="sync-btn" data-limit="500" style="background:#d97706; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                üì• Erste 500 E-Mails
              </button>
              <button class="sync-btn" data-limit="1000" style="background:#dc2626; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                ‚ö° Erste 1.000 E-Mails
              </button>
              ${total > 1000 ? `
                <button class="sync-btn" data-limit="full" style="background:#991b1b; color:#fff; border:0; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">
                  üîÑ Kompletten Ordner laden (in 500er-Paketen)
                </button>
              ` : ''}
            </div>
            
            <div class="sub" style="margin-top:20px;">üí° Sie k√∂nnen sp√§ter jederzeit weitere E-Mails nachladen</div>
          </div>
        `;
        
        // Add click handlers
        document.querySelectorAll('.sync-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const mode = btn.dataset.limit;
            if(mode === 'full'){
              await performFullSync(total);
            } else {
              const limit = parseInt(mode);
              await performSync(limit);
            }
          });
        });
        
      }catch(e){
        status.textContent = 'Fehler';
        list.innerHTML = `<div class="sub" style="padding:20px;">Fehler: ${e}</div>`;
      }
    }
    
    async function performSync(limit){
      const status = document.getElementById('status');
      const list = document.getElementById('list');
      
      list.innerHTML = `
        <div style="padding:40px; text-align:center;">
          <div style="font-size:48px; margin-bottom:16px;">‚è≥</div>
          <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Synchronisiere E-Mails...</div>
          <div id="sync-progress" class="sub" style="margin-bottom:16px;">Starte...</div>
          <div style="width:80%; max-width:400px; height:8px; background:#e5e7eb; border-radius:4px; margin:0 auto; overflow:hidden;">
            <div id="sync-progress-bar" style="width:0%; height:100%; background:#059669; transition:width 0.3s;"></div>
          </div>
        </div>
      `;
      
      try{
        const syncRes = await fetch('/api/emails/sync', {
          method: 'POST',
          headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({ limit: limit, account_id: currentAccountId, folder: getImapFolderForSync() })
        });
        const syncData = await parseJsonSafe(syncRes);
        
        if(!syncData.__ok){
          throw new Error(syncData.error || 'Sync fehlgeschlagen');
        }
        
        document.getElementById('sync-progress').textContent = 
          `‚úÖ ${syncData.synced} E-Mails geladen, ${syncData.new_contacts} neue Kontakte gefunden!`;
        document.getElementById('sync-progress-bar').style.width = '100%';
        
        // Set limit to synced count (or keep current if higher)
        if(limit){
          currentEmailLimit = Math.max(currentEmailLimit, limit);
          localStorage.setItem('emailLimit', currentEmailLimit);
        }
        
        // Reload inbox after 1 second
        setTimeout(() => {
          loadInbox();
        }, 1000);
        
      }catch(e){
        list.innerHTML = `
          <div style="padding:40px; text-align:center;">
            <div style="font-size:48px; margin-bottom:16px;">‚ùå</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:12px;">Synchronisierung fehlgeschlagen</div>
            <div class="sub" style="margin-bottom:20px;">${e}</div>
            <button onclick="loadInbox()" style="background:#059669; color:#fff; border:0; padding:10px 20px; border-radius:6px; cursor:pointer;">
              Erneut versuchen
            </button>
          </div>
        `;
      }
    }

    let autoReadTimer = null;
    let autoReadUid = null;
    let currentActionsWrapper = null;

    async function selectItem(uid, rowEl){
      // Active markieren
      document.querySelectorAll('.item.active').forEach(el => el.classList.remove('active'));
      rowEl.classList.add('active');
      currentUid = uid;

      if(autoReadTimer){
        clearTimeout(autoReadTimer);
        autoReadTimer = null;
      }
      autoReadUid = uid;
      // Draft-Controls aktivieren
      document.getElementById('btn_propose').disabled = false;
      document.getElementById('btn_send').disabled = false;
      // Compose-Bereich f√ºr neue Auswahl zur√ºcksetzen, damit alte Vorschl√§ge nicht irritieren
      try {
        const toInput = document.getElementById('compose_to');
        const subjInput = document.getElementById('compose_subject');
        const editor = document.getElementById('compose_editor');
        const status = document.getElementById('compose_status');
        if (toInput) toInput.value = '';
        if (subjInput) subjInput.value = '';
        if (editor) editor.innerHTML = '<div class="muted">Hier erscheint der Vorschlag ‚Ä¶</div>';
        if (status) status.textContent = '';
      } catch(_) {}
      // Load email from database
      const detail = document.getElementById('detail');
      detail.innerHTML = '<div class="sub">Lade Inhalt ‚Ä¶</div>';
      try{
        const res = await fetch(`/api/emails/get/${uid}`, {
          headers: getAuthHeaders()
        });
        const t = await parseJsonSafe(res);
        if(!t.__ok){ throw new Error(t.error || 'E-Mail konnte nicht geladen werden'); }
        const html = t.body_html || (t.body_text ? `<pre>${escapeHtml(t.body_text)}</pre>` : '<div class="sub">Kein Inhalt</div>');
        
        // Extract contact info
        let contactName = t.contact_name || t.from || '‚Äì';
        const contactEmail = t.contact_email || t.from_addr || '‚Äì';
        const emailCount = t.contact_email_count || 1;
        const profileSummary = t.profile_summary || '';
        const profileSummaryFull = t.profile_summary_full || '';
        const kpis = t.kpis || {};
        
        // Helper: Extract display name from email or profile (Frontend-Heuristik
        // passend zur Backend-Logik in _extract_real_name)
        function extractRealName(name, email, profile) {
          const genericLocals = new Set([
            'info','kontakt','contact','service','support','mail','office',
            'hello','sales','booking','reservierung','no-reply','noreply',
            'newsletter','reply','team'
          ]);

          function splitEmail(addr) {
            if (!addr || addr.indexOf('@') === -1) return { local: null, domain: null };
            const [local, domain] = addr.split('@');
            return { local: (local || '').trim().toLowerCase(), domain: (domain || '').trim().toLowerCase() };
          }

          function looksGenericLocal(local) {
            if (!local) return false;
            const base = local.split(/[+._-]/)[0];
            return genericLocals.has(base);
          }

          function companyFromDomain(domain) {
            if (!domain) return null;
            let main = domain.split(':', 1)[0];
            if (main.includes('.')) {
              const parts = main.split('.');
              if (parts.length >= 2) main = parts[parts.length - 2];
            }
            main = main.toLowerCase().replace(/[^a-z0-9√§√∂√º√ü-]/g, ' ');
            const tokens = main.split(/[-_\s]+/).filter(Boolean);
            if (!tokens.length) return null;
            const nice = tokens.slice(0, 2).map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(' ');
            return nice || null;
          }

          const { local, domain } = splitEmail(email || '');

          // Wenn Name wie eine E-Mail aussieht, verwerfen wir ihn und entscheiden
          // ausschlie√ülich √ºber Profil/E-Mail.
          if (name && name.includes('@')) {
            name = null;
          }

          // 1) Profiltext auswerten ("Johanna ist..." oder "Name: Johanna")
          if (!name || name === '‚Äì') {
            if (profile) {
              let m = profile.match(/^([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)\s+(ist|arbeitet|hat|sendet)/);
              if (m) {
                name = m[1];
              } else {
                m = profile.match(/(?:Kunde|Person|Kontakt|Name):\s*([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)/);
                if (m) {
                  name = m[1];
                }
              }
            }
          }

          // 2) Fallback √ºber E-Mail-Adresse
          if (!name || name === '‚Äì') {
            if (local && !looksGenericLocal(local)) {
              name = local.charAt(0).toUpperCase() + local.slice(1);
            } else {
              const company = companyFromDomain(domain);
              name = company || 'Kontakt';
            }
          }

          return name;
        }
        
        // Extract real name
        contactName = extractRealName(contactName, contactEmail, profileSummary);
        
        detail.innerHTML = `
          <div class="detail-scroll">
            <div style="position:sticky; top:0; z-index:5; display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 4px 8px 0; background:#f9fafb; border-bottom:1px solid #e5e7eb;">
              <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                <h2 style="margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(t.subject || '')}</h2>
                ${t.has_attachments ? `<button id="detail_attachments_btn" title="Anh√§nge anzeigen" style="border:0; background:transparent; padding:4px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; cursor:pointer; color:#4b5563;">${window.getIconSvg ? window.getIconSvg('paperclip', { size: 16 }) : 'üìé'}</button>` : ''}
              </div>
              <button id="toggle_compose_btn" title="Antwort √∂ffnen" style="background:#111827; color:#ffffff; border:0; padding:8px 14px; border-radius:8px; font-size:13px; white-space:nowrap;">Antwort</button>
            </div>
            <div class="meta">Von: ${escapeHtml(t.from||'')} ¬∑ An: ${escapeHtml(t.to||'')} ¬∑ ${escapeHtml(t.date||'')}</div>
            <div class="content">${html}</div>
            <div id="reply_prep_block" class="sub" style="margin-top:12px; padding:8px 10px; border-radius:6px; background:#fefce8; border:1px solid #facc15; font-size:12px;">
              <div style="font-weight:600; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <span>üß† Antwort-Vorbereitung (KI)</span>
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="font-size:10px; text-transform:uppercase; letter-spacing:0.06em; color:#6b7280;">Reply-Prep v2</span>
                  <button id="reply_prep_reload_btn" type="button" style="border:0; padding:3px 8px; border-radius:999px; font-size:10px; cursor:pointer; background:#e5e7eb; color:#374151; white-space:nowrap;">Neu laden</button>
                </div>
              </div>
              <div id="reply_prep_status" class="sub" style="margin-bottom:4px;">Analysiere E-Mail‚Ä¶</div>
              <div id="reply_prep_summary" style="margin-bottom:4px;"></div>
              <!-- Topics-Container wurde ins Kontaktprofil rechts neben die Quick-Context-Box verschoben. -->
              <div id="reply_prep_debug" style="margin-top:4px;"></div>
            </div>
          </div>
          <div class="detail-splitter" id="detail_splitter">‚ãÆ‚ãÆ</div>
          <div class="profile" id="profile_panel" data-contact-id="${t.contact_id || ''}">
            <div id="contact_profile_new_block" class="sub" style="margin-bottom:12px; padding:12px 14px; border-radius:10px; background:#eef2ff; border:1px solid #e5e7eb; font-size:13px; display:none; box-shadow:0 8px 20px rgba(15,23,42,0.06);">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; gap:8px;">
                <div style="font-weight:600; font-size:13px; color:#111827;">Kundenprofil (neu, Reply-Stil)</div>
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.08em; padding:2px 8px; border-radius:999px; background:#e0e7ff; color:#3730a3;">Live aus Reply-Prefs</div>
              </div>
              <div style="display:grid; grid-template-columns:minmax(0,1.1fr) minmax(0,1.2fr); gap:12px; align-items:flex-start;">
                <div>
                  <div style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:#6b7280; margin-bottom:4px;">Kontakt</div>
                  <div style="display:flex; flex-direction:column; gap:2px;">
                    <div class="kv"><span style="color:#6b7280;">Name</span><b>${escapeHtml(contactName)}</b></div>
                    <div class="kv"><span style="color:#6b7280;">E‚ÄëMail</span><b>${escapeHtml(contactEmail)}</b></div>
                    <div class="kv"><span style="color:#6b7280;">E-Mails</span><b><a href="#" id="cpn_view_all_contact_emails" data-contact-id="${t.contact_id || ''}" style="color:#0369a1; text-decoration:underline;">${emailCount} Nachricht${emailCount !== 1 ? 'en' : ''} anzeigen</a></b></div>
                    <div class="kv"><span style="color:#6b7280;">Relevanz</span><b id="cpn_importance">‚Äì</b></div>
                    <div class="kv"><span style="color:#6b7280;">Sprache</span><b id="cpn_language">‚Äì</b></div>
                  </div>
                </div>
                <div>
                  <div style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:#6b7280; margin-bottom:4px;">Reply-Stil</div>
                  <div style="display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); column-gap:10px; row-gap:2px;">
                    <div class="kv"><span style="color:#6b7280;">Anrede</span><b id="cpn_salutation_text">‚Äì</b></div>
                    <div class="kv"><span style="color:#6b7280;">Persona</span><b id="cpn_persona">‚Äì</b></div>
                    <div class="kv"><span style="color:#6b7280;">L√§nge</span><b id="cpn_length">‚Äì</b></div>
                    <div class="kv"><span style="color:#6b7280;">Formality</span><b id="cpn_formality">‚Äì</b></div>
                    <div class="kv" style="grid-column:1 / -1;"><span style="color:#6b7280;">Stil-Quelle</span><b id="cpn_style_source">‚Äì</b></div>
                    <div class="kv" style="grid-column:1 / -1;"><span style="color:#6b7280;">Begr√º√üung</span><b id="cpn_greeting">‚Äì</b></div>
                    <div class="kv" style="grid-column:1 / -1;"><span style="color:#6b7280;">Abschluss</span><b id="cpn_closing">‚Äì</b></div>
                  </div>
                </div>
              </div>
            </div>
            <h3 style="display:none;">Kundenprofil (alt)</h3>
            <div class="grid" style="display:none;">
              <!-- Linke Spalte: Stammdaten zum Kontakt -->
              <div>
                <div class="kv"><span>Name</span><b>${escapeHtml(contactName)}</b></div>
                <div class="kv"><span>E‚ÄëMail</span><b>${escapeHtml(contactEmail)}</b></div>
                <div class="kv"><span>E-Mails</span><b><a href="#" id="view_all_contact_emails" data-contact-id="${t.contact_id || ''}" style="color:#0369a1; text-decoration:underline;">${emailCount} Nachricht${emailCount !== 1 ? 'en' : ''} anzeigen</a></b></div>
                <div class="kv"><span>Sprache</span><b id="contact_language_text">‚Äì</b></div>
              </div>
              <!-- Rechte Spalte: Relevanz, Typ, Stimmung, Anrede als Textliste (gleiches Muster wie links) -->
              <div class="kv" style="justify-content:flex-start; text-align:left; flex-direction:column; align-items:flex-start; gap:2px;">
                <div>
                  <span style="margin-right:6px;">Relevanz</span><b id="contact_importance_badge">‚Äì</b>
                </div>
                <div>
                  <span style="margin-right:6px;">Typ</span><b id="contact_type_badge">‚Äì</b>
                </div>
                <div>
                  <span style="margin-right:6px;">Stimmung</span><b id="contact_sentiment_text">‚Äì</b>
                </div>
                <div>
                  <span style="margin-right:6px;">Anrede</span><b id="contact_salutation_text">‚Äì</b>
                </div>
              </div>
            </div>
            <div style="margin-top:16px; font-size:16px; border-top:1px solid var(--border); padding-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
                <div style="font-weight:600; font-size:13px; color:#6b7280; display:flex; align-items:center; gap:6px;">
                  <span>KI-Zusammenfassung</span>
                  <button id="generate_profile_btn" data-contact-id="${t.contact_id || ''}" title="KI-Zusammenfassung neu laden" style="width:24px; height:24px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:999px; border:0; cursor:pointer; background:#111827; color:#ffffff; font-size:14px;">
                    ${window.getIconSvg ? window.getIconSvg('refresh-ccw', { size: 16 }) : '‚ü≥'}
                  </button>
                </div>
              </div>
              <div style="margin-bottom:8px;">
                <div id="reply_prep_topics" class="sub" style="font-size:13px; padding:8px 10px; border-radius:6px; background:#f9fafb; border:1px dashed #d1d5db; max-height:260px; overflow:auto;"></div>
              </div>
              <div id="contact_reply_prefs_status" class="sub" style="font-size:11px; margin:4px 0 8px 0; color:#6b7280;">
                Antwortstil: Lade Einstellungen‚Ä¶
              </div>
              <div id="contact_topic_detail_panel" class="sub" style="font-size:16px; margin-bottom:8px; display:none; padding:8px 10px; border-radius:4px; background:#eff6ff; border:1px solid #bfdbfe;"></div>
              <div id="prof_summary_full" class="sub" style="margin-top:8px; padding:10px; background:#f9fafb; border-radius:6px; line-height:1.5; display:${profileSummaryFull ? 'block' : 'none'};">
                ${profileSummaryFull ? formatCustomerProfile(profileSummaryFull) : ''}
              </div>
            </div>
            <div style="margin-top:16px; font-size:13px; border-top:1px solid var(--border); padding-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div style="font-weight:600;">üìù Notizen</div>
              </div>
              <div id="contact_notes_list" class="sub" style="max-height:120px; overflow:auto; padding:6px 0; border-radius:4px; background:#f9fafb;"></div>
              <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
                <textarea id="contact_note_input" rows="2" placeholder="Kurze Notiz zum Kontakt (z.B. 'Angestellter von neckattack', 'Diesen Kontakt ignorieren', ...)" style="width:100%; font-size:16px; padding:8px 10px; border-radius:4px; border:1px solid var(--border); resize:vertical;"></textarea>
                <button id="contact_note_save" style="alignself:flex-end; background:#059669; color:#fff; border:0; padding:7px 12px; border-radius:4px; cursor:pointer; font-size:14px; font-weight:500;">Notiz speichern</button>
                <div id="contact_note_status" class="sub"></div>
              </div>
            </div>
          </div>
        `;
        // Header-B√ºroklammer: ersten Anhang direkt herunterladen (mit Auth, als Datei-Download)
        try {
          const attBtn = document.getElementById('detail_attachments_btn');
          if (attBtn && t.has_attachments && t.id) {
            attBtn.addEventListener('click', async (ev) => {
              ev.preventDefault();
              ev.stopPropagation();
              try {
                const status = document.getElementById('compose_status');
                if (status) status.textContent = 'Lade Anhang ‚Ä¶';
                const res = await fetch(`/api/emails/${t.id}/attachments`, { headers: getAuthHeaders() });
                const data = await parseJsonSafe(res);
                if (!data || !data.attachments || !data.attachments.length) {
                  if (status) status.textContent = 'Keine herunterladbaren Anh√§nge gefunden.';
                  return;
                }

                const attachments = data.attachments;
                if (status) status.textContent = `Lade ${attachments.length} Anhang${attachments.length !== 1 ? 'e' : ''} ‚Ä¶`;

                // Alle Anh√§nge nacheinander als Blob holen und direkt speichern
                for (const att of attachments) {
                  const downloadUrl = `/api/emails/${t.id}/attachments/${att.idx}/download`;
                  const dlRes = await fetch(downloadUrl, { headers: getAuthHeaders() });
                  if (!dlRes.ok) {
                    continue;
                  }
                  const blob = await dlRes.blob();
                  const contentDisposition = dlRes.headers.get('Content-Disposition') || '';
                  let filename = att.filename || 'attachment';
                  try {
                    const match = contentDisposition.match(/filename="?([^";]+)"?/i);
                    if (match && match[1]) {
                      filename = match[1];
                    }
                  } catch (_e_fn) {}

                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = filename;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  window.URL.revokeObjectURL(url);
                }
                if (status) status.textContent = '';
              } catch (e) {
                const status = document.getElementById('compose_status');
                if (status) status.textContent = 'Fehler beim Laden des Anhangs.';
              }
            });
          }
        } catch(_e_attach_hdr) {}
        // Kopfzeile im KONTAKT-PROFIL (Relevanz, Typ, Stimmung, Anrede) als Text setzen
        try {
          const importanceEl = document.getElementById('contact_importance_badge');
          const typeEl = document.getElementById('contact_type_badge');
          const sentimentEl = document.getElementById('contact_sentiment_text');
          const salutationEl = document.getElementById('contact_salutation_text');
          const langEl = document.getElementById('contact_language_text');

          // Relevanz aus Bucket ableiten
          if (importanceEl) {
            const bucket = getImportanceBucket(t) || '';
            let label = '';
            if (bucket === 'focus') {
              label = 'Fokus-Kontakt';
            } else if (bucket === 'unwichtig') {
              label = 'Unwichtiger Kontakt';
            } else if (bucket === 'normal') {
              label = 'Normal';
            }
            importanceEl.textContent = label || '‚Äì';
          }

          const kpis = t.kpis || {};

          // Typ aus Kategorie
          if (typeEl) {
            const category = (kpis.category || '').toString().trim();
            typeEl.textContent = category || '‚Äì';
          }

          // Stimmungstext
          if (sentimentEl) {
            const s = (kpis.sentiment || '').toString().trim();
            let label = '‚Äì';
            if (s === 'positive') label = 'Positiv';
            else if (s === 'negative') label = 'Negativ';
            else if (s) label = s;
            sentimentEl.textContent = label;
          }

          // Anrede
          if (salutationEl) {
            const sal = (kpis.salutation || '').toString().trim();
            salutationEl.textContent = sal || 'Unklar';
          }

          // Sprache (optional, aus KPIs falls vorhanden)
          if(langEl){
            const code = (kpis.language_code || '').toString().trim().toLowerCase();
            const label = (kpis.language_label || '').toString().trim();
            if(label){
              langEl.textContent = label;
            } else if(code){
              langEl.textContent = code;
            } else {
              langEl.textContent = '‚Äì';
            }
          }
        } catch (_e_badge) {}

        // Event handler for "View all contact emails" buttons (oben in Neukachel + unten im Kundenprofil)
        const viewAllBtn = document.getElementById('view_all_contact_emails');
        const viewAllBtnNew = document.getElementById('cpn_view_all_contact_emails');
        const wireViewAll = (btn) => {
          if(!btn || !t.contact_id) return;
          btn.onclick = (ev) => {
            ev.preventDefault();
            openContactDetailModal(t.contact_id, contactName, contactEmail);
          };
        };
        wireViewAll(viewAllBtn);
        wireViewAll(viewAllBtnNew);

        // Vertikalen Splitter zwischen Mailinhalt und Profil aktivieren
        try {
          const detailEl = document.getElementById('detail');
          const splitter = document.getElementById('detail_splitter');
          const topEl = detailEl ? detailEl.querySelector('.detail-scroll') : null;
          const bottomEl = detailEl ? detailEl.querySelector('.profile') : null;
          if(detailEl && splitter && topEl && bottomEl){
            // Standardaufteilung bei jedem Mail-Wechsel zur√ºcksetzen, damit der untere Bereich
            // (Kontaktprofil) nicht "verschwindet" und der Slider stabiler wirkt.
            topEl.style.flex = '0 0 70%';
            bottomEl.style.flex = '0 0 30%';
            let isDragging = false;
            let startY = 0;
            let startTopHeight = 0;
            const onMouseMove = (ev) => {
              if(!isDragging) return;
              const rect = detailEl.getBoundingClientRect();
              const dy = ev.clientY - startY;
              let newTop = startTopHeight + dy;
              const minTop = rect.height * 0.25;
              const maxTop = rect.height * 0.85;
              if(newTop < minTop) newTop = minTop;
              if(newTop > maxTop) newTop = maxTop;
              const ratio = newTop / rect.height;
              topEl.style.flex = `0 0 ${ratio * 100}%`;
              bottomEl.style.flex = `0 0 ${(1 - ratio) * 100}%`;
            };
            const onMouseUp = () => {
              if(!isDragging) return;
              isDragging = false;
              window.removeEventListener('mousemove', onMouseMove);
              window.removeEventListener('mouseup', onMouseUp);
            };
            splitter.onmousedown = (ev) => {
              if(ev.button !== 0) return;
              isDragging = true;
              startY = ev.clientY;
              const rectTop = topEl.getBoundingClientRect();
              startTopHeight = rectTop.height;
              window.addEventListener('mousemove', onMouseMove);
              window.addEventListener('mouseup', onMouseUp);
            };
          }
        } catch(_e) {
          // Splitter ist Komfort-Feature ‚Äì Fehler hier ignorieren
        }

        // Antwort-Vorbereitung (KI) laden
        try {
          const prepBlock = document.getElementById('reply_prep_block');
          const prepStatus = document.getElementById('reply_prep_status');
          const prepSummary = document.getElementById('reply_prep_summary');
          const prepTopics = document.getElementById('reply_prep_topics');
          const prepDebug = document.getElementById('reply_prep_debug');
          const prepReloadBtn = document.getElementById('reply_prep_reload_btn');

          async function loadReplyPrep(force){
            if(!prepBlock || !prepStatus || !prepSummary || !prepTopics) return;
            prepStatus.textContent = force ? 'Lade neu‚Ä¶' : 'Analysiere E-Mail‚Ä¶';
            // Zusammenfassung aktuell nicht anzeigen ‚Äì Fokus auf Themenbl√∂cke
            prepSummary.innerHTML = '';
            prepTopics.innerHTML = '';
            if(prepDebug){ prepDebug.innerHTML = ''; }

            const url = `/api/emails/${t.id}/reply-prep?debug_raw=1&skip_history=1${force ? '&force=1' : ''}`;
            const res = await fetch(url, { headers: getAuthHeaders() });
            const data = await parseJsonSafe(res);
                if(!data.__ok){
                  prepStatus.textContent = 'Analyse nicht verf√ºgbar.';
                  return;
                }
                // Anzeige je nachdem, ob wir aus dem Cache laden oder frisch analysiert haben
                if(data.from_cache){
                  prepStatus.textContent = 'Geladene Themen (Cache).';
                } else {
                  prepStatus.textContent = '';
                }
                // Zusammenfassung aus Backend wird derzeit im UI nicht angezeigt,
                // um die Ansicht schlank zu halten. Daten bleiben dennoch verf√ºgbar.

                const currentTopics = data.current_email_topics || [];
                const topics = data.topics || [];
                if(!currentTopics.length && !topics.length){
                  prepTopics.innerHTML = '<div class="sub">Keine Themen erkannt.</div>';
                  return;
                }

                const editor = document.getElementById('compose_editor');
                function setSnippetForButton(topicId, optId, snippet){
                  if(!editor) return;
                  const tId = topicId || '';
                  const oId = optId || '';
                  const selector = `.reply-snippet[data-topic-id="${tId}"][data-opt-id="${oId}"]`;
                  const existing = editor.querySelector(selector);
                  if(existing){
                    const parent = existing.parentElement;
                    existing.remove();
                    if(parent && !parent.textContent.trim()){
                      parent.remove();
                    }
                  }
                  if(!snippet) return;

                  // Platzhalter entfernen, falls noch vorhanden
                  const textNow = (editor.textContent || '').trim();
                  if(/Hier erscheint der Vorschlag/i.test(textNow)){
                    editor.innerHTML = '';
                  }

                  const esc = snippet.replace(/\n/g, '<br>');
                  const wrapped = `<span class="reply-snippet" data-topic-id="${tId}" data-opt-id="${oId}">${esc}</span>`;

                  // Bevorzugt: Immer direkt vor dem Abschluss-Absatz (data-role="closing") einf√ºgen.
                  let closingP = editor.querySelector('p[data-role="closing"]');
                  if(closingP){
                    closingP.insertAdjacentHTML('beforebegin', `<p>${wrapped}</p>`);
                    return;
                  }

                  // Fallback, falls kein markierter Abschluss vorhanden ist: wie bisher ans Ende anh√§ngen.
                  editor.insertAdjacentHTML('beforeend', `<p>${wrapped}</p>`);
                }

                let topicsHtml = '';
                let histLoaded = false;

                // 1) Aktuelle E-Mail-Themen zuerst anzeigen (ohne Historien-Meta, optional mit Erkl√§rung)
                if(currentTopics.length){
                  topicsHtml += '<div class="sub" style="font-size:10px; text-transform:uppercase; letter-spacing:0.03em; margin-top:2px;">Aktuelle Themen aus dieser E-Mail</div>';
                  topicsHtml += currentTopics.map((ct, idx) => {
                    const baseLabel = ct.label || 'dieses Thema';
                    const topicKey = `mailtopic_${t.id}_${idx}`;
                    // Vier Kategorien: FAQ, To-Do, Historie, Delegieren (plus Manuell unten)
                    const categoryOpts = [
                      { id: 'faq', label: 'FAQ-Antwort', mode: 'faq' },
                      { id: 'todo', label: 'To-Do', mode: 'todo' },
                      { id: 'history', label: 'Historie', mode: 'history' },
                      { id: 'delegate', label: 'Weiterleiten', mode: 'delegate' },
                    ];
                    const optHtml = categoryOpts.map(opt => {
                      return `<button class="reply-opt-btn" data-kind="current" data-topic-id="${topicKey}" data-topic-label="${escapeHtml(baseLabel)}" data-topic-expl="${ct.explanation ? escapeHtml(ct.explanation) : ''}" data-mode="${opt.mode}" data-opt-id="${opt.id}" style="border:0; padding:3px 6px; border-radius:4px; font-size:11px; margin:2px 4px 2px 0; cursor:pointer; background:#e5e7eb; color:#374151;">${escapeHtml(opt.label || '')}</button>`;
                    }).join('');
                    const expl = ct.explanation ? `<div class="sub" style="font-size:16px; margin-bottom:4px;">${escapeHtml(ct.explanation)}</div>` : '';
                    return `
                      <div class="reply-prep-topic" data-kind="current" style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#f9fafb; border:1px solid #e5e7eb; position:relative;">
                        <span class="reply-prep-close" data-kind="current" style="position:absolute; right:6px; top:4px; color:#b91c1c; font-weight:bold; cursor:pointer;">√ó</span>
                        <div style="font-size:18px; font-weight:500; margin-bottom:4px;">${escapeHtml(ct.label || '(ohne Titel)')}</div>
                        ${expl}
                        <div style="margin-bottom:4px;">${optHtml}</div>
                        <div style="margin-top:4px; border-top:1px dashed #e5e7eb; padding-top:4px;">
                          <div class="sub" style="font-size:10px; margin-bottom:2px;">Manuelle Antwort (Stichworte):</div>
                          <div style="display:flex; flex-direction:column; gap:4px; align-items:stretch;">
                            <textarea class="reply-manual-note" data-topic-label="${escapeHtml(ct.label || '')}" data-topic-expl="${ct.explanation ? escapeHtml(ct.explanation) : ''}" rows="2" placeholder="Eigene Stichworte zur Antwort..." style="width:100%; font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid #e5e7eb; resize:vertical;"></textarea>
                            <button class="reply-manual-btn" data-kind="current" style="width:100%; border:0; padding:6px 10px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; background:#6366f1; color:#ffffff; white-space:nowrap;">Einf√ºgen</button>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('');
                }

                // 2) Historische offene Themen: Toggle + leerer Container (Inhalt wird beim ersten √ñffnen lazy geladen)
                topicsHtml += `
                  <div class="sub" style="font-size:10px; text-transform:uppercase; letter-spacing:0.03em; margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <span>Offene Themen aus bisherigen E-Mails</span>
                    <button id="historical_topics_toggle" type="button" style="border:0; padding:3px 8px; border-radius:999px; font-size:10px; cursor:pointer; background:#e5e7eb; color:#374151; white-space:nowrap;">anzeigen</button>
                  </div>
                  <div id="historical_topics_container" style="margin-top:4px; display:none;"></div>
                `;

                prepTopics.innerHTML = topicsHtml;
                const composeTopics = document.getElementById('compose_topics_mirror');
                if(composeTopics){
                  composeTopics.innerHTML = topicsHtml;
                }

                // Toggle f√ºr historische Themen (ein-/ausklappen und ggf. lazy load)
                try {
                  const histToggle = prepTopics.querySelector('#historical_topics_toggle');
                  const histContainer = prepTopics.querySelector('#historical_topics_container');
                  if(histToggle && histContainer){
                    histToggle.addEventListener('click', () => {
                      const doShow = histContainer.style.display === 'none' || !histContainer.style.display;
                      if(doShow && !histLoaded){
                        // Beim ersten √ñffnen historische Themen lazy nachladen
                        fetch(`/api/emails/${t.id}/reply-prep?debug_raw=1`, { headers: getAuthHeaders() })
                          .then(res => parseJsonSafe(res))
                          .then(histData => {
                            const histTopics = (histData && histData.topics) || [];
                            if(!histTopics.length) return;
                            const historicalHtmlLazy = histTopics.map(tp => {
                              const ageTxt = (tp.age_days != null) ? ` ¬∑ seit ${tp.age_days} Tagen` : '';
                              const meta = `${tp.email_count || 0} E-Mails${ageTxt}`;
                              const optHtml = (tp.reply_options || []).map((opt, idx) => {
                                return `<button class="reply-opt-btn" data-topic-id="${tp.id}" data-opt-id="${opt.id}" data-snippet="${encodeURIComponent(opt.snippet || '')}" style="border:0; padding:3px 6px; border-radius:4px; font-size:11px; margin:2px 4px 2px 0; cursor:pointer; background:#e5e7eb; color:#374151;">${escapeHtml(opt.label || '')}</button>`;
                              }).join('');
                              const mailsHtml = (tp.emails || []).slice(0,5).map(em => {
                                const text = `${em.received_at || ''} ‚Äì ${em.subject || ''}`;
                                return `<div style="font-size:11px; cursor:pointer; text-decoration:underline;" data-email-id="${em.id}" class="reply-prep-email-link">${escapeHtml(text)}</div>`;
                              }).join('');
                              return `
                                <div class="reply-prep-topic" data-kind="historical" data-topic-id="${tp.id}" style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#f9fafb; border:1px solid #e5e7eb; position:relative;">
                                  <span class="reply-prep-close" data-kind="historical" data-topic-id="${tp.id}" style="position:absolute; right:6px; top:4px; color:#b91c1c; font-weight:bold; cursor:pointer;">√ó</span>
                                  <div style="font-size:18px; font-weight:500; margin-bottom:4px;">${escapeHtml(tp.label || '(ohne Titel)')}</div>
                                  <div class="sub" style="font-size:14px; margin-bottom:4px;">${escapeHtml(meta)}</div>
                                  <div style="margin-bottom:4px;">${optHtml}</div>
                                  ${mailsHtml ? `<div style="font-size:11px; margin-top:2px;"><span class="muted">Relevante E-Mails:</span></div>${mailsHtml}` : ''}
                                  <div style="margin-top:4px; border-top:1px dashed #e57eb; padding-top:4px;">
                                    <div class="sub" style="font-size:10px; margin-bottom:2px;">Manuelle Antwort (Stichworte):</div>
                                    <div style="display:flex; gap:4px; align-items:flex-start;">
                                      <textarea class="reply-manual-note" data-topic-label="${escapeHtml(tp.label || '')}" data-topic-expl="" rows="2" placeholder="Eigene Stichworte zur Antwort..." style="flex:1; font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid #e5e7eb; resize:vertical;"></textarea>
                                      <button class="reply-manual-btn" data-kind="historical" data-topic-id="${tp.id}" style="border:0; padding:6px 10px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; background:#6366f1; color:#ffffff; white-space:nowrap;">Manuell formulieren</button>
                                    </div>
                                  </div>
                                </div>
                              `;
                            }).join('');
                            histContainer.innerHTML = historicalHtmlLazy;
                            histLoaded = true;
                          })
                          .catch(() => {/* Komfort-Feature */});
                      }
                      histContainer.style.display = doShow ? 'block' : 'none';
                      histToggle.textContent = doShow ? 'ausblenden' : 'anzeigen';
                    });
                  }
                } catch(_e){ /* nur Komfort-Feature */ }

                // Optionaler Debug-Block direkt unterhalb des Reply-Prep-Blocks
                if(prepDebug && (data.debug_body_for_topics || data.debug_raw_topics_llm)){
                  let dbgHtml = '<div style="font-size:10px; text-transform:uppercase; letter-spacing:0.03em; margin-top:8px; color:#6b7280;">Debug: GPT-Topics-Input & Ausgabe</div>';
                  if(data.debug_body_for_topics){
                    dbgHtml += `<div style="margin-top:4px;"><div class="sub" style="font-size:10px; margin-bottom:2px;">Body fr Topics (an GPT gesendet):</div><pre style="white-space:pre-wrap; font-size:10px; background:#f3f4f6; padding:6px 8px; border-radius:4px; max-height:160px; overflow:auto; border:1px dashed #e5e7eb;">${escapeHtml(data.debug_body_for_topics)}</pre></div>`;
                  }
                  if(data.debug_raw_topics_llm){
                    dbgHtml += `<div style="margin-top:4px;"><div class="sub" style="font-size:10px; margin-bottom:2px;">Rohe GPT-Topics-Antwort:</div><pre style="white-space:pre-wrap; font-size:10px; background:#f3f4f6; padding:6px 8px; border-radius:4px; max-height:160px; overflow:auto; border:1px dashed #e5e7eb;">${escapeHtml(data.debug_raw_topics_llm)}</pre></div>`;
                  }
                  prepDebug.innerHTML = dbgHtml;
                }

                // Hilfsfunktion: Buttons innerhalb eines Containers verkabeln
                function wireReplyPrepButtons(rootEl){
                  if(!rootEl) return;
                  // Kategorie-Buttons (FAQ-Antwort, To-Do, Historie, Weiterleiten)
                  rootEl.querySelectorAll('.reply-opt-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                      const topicId = btn.getAttribute('data-topic-id') || '';
                      const optId = btn.getAttribute('data-opt-id') || '';
                      const kind = btn.getAttribute('data-kind') || 'historical';

                      const isActive = btn.getAttribute('data-active') === '1';
                      if(isActive){
                        // Toggle aus
                        setSnippetForButton(topicId, optId, null);
                        btn.setAttribute('data-active', '0');
                        btn.style.backgroundColor = '#e5e7eb';
                        btn.style.color = '#374151';
                        btn.style.opacity = '1';
                        return;
                      }

                      if(kind === 'historical'){
                        // Historische Themen: feste Snippets + ggf. Thema schlie√üen
                        const snippetEnc = btn.getAttribute('data-snippet') || '';
                        const snippet = decodeURIComponent(snippetEnc);
                        setSnippetForButton(topicId, optId, snippet);
                        btn.setAttribute('data-active', '1');
                        btn.style.backgroundColor = '#16a34a';
                        btn.style.color = '#ffffff';
                        btn.style.opacity = '1';

                        if(optId === 'close' && topicId && t.contact_id){
                          try{
                            const resSt = await fetch(`/api/contacts/${t.contact_id}/topics/${topicId}/status`, {
                              method: 'POST',
                              headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                              body: JSON.stringify({ status: 'done' })
                            });
                            const stData = await parseJsonSafe(resSt);
                            if(!stData.__ok){
                              console.error('Status konnte nicht ge√§ndert werden', stData.error);
                            } else if(btn.closest('.reply-prep-topic')){
                              // einfach den Block entfernen
                              btn.closest('.reply-prep-topic').remove();
                            }
                          } catch(e){
                            console.error('Fehler beim Schlie√üen des Themas aus Reply-Prep:', e);
                          }
                        }
                        return;
                      }

                      // Aktuelle Themen: dynamische KI-Antwort
                      const mode = btn.getAttribute('data-mode') || '';
                      const topicLabel = btn.getAttribute('data-topic-label') || '';
                      const topicExpl = btn.getAttribute('data-topic-expl') || '';

                      btn.disabled = true;
                      btn.style.opacity = '0.6';
                      try {
                        const res = await fetch('/api/reply-prep/category-draft', {
                          method: 'POST',
                          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            mode,
                            topic_label: topicLabel,
                            topic_explanation: topicExpl,
                            email_id: t.id,
                            contact_id: t.contact_id || null,
                            topic_id: null
                          })
                        });
                        const dataCat = await parseJsonSafe(res);
                        if(!dataCat.__ok){
                          alert('Konnte keine Antwort f√ºr diese Kategorie erzeugen: ' + (dataCat.error || 'Unbekannter Fehler'));
                          return;
                        }
                        const snippet = dataCat.snippet || '';
                        if(!snippet){
                          alert('Die KI hat keinen Text zur√ºckgeliefert.');
                          return;
                        }
                        setSnippetForButton(topicId, optId, snippet);
                        btn.setAttribute('data-active', '1');
                        btn.style.backgroundColor = '#16a34a';
                        btn.style.color = '#ffffff';
                        btn.style.opacity = '1';
                      } catch(e){
                        alert('Fehler bei der Kategorie-Antwort: ' + e);
                      } finally {
                        btn.disabled = false;
                        if(btn.style.opacity === '0.6') btn.style.opacity = '1';
                      }
                    });
                  });

                  // Manuelle Antwortkategorie: Stichworte -> LLM-Formulierung
                  rootEl.querySelectorAll('.reply-manual-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                      const topicKind = btn.getAttribute('data-kind') || 'current';
                      const topicId = btn.getAttribute('data-topic-id') || '';
                      const container = btn.closest('.reply-prep-topic');
                      if(!container) return;
                      const noteEl = container.querySelector('.reply-manual-note');
                      if(!noteEl) return;
                      const note = noteEl.value.trim();
                      if(!note){
                        alert('Bitte zuerst Stichworte eingeben.');
                        return;
                      }

                      const topicLabel = noteEl.getAttribute('data-topic-label') || '';
                      const topicExpl = noteEl.getAttribute('data-topic-expl') || '';

                      btn.disabled = true;
                      const oldText = btn.textContent;
                      btn.textContent = 'Formuliere...';
                      try{
                        const res = await fetch('/api/reply-prep/manual-draft', {
                          method: 'POST',
                          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            topic_label: topicLabel,
                            topic_explanation: topicExpl,
                            note: note,
                            contact_name: contactName || ''
                          })
                        });
                        const data = await parseJsonSafe(res);
                        if(!data.__ok){
                          alert('Konnte keine manuelle Antwort formulieren: ' + (data.error || 'Unbekannter Fehler'));
                        } else {
                          const snippet = data.snippet || '';
                          const optId = topicId ? `manual_${topicId}` : `manual_${topicLabel || 'topic'}`;
                          // Toggle-Logik wie bei Buttons: wenn bereits aktiv, entfernen; sonst setzen
                          const isActive = btn.getAttribute('data-active') === '1';
                          if(isActive){
                            setSnippetForButton(topicId || topicLabel, optId, null);
                            btn.setAttribute('data-active', '0');
                            btn.style.backgroundColor = '#6366f1';
                            btn.style.opacity = '1';
                          } else {
                            setSnippetForButton(topicId || topicLabel, optId, snippet);
                            btn.setAttribute('data-active', '1');
                            btn.style.backgroundColor = '#16a34a';
                            btn.style.opacity = '1';
                          }
                        }
                      } catch(e){
                        alert('Fehler bei manueller Formulierung: ' + e);
                      } finally {
                        btn.disabled = false;
                        btn.textContent = oldText;
                      }
                    });
                  });
                }

                // Buttons sowohl im Haupt-Topics-Block als auch im gespiegelten Compose-Block aktivieren
                wireReplyPrepButtons(prepTopics);
                wireReplyPrepButtons(composeTopics);
                if(typeof wireReplyManualButtons === 'function'){
                  wireReplyManualButtons(prepTopics);
                  wireReplyManualButtons(composeTopics);
                }

                // Rote X-Schaltfl√§chen in Themenbl√∂cken
                prepTopics.querySelectorAll('.reply-prep-close').forEach(closeBtn => {
                  closeBtn.addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                    const kind = closeBtn.getAttribute('data-kind');
                    const topicId = closeBtn.getAttribute('data-topic-id');
                    const block = closeBtn.closest('.reply-prep-topic');
                    if(kind === 'current'){
                      if(block){ block.remove(); }
                      return;
                    }
                    if(kind === 'historical' && topicId && t.contact_id){
                      try{
                        const resSt = await fetch(`/api/contacts/${t.contact_id}/topics/${topicId}/status`, {
                          method: 'POST',
                          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                          body: JSON.stringify({ status: 'done' })
                        });
                        const stData = await parseJsonSafe(resSt);
                        if(!stData.__ok){
                          console.error('Status konnte nicht ge√§ndert werden', stData.error);
                        } else if(block){
                          block.remove();
                        }
                      } catch(e){
                        console.error('Fehler beim Schlie√üen des Themas √ºber X:', e);
                      }
                    }
                  });
                });

                // Klick auf relevante E-Mails -> zur Mail springen
                prepTopics.querySelectorAll('.reply-prep-email-link').forEach(link => {
                  link.addEventListener('click', () => {
                    const eid = link.getAttribute('data-email-id');
                    if(!eid) return;
                    const listEl = document.getElementById('list');
                    if(!listEl) return;
                    const row = listEl.querySelector(`.item[data-uid="${eid}"]`);
                    if(row){
                      try{ row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(_){ }
                      selectItem(eid, row);
                    } else {
                      alert('Diese E-Mail ist nicht in der aktuellen Liste sichtbar.');
                    }
                  });
                });
              }

          // Initial Reply-Prep laden und Reload-Button verkabeln
          if(prepBlock && prepStatus && prepSummary && prepTopics){
            loadReplyPrep(false);
            if(prepReloadBtn){
              prepReloadBtn.addEventListener('click', () => {
                loadReplyPrep(true);
              });
            }
          }

        } catch(_) {}

        // Kontakt-Notizen laden und speichern
        try {
          const notesList = document.getElementById('contact_notes_list');
          const noteInput = document.getElementById('contact_note_input');
          const noteSave = document.getElementById('contact_note_save');
          const noteStatus = document.getElementById('contact_note_status');
          const contactId = t.contact_id;

          async function loadNotes(){
            if(!notesList || !contactId) return;
            notesList.textContent = 'Lade Notizen...';
            try {
              const res = await fetch(`/api/contacts/${contactId}/notes`, { headers: getAuthHeaders() });
              const data = await parseJsonSafe(res);
              if(!data.__ok){ throw new Error(data.error || 'Fehler'); }
              const notes = data.notes || [];
              if(!notes.length){
                notesList.innerHTML = '<div class="sub" style="padding:4px 6px;">Noch keine Notizen vorhanden.</div>';
              } else {
                notesList.innerHTML = notes.map(n => `
                  <div class="contact-note-item" data-note-id="${n.id}" style="padding:4px 6px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:flex-start; gap:6px;">
                    <div>
                      <div style="font-size:12px;">${escapeHtml(n.text)}</div>
                      <div class="sub" style="font-size:11px;">${escapeHtml(n.created_at)}</div>
                    </div>
                    <button class="contact_note_delete" title="Notiz l√∂schen" style="border:0; background:transparent; color:#9ca3af; cursor:pointer; font-size:12px; line-height:1; padding:0 2px;">√ó</button>
                  </div>
                `).join('');
                // Delete-Handler f√ºr Notizen (X-Icon)
                const deleteButtons = notesList.querySelectorAll('.contact_note_delete');
                deleteButtons.forEach(btn => {
                  btn.onclick = async (ev) => {
                    ev.stopPropagation();
                    const item = btn.closest('.contact-note-item');
                    const noteId = item ? item.getAttribute('data-note-id') : null;
                    if(!noteId) return;
                    noteStatus.textContent = 'L√∂sche Notiz...';
                    try {
                      const res = await fetch(`/api/contacts/${contactId}/notes/${noteId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                      });
                      const delData = await parseJsonSafe(res);
                      if(!delData.__ok){
                        throw new Error(delData.error || 'Fehler beim L√∂schen');
                      }
                      noteStatus.textContent = 'Notiz gel√∂scht.';
                      await loadNotes();
                    } catch(e) {
                      noteStatus.textContent = `Fehler beim L√∂schen: ${e}`;
                    }
                  };
                });
              }
            } catch(e) {
              notesList.innerHTML = `<div class="sub" style="padding:4px 6px; color:#dc2626;">Fehler beim Laden der Notizen: ${e}</div>`;
            }
          }

          if(noteSave && noteInput && contactId){
            noteSave.onclick = async () => {
              const txt = (noteInput.value || '').trim();
              if(!txt){
                noteStatus.textContent = 'Notiz darf nicht leer sein.';
                return;
              }
              noteSave.disabled = true;
              noteStatus.textContent = 'Speichere Notiz...';
              try {
                const res = await fetch(`/api/contacts/${contactId}/notes`, {
                  method: 'POST',
                  headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                  body: JSON.stringify({ text: txt })
                });
                const data = await parseJsonSafe(res);
                if(!data.__ok){ throw new Error(data.error || 'Fehler'); }
                noteInput.value = '';
                noteStatus.textContent = 'Notiz gespeichert.';
                await loadNotes();
              } catch(e) {
                noteStatus.textContent = `Fehler: ${e}`;
              } finally {
                noteSave.disabled = false;
              }
            };
          }

          loadNotes();
        } catch(_) {}
        
        // Kontakt-Themen (Topics) laden und als vertikale Liste im KI-Kundenprofil anzeigen
        async function loadContactTopics(contactId){
          try {
            const topicDetailsBox = document.getElementById('contact_topic_details');
            if(!topicDetailsBox || !contactId) return;

            const res = await fetch(`/api/contacts/${contactId}/topics`, { headers: getAuthHeaders() });
            const data = await parseJsonSafe(res);
            const topics = (data && data.topics) || [];

            if(!topics.length){
              topicDetailsBox.innerHTML = '<div class="sub">Noch keine Themen erkannt.</div>';
              return;
            }

            const limited = topics.slice(0, 10); // maximal 10 aktuellste Themen anzeigen
            const rows = limited.map(tp => {
              let icon = 'üè∑Ô∏è';
              let statusLabel = tp.status || '';
              if(tp.status === 'open'){
                icon = '‚ö†Ô∏è';
                statusLabel = 'offen';
              } else if(tp.status === 'in_progress'){
                icon = '‚è≥';
                statusLabel = 'in Bearbeitung';
              } else if(tp.status === 'done'){
                icon = '‚úÖ';
                statusLabel = 'abgeschlossen';
              }
              const metaParts = [];
              if(statusLabel){ metaParts.push(`Status: ${escapeHtml(statusLabel)}`); }
              if(tp.last_mentioned_at){ metaParts.push(`zuletzt erw√§hnt am ${escapeHtml(tp.last_mentioned_at)}`); }
              const metaText = metaParts.join(' ¬∑ ');
              const labelText = escapeHtml(tp.label || '');
              return `<div style="padding:4px 0; border-bottom:1px solid #e5e7eb;">
                <div style="font-size:12px; font-weight:500;">${icon} ${labelText}</div>
                ${metaText ? `<div style=\"font-size:11px; color:#6b7280;\">${metaText}</div>` : ''}
              </div>`;
            }).join('');

            const topicList = document.getElementById('topic_list');
            topicList.innerHTML = rows;

            // Event handler f√ºr Themen (Klick auf Thema)
            const topicItems = topicList.children;
            for(let i = 0; i < topicItems.length; i++){
              const item = topicItems[i];
              item.onclick = async () => {
                const topicId = limited[i].id;
                const topicDetailPanel = document.getElementById('contact_topic_detail_panel');
                topicDetailPanel.style.display = 'block';
                topicDetailPanel.innerHTML = 'Lade Thema-Detail...';
                try {
                  const res = await fetch(`/api/contacts/${contactId}/topics/${topicId}/detail`, { headers: getAuthHeaders() });
                  const data = await parseJsonSafe(res);
                  if(!data.__ok){ throw new Error(data.error || 'Fehler'); }
                  const topicDetail = data.topic || {};
                  const desc = topicDetail.description || '';
                  const detailHtml = `
                    <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(topicDetail.label || '')}</div>
                    ${desc ? `<div style=\"font-size:11px; margin-bottom:4px;\">${escapeHtml(desc)}</div>` : ''}
                    <div style="font-size:11px; margin-bottom:4px;">Status: ${escapeHtml(topicDetail.status || '')}</div>
                    <div style="font-size:11px; margin-bottom:4px;">Zuletzt erw√§hnt am: ${escapeHtml(topicDetail.last_mentioned_at || '')}</div>
                  `;
                  topicDetailPanel.innerHTML = detailHtml;

                  // Toggle-Button f√ºr Status
                  const isDone = (topicDetail.status || '').toLowerCase() === 'done';
                  const newStatus = isDone ? 'open' : 'done';
                  const btnLabel = isDone ? 'Thema wieder √∂ffnen' : 'Thema schlie√üen (erledigt)';
                  topicDetailPanel.innerHTML += `<div style="margin:6px 0 8px 0;"><button class="topic-status-toggle" data-topic-id="${topicDetail.id}" data-new-status="${newStatus}" style="background:${isDone ? '#3b82f6' : '#10b981'}; color:#fff; border:0; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">${btnLabel}</button></div>`;

                  // Toggle-Button f√ºr Status verkabeln
                  const toggleBtn = topicDetailPanel.querySelector('.topic-status-toggle');
                  if(toggleBtn){
                    toggleBtn.addEventListener('click', async () => {
                      const tgtId = toggleBtn.getAttribute('data-topic-id');
                      const ns = toggleBtn.getAttribute('data-new-status');
                      if(!tgtId || !ns){ return; }
                      toggleBtn.disabled = true;
                      try {
                        const resSt = await fetch(`/api/contacts/${contactId}/topics/${tgtId}/status`, {
                          method: 'POST',
                          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                          body: JSON.stringify({ status: ns })
                        });
                        const stData = await parseJsonSafe(resSt);
                        if(!stData.__ok){ throw new Error(stData.error || 'Status konnte nicht ge√§ndert werden'); }
                        // Quick Card nach Statuswechsel neu laden und Timeline/Open Topics aktualisieren
                        try{
                          const qcRes = await fetch(`/api/contacts/${contactId}/quick-card`, { headers: getAuthHeaders() });
                          const qcData = await parseJsonSafe(qcRes);
                          renderQuickCard(qcData);
                        }catch(_){ }
                        // Topic-Detail erneut laden, um neuen Status zu zeigen
                        await loadTopicDetail(topicId);
                      } catch(err) {
                        topicDetailPanel.innerHTML = `Fehler beim √Ñndern des Status: ${err}`;
                      }
                    });
                  }

                  // Klick auf E-Mail-Link: direkt zur entsprechenden Mail springen
                  topicDetailPanel.querySelectorAll('.topic-email-link').forEach(link => {
                    link.addEventListener('click', () => {
                      const eid = link.getAttribute('data-email-id');
                      if(!eid){ return; }
                      const listEl = document.getElementById('list');
                      if(!listEl){ return; }
                      const row = listEl.querySelector(`.item[data-uid="${eid}"]`);
                      if(row){
                        try{
                          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }catch(_){ }
                        selectItem(eid, row);
                      } else {
                        alert('Diese E-Mail ist nicht in der aktuellen Liste sichtbar.');
                      }
                    });
                  });
                } catch(e) {
                  topicDetailPanel.innerHTML = `Fehler: ${e}`;
                }
              };
            }
          } catch(e) {
            console.warn('Kontakt-Themen konnten nicht geladen werden', e);
          }
        }

        // Initiale Themen-Ladung beim √ñffnen der E-Mail
        if(t.contact_id){
          loadContactTopics(t.contact_id);
        }

        // Reply-Preferences des Kontakts f√ºr das Compose-Panel laden
        currentContactId = t.contact_id || null;
        currentContactName = contactName || null;
        currentContactEmail = contactEmail || null;
        if(currentContactId){
          loadComposeReplyPrefs(currentContactId, t);
        } else {
          const prefsTextEl = document.getElementById('compose_reply_prefs_text');
          if(prefsTextEl){
            prefsTextEl.textContent = 'Antwortstil: wird heuristisch aus bisherigen E-Mails abgeleitet (zuerst unsere Antworten, dann eingehende Mails).';
          }
        }
        
        // Quick Card (√úberblick) laden (mit einfachem Frontend-Cache pro Kontakt)
        if(t.contact_id){
          const contactIdStr = String(t.contact_id);
          window.quickCardCache = window.quickCardCache || {};

          const qcBox = document.getElementById('contact_quick_card');
          const qcName = document.getElementById('qc_name');
          const qcNow = document.getElementById('qc_now');
          const qcTopics = document.getElementById('qc_topics');
          const qcReply = document.getElementById('qc_reply');
          const qcReplyMode = document.getElementById('qc_reply_mode');
          const qcTimeline = document.getElementById('qc_timeline');
          const qcTone = document.getElementById('qc_tone');
          const topicDetailPanel = document.getElementById('contact_topic_detail_panel');

          function renderQuickCard(data){
            // Wenn einzelne Container (z.B. qcName) in diesem Layout nicht vorhanden sind,
            // Quick-Card-Rendering √ºberspringen, um JS-Fehler zu vermeiden.
            if(!qcBox || !qcName || !qcNow || !qcTopics || !qcReply || !qcReplyMode || !qcTimeline){
              return;
            }
            if(!data.__ok){
              qcNow.innerHTML = '<span class="muted">Keine aktuellen Hinweise</span>';
              qcTopics.innerHTML = '<span class="muted">Keine offenen Themen</span>';
              qcReply.style.display = 'none';
              qcReplyMode.style.display = 'none';
              qcTimeline.innerHTML = '<span style="font-weight:500;">Timeline:</span> <span class="muted">Keine Eintr√§ge</span>';
              return;
            }
            const who = data.who || '';
            const now = data.now_relevant || [];
            const topics = data.open_topics || [];
            const replyMode = data.reply_mode || '';
            const tone = data.tone || '';
            const timelineTopics = data.timeline_topics || [];
            const timeline = data.timeline || [];
            const role = data.role || '';
            const importanceBucket = (data.importance_bucket || '').toLowerCase();
            const langCode = (data.language_code || '').toLowerCase();
            const langLabel = data.language_label || '';

            qcBox.style.display = 'block';

            // Sprache im Kundenprofil-Header aktualisieren (falls Element vorhanden)
            try{
              const langEl = document.getElementById('contact_language_text');
              if(langEl){
                if(langLabel){
                  langEl.textContent = langLabel;
                } else if(langCode){
                  langEl.textContent = langCode;
                }
              }
            }catch(_e_lang_qc){}

            // Kopfzeile: Name ‚Äì Rolle (Kontakt-Typ)
            const emailLower = (contactEmail || '').toLowerCase();
            let contactType = '';
            if(emailLower.includes('@neckattack.')){
              contactType = 'interner Kontakt';
            }
            const displayName = who || contactName || contactEmail || 'Kontakt';
            const headerParts = [displayName];
            if(role){ headerParts.push(role); }
            if(contactType){ headerParts.push(`(${contactType})`); }

            // Badge f√ºr Wichtigkeit
            let badgeLabel = '';
            let badgeBg = '#e5e7eb';
            let badgeColor = '#4b5563';

            if(importanceBucket === 'focus'){
              badgeLabel = 'Fokus-Kontakt';
              badgeBg = '#dcfce7';
              badgeColor = '#166534';
            } else if(importanceBucket === 'unwichtig'){
              badgeLabel = 'Unwichtiger Kontakt';
              badgeBg = '#fee2e2';
              badgeColor = '#b91c1c';
            } else if(importanceBucket === 'normal'){
              badgeLabel = 'Normal';
            }

            let badgeHtml = '';
            if(badgeLabel){
              badgeHtml = `<div style="margin-top:2px;"><span style="display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:999px; font-size:10px; font-weight:500; background:${badgeBg}; color:${badgeColor};">${badgeLabel}</span></div>`;
            }

            qcName.innerHTML = `<div style="font-size:12px; font-weight:600; margin-bottom:2px;">${escapeHtml(headerParts.join(' ‚Äì '))}</div>${badgeHtml}`;

            // Jetzt relevant: ein Top-Thema + max. 2 sekund√§re Hinweise
            let primaryNow = '';
            const secondaryNow = [];
            if(now && now.length){
              primaryNow = now[0];
              secondaryNow.push(...now.slice(1,3));
            } else if(topics && topics.length){
              primaryNow = topics[0];
              secondaryNow.push(...topics.slice(1,3));
            }

            if(primaryNow){
              let nowHtml = '<div style="margin-top:4px;"><span style="font-weight:600;">Jetzt relevant (Priorit√§t):</span></div>';
              nowHtml += `<div style="margin-top:2px;">‚û°Ô∏è <span style="font-weight:500;">${escapeHtml(primaryNow)}</span></div>`;
              if(secondaryNow.length){
                nowHtml += '<div style="margin-top:6px; font-size:11px;"><span style="font-weight:500;">Sekund√§r relevant:</span><ul style="margin:2px 0 0 16px; padding:0;">';
                nowHtml += secondaryNow.map(x => `<li style="margin:0;">${escapeHtml(x)}</li>`).join('');
                nowHtml += '</ul></div>';
              }
              qcNow.innerHTML = nowHtml;
            } else {
              qcNow.innerHTML = '<span class="muted">Keine aktuellen Hinweise</span>';
            }

            // Offene Themen als Bullet-Liste
            if(topics && topics.length){
              let topicsHtml = '<div style="margin-top:8px;"><span style="font-weight:600;">Offene Themen:</span></div><ul style="list-style:none; padding-left:0; margin:0;">';
              topicsHtml += topics.map(x => `<li style="margin:0;">${escapeHtml(x)}</li>`).join('');
              topicsHtml += '</ul>';
              qcTopics.innerHTML = topicsHtml;
            } else {
              qcTopics.innerHTML = '<div style="margin-top:8px;"><span style="font-weight:600;">Offene Themen:</span> <span class="muted">Keine offenen Themen</span></div>';
            }

            // Antwort-Modus nur anzeigen, wenn das Backend einen sinnvollen Wert liefert.
            if(replyMode){
              let replyModeLabel = '';
              if(replyMode === 'last_only') replyModeLabel = 'Nur letzte E-Mail beantworten';
              else if(replyMode === 'last_plus_reminder') replyModeLabel = 'Letzte E-Mail + kurzes Erinnern an ein offenes Thema';
              else if(replyMode === 'follow_up_old_issue') replyModeLabel = 'Altes offenes Thema proaktiv aufgreifen';
              else replyModeLabel = replyMode;
              qcReplyMode.style.display = 'block';
              qcReplyMode.innerHTML = `<div style="margin-top:8px;"><span style="font-weight:600;">Antwort-Modus:</span> <span>${escapeHtml(replyModeLabel)}</span></div>`;
            } else {
              qcReplyMode.style.display = 'none';
            }

            // Timeline (Kurz)
            if(timelineTopics.length){
              // Checkbox-Zustand f√ºr geschlossene Themen auslesen (falls bereits vorhanden)
              const existingToggle = document.getElementById('qc_show_closed_topics');
              const showClosed = existingToggle ? existingToggle.checked : false;

              const filteredTopics = (showClosed ? timelineTopics : timelineTopics.filter(tp => tp.status !== 'done'));
              const items = filteredTopics.map((tp) => {
                const parts = [];
                if(tp.last_received_at){
                  const d = new Date(tp.last_received_at);
                  const ds = d.toLocaleDateString('de-DE', { day: '2-digit', month:'2-digit' });
                  parts.push(ds);
                }
                if(tp.label){ parts.push(tp.label); }
                if(tp.email_count){ parts.push(`${tp.email_count} E-Mails`); }
                let statusLabel = '';
                if(tp.status === 'open') statusLabel = 'offen';
                else if(tp.status === 'in_progress') statusLabel = 'in Bearbeitung';
                else if(tp.status === 'done') statusLabel = 'abgeschlossen';
                if(statusLabel){ parts.push(statusLabel); }
                const text = parts.join(' ‚Äì ');
                return `<div class="timeline-topic" data-topic-id="${tp.id}" style="padding:4px 6px; margin:2px 0; cursor:pointer; border-radius:4px; position:relative;" onmouseover="this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.backgroundColor='transparent';">
                  <div style="font-size:12px; font-weight:500;">${escapeHtml(text)}</div>
                  <span class="timeline-topic-close" data-topic-id="${tp.id}" style="position:absolute; right:4px; top:2px; color:#b91c1c; font-weight:bold; cursor:pointer;">√ó</span>
                </div>`;
              }).join('');

              qcTimeline.innerHTML = `<span style="font-weight:500;">Timeline (Kurz):</span>
                <div>${items}</div>
                <div style="margin-top:4px; font-size:10px; color:#6b7280;">
                  <label><input type="checkbox" id="qc_show_closed_topics" ${showClosed ? 'checked' : ''}> Geschlossene Themen anzeigen</label>
                </div>`;

              // Toggle f√ºr historische Themen (ein-/ausklappen und ggf. lazy load)
              const toggleClosed = document.getElementById('qc_show_closed_topics');
              if(toggleClosed){
                toggleClosed.addEventListener('change', () => {
                  renderQuickCard(data);
                });
              }

              // Click-Handler f√ºr Timeline-Themen
              const topicNodes = qcTimeline.querySelectorAll('.timeline-topic');
              topicNodes.forEach((node) => {
                node.addEventListener('click', async () => {
                  const topicId = node.getAttribute('data-topic-id');
                  await loadTopicDetail(topicId);
                });
              });

              // Mini-Schlie√üen-Buttons (rotes X) in der Timeline
              const closeButtons = qcTimeline.querySelectorAll('.timeline-topic-close');
              closeButtons.forEach(btn => {
                btn.addEventListener('click', async (ev) => {
                  ev.stopPropagation();
                  const tid = btn.getAttribute('data-topic-id');
                  if(!tid){ return; }
                  try {
                    const resSt = await fetch(`/api/contacts/${t.contact_id}/topics/${tid}/status`, {
                      method: 'POST',
                      headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                      body: JSON.stringify({ status: 'done' })
                    });
                    const stData = await parseJsonSafe(resSt);
                    if(!stData.__ok){ throw new Error(stData.error || 'Status konnte nicht ge√§ndert werden'); }
                    // Quick-Card neu laden, damit Timeline und offene Themen aktualisiert werden
                    const qcRes = await fetch(`/api/contacts/${t.contact_id}/quick-card`, { headers: getAuthHeaders() });
                    const qcData = await parseJsonSafe(qcRes);
                    renderQuickCard(qcData);
                  } catch(err){
                    alert('Fehler beim Schlie√üen des Themas: ' + err);
                  }
                });
              });
            } else if(timeline.length){
              const tl = timeline.map(x => `<div>${escapeHtml(x)}</div>`).join('');
              qcTimeline.innerHTML = `<span style="font-weight:500;">Timeline:</span> <div>${tl}</div>`;
            } else {
              qcTimeline.innerHTML = '<span style="font-weight:500;">Timeline:</span> <span class="muted">Keine Eintr√§ge</span>';
            }
          }

          if(qcBox && qcNow && qcTopics && qcReplyMode && qcTimeline){
            qcBox.style.display = 'block';

            const cached = window.quickCardCache[contactIdStr];
            if(cached){
              // Sofort aus Cache rendern, ohne erneuten API-Call
              renderQuickCard(cached);
            } else {
              // Erstladen: Platzhalter anzeigen und Quick-Card vom Server holen
              qcNow.innerHTML = '<span style="font-weight:500;">Jetzt relevant:</span> <span class="muted">Lade...</span>';
              qcTopics.innerHTML = '<span style="font-weight:500;">Offene Themen:</span> <span class="muted">Lade...</span>';
              qcReply.innerHTML = '<span style="font-weight:500;">Empfohlene Antwortstrategie:</span> <span class="muted">Lade...</span>';
              qcReplyMode.innerHTML = '<span style="font-weight:500;">Antwort-Modus:</span> <span class="muted">Lade...</span>';
              if(qcTone){
                qcTone.innerHTML = '<span style="font-weight:500;">Ton &amp; Stil:</span> <span class="muted">Lade...</span>';
              }
              qcTimeline.innerHTML = '<span style="font-weight:500;">Timeline:</span> <span class="muted">Lade...</span>';
              fetch(`/api/contacts/${t.contact_id}/quick-card`, { headers: getAuthHeaders() })
                .then(res => parseJsonSafe(res))
                .then(data => {
                  // Im Cache speichern und rendern
                  window.quickCardCache[contactIdStr] = data;
                  renderQuickCard(data);
                })
                .catch(err => {
                  console.error('Quick-Card konnte nicht geladen werden:', err);
                  if(qcName){
                    qcName.innerHTML = '<span class="muted">Keine Profildaten verf√ºgbar</span>';
                  }
                  qcNow.innerHTML = '<span class="muted">Keine aktuellen Hinweise</span>';
                  qcTopics.innerHTML = '<span class="muted">Keine offenen Themen</span>';
                  qcReply.innerHTML = '';
                  qcTone.innerHTML = '<span style="font-weight:500;">Ton &amp; Stil:</span> <span class="muted">Unbekannt</span>';
                  qcTimeline.innerHTML = '<span style="font-weight:500;">Timeline:</span> <span class="muted">Keine Eintr√§ge</span>';
                });
            }
          }
        }
        
        // Event handler for "Generate profile" (Kurzprofil)
        const generateBtn = document.getElementById('generate_profile_btn');
        const summaryDiv = document.getElementById('prof_summary');
        const fullSummaryDiv = document.getElementById('prof_summary_full');

        if(generateBtn && t.contact_id){
          generateBtn.onclick = async () => {
            const originalText = generateBtn.textContent;
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generiere...';
            if(summaryDiv){
              summaryDiv.textContent = 'Analysiere E-Mails und aktualisiere Kundenprofil...';
              summaryDiv.style.background = '#fef3c7';
              summaryDiv.style.display = 'none';
            }
            if(fullSummaryDiv){
              fullSummaryDiv.style.display = 'block';
              fullSummaryDiv.textContent = 'Erzeuge ausf√ºhrliches Gesamtprofil...';
              fullSummaryDiv.style.background = '#f9fafb';
            }
            
            try{
              // 1) Kurzprofil/KPIs/Topics aktualisieren
              const res = await fetch(`/api/contacts/${t.contact_id}/generate-profile`, {
                method: 'POST',
                headers: getAuthHeaders()
              });
              const data = await parseJsonSafe(res);
              
              if(data.__ok && data.summary){
                if(summaryDiv){
                  summaryDiv.innerHTML = formatCustomerProfile(data.summary);
                  summaryDiv.style.background = '#f0fdf4';
                  summaryDiv.style.display = 'block';
                }
                // KPI-Chips (inkl. Kategorie) aktualisieren, falls vom Server geliefert
                if(data.kpis){
                  const k = data.kpis || {};
                  const chips = document.getElementById('contact_kpi_chips');
                  if(chips){
                    let htmlChips = '';
                    if(k.salutation){
                      // Wenn Kategorie klar Kollege/Mitarbeiter ist, interpretieren wir
                      // eine unklare Anrede pragmatisch als "Du".
                      let salLabel = k.salutation;
                      if((k.category === 'Kollege/Mitarbeiter') && (k.salutation === 'Unklar' || k.salutation === 'Neutral')){
                        salLabel = 'Du (Kolleg*in)';
                      }
                      htmlChips += `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:#dbeafe; color:#1e40af; border-radius:4px; font-size:11px; font-weight:500;">üëã Anrede: ${salLabel}</span>`;
                    }
                    if(k.sentiment){
                      const sentBg = k.sentiment === 'positive' ? '#d1fae5;color:#065f46' : k.sentiment === 'negative' ? '#fee2e2;color:#991b1b' : '#f3f4f6;color:#374151';
                      const sentEmoji = k.sentiment === 'positive' ? 'üòä' : k.sentiment === 'negative' ? 'üòü' : 'üòê';
                      const sentLabel = k.sentiment === 'positive' ? 'Positiv' : k.sentiment === 'negative' ? 'Negativ' : 'Neutral';
                      htmlChips += `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:${sentBg}; border-radius:4px; font-size:11px; font-weight:500;">${sentEmoji} Stimmung: ${sentLabel}</span>`;
                    }
                    // E-Mail-L√§nge und Kontaktfrequenz vorerst nicht anzeigen, um UI schlank zu halten
                    if(k.category){
                      htmlChips += `<span style=\"display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:#fee2e2; color:#b91c1c; border-radius:4px; font-size:11px; font-weight:500;\">üè∑ Kategorie: ${k.category}</span>`;
                    }
                    chips.innerHTML = htmlChips;
                  }
                }
                // Nach erfolgreicher Profil-Generierung auch die Themen/Beschriftungen neu laden
                if(t.contact_id){
                  loadContactTopics(t.contact_id);
                }
                // Quick Card nachziehen
                if(t.contact_id){
                  // Einfach erneut quick-card laden
                  fetch(`/api/contacts/${t.contact_id}/quick-card`, { headers: getAuthHeaders() })
                    .then(res => parseJsonSafe(res))
                    .then((dataQC) => {
                      // Quick-Card-Cache aktualisieren und neu rendern
                      const cid = String(t.contact_id);
                      window.quickCardCache = window.quickCardCache || {};
                      window.quickCardCache[cid] = dataQC;
                      renderQuickCard(dataQC);
                    })
                    .catch(() => {});
                }

                // 2) Direkt im Anschluss das Gesamtprofil aktualisieren
                try {
                  const resFull = await fetch(`/api/contacts/${t.contact_id}/generate-profile-full`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                  });
                  const dataFull = await parseJsonSafe(resFull);
                  if(dataFull.__ok && dataFull.summary_full && fullSummaryDiv){
                    fullSummaryDiv.innerHTML = formatCustomerProfile(dataFull.summary_full);
                    fullSummaryDiv.style.background = '#eef2ff';
                  }
                } catch(eFull){
                  if(fullSummaryDiv){
                    fullSummaryDiv.textContent = `‚ùå Fehler beim Gesamtprofil: ${eFull}`;
                    fullSummaryDiv.style.background = '#fee2e2';
                  }
                }

                generateBtn.textContent = 'üîÑ Profil aktualisieren';
                generateBtn.disabled = false;
              } else {
                throw new Error(data.error || 'Profil-Generierung fehlgeschlagen');
              }
            }catch(e){
              if(summaryDiv){
                summaryDiv.textContent = `‚ùå Fehler: ${e}`;
                summaryDiv.style.background = '#fee2e2';
                summaryDiv.style.display = 'block';
              }
              generateBtn.textContent = originalText;
              generateBtn.disabled = false;
            }
          };
        }
        
        // Zweiter Auto-Read-Timer ebenfalls deaktiviert: gelesen/ungelesen wird aktuell
        // nur noch durch explizite Aktionen (Kontextmen√º / Read-Toggle) gesetzt.
        if(autoReadTimer){
          clearTimeout(autoReadTimer);
          autoReadTimer = null;
        }

        // Auto-Read: Mail nach 2 Sekunden Ansicht automatisch als gelesen markieren
        if(autoReadTimer){
          clearTimeout(autoReadTimer);
          autoReadTimer = null;
        }
        autoReadUid = uid;
        try {
          // Nur ungelesene Mails automatisch markieren
          if(!t.is_read){
            autoReadTimer = setTimeout(async () => {
              try{
                // Sicherstellen, dass der User immer noch auf derselben Mail ist
                if(autoReadUid !== uid){
                  return;
                }
                await fetch('/api/emails/seen', {
                  method: 'POST',
                  headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                  body: JSON.stringify({ uid: uid, seen: true })
                });
                // Lokale Liste aktualisieren
                try{
                  if(Array.isArray(inboxEmails)){
                    const item = inboxEmails.find(e => e.uid === uid);
                    if(item){ item.is_read = 1; }
                  }
                }catch(_e_upd_local){}
                // Aktuelle Zeilenklasse aktualisieren
                try{
                  const row = document.querySelector(`.item[data-uid="${uid}"]`);
                  if(row){ row.classList.remove('unseen'); }
                }catch(_e_row){}
              }catch(_e_seen_auto){}
            }, 2000);
          }
        } catch(_e_auto_init){}
      }catch(e){
        detail.innerHTML = `<div class="sub">Fehler: ${e}</div>`;
      }
    }

    function formatReplyPrefsLabel(prefs, contactName, contactEmail){
      try{
        if(!prefs){
          return 'Antwortstil: wird heuristisch aus bisherigen E-Mails abgeleitet (zuerst unsere Antworten, dann eingehende Mails).';
        }
        const parts = [];

        const len = prefs.length_level;
        if(typeof len === 'number'){
          if(len <= 1) parts.push('sehr kurz (1/5)');
          else if(len === 2) parts.push('kurz (2/5)');
          else if(len === 3) parts.push('mittel (3/5)');
          else if(len === 4) parts.push('lang (4/5)');
          else parts.push('sehr ausf√ºhrlich (5/5)');
        }

        const form = prefs.formality_level;
        if(typeof form === 'number'){
          if(form <= 1) parts.push('sehr locker');
          else if(form === 2) parts.push('eher locker');
          else if(form === 3) parts.push('neutral');
          else if(form === 4) parts.push('eher formell');
          else parts.push('sehr formell/h√∂flich');
        }

        const sal = (prefs.salutation_mode || '').toLowerCase();
        if(sal === 'du') parts.push('Anrede: Du');
        else if(sal === 'sie') parts.push('Anrede: Sie');

        const persona = (prefs.persona_mode || '').toLowerCase();
        if(persona === 'ich') parts.push('Ich-Form');
        else if(persona === 'wir') parts.push('Wir-Form');

        const src = prefs.style_source || 'default/auto';
        const who = contactName || contactEmail || '';

        if(!parts.length){
          return `Antwortstil: wird heuristisch aus bisherigen E-Mails abgeleitet${who ? ' ‚Äì Kontakt: ' + who : ''} (Quelle: ${src}).`;
        }

        return `Antwortstil: ${parts.join(', ')}${who ? ' ‚Äì Kontakt: ' + who : ''} (Quelle: ${src}, basierend auf bisherigen E-Mails).`;
      }catch(_e){
        return 'Antwortstil: wird heuristisch aus bisherigen E-Mails abgeleitet (Fehler beim Laden der Kontakt-Einstellungen).';
      }
    }

    // Hilfsfunktionen f√ºr Compose-Reply-Panel (Slider/Toggles)
    function cmpLabelForLength(v){
      const n = parseInt(v, 10) || 3;
      if(n <= 1) return 'sehr kurz (1/5)';
      if(n === 2) return 'kurz (2/5)';
      if(n === 3) return 'mittel (3/5)';
      if(n === 4) return 'lang (4/5)';
      return 'sehr ausf√ºhrlich (5/5)';
    }
    function cmpLabelForFormality(v){
      const n = parseInt(v, 10) || 3;
      if(n <= 1) return 'sehr locker (1/5)';
      if(n === 2) return 'eher locker (2/5)';
      if(n === 3) return 'neutral (3/5)';
      if(n === 4) return 'eher formell (4/5)';
      return 'sehr formell/h√∂flich (5/5)';
    }
    function cmpSetToggleActive(btn, active){
      if(!btn) return;
      if(active){
        btn.style.background = '#111827';
        btn.style.color = '#ffffff';
        btn.style.borderColor = '#111827';
      } else {
        btn.style.background = '#f9fafb';
        btn.style.color = '#111827';
        btn.style.borderColor = '#d1d5db';
      }
    }

    let cmpSelectedSal = null;
    let cmpSelectedPers = null;
    let cmpAutosaveTimer = null;

    async function loadComposeReplyPrefs(contactId, emailSummary){
      const blockEl = document.getElementById('compose_reply_prefs_block');
      const statusEl = document.getElementById('compose_reply_prefs_status');
      const labelEl = document.getElementById('compose_reply_prefs_label');
      const dbgGreetingEl = document.getElementById('compose_debug_greeting');
      const dbgClosingEl = document.getElementById('compose_debug_closing');
      const dbgContactIdEl = document.getElementById('compose_debug_contact_id');
      const dbgContactEmailEl = document.getElementById('compose_debug_contact_email');
      const dbgContactNameEl = document.getElementById('compose_debug_contact_name');
      const dbgStyleSourceEl = document.getElementById('compose_debug_style_source');
      const dbgLengthEl = document.getElementById('compose_debug_length');
      const dbgFormalityEl = document.getElementById('compose_debug_formality');
      const dbgSalutationEl = document.getElementById('compose_debug_salutation');
      const dbgPersonaEl = document.getElementById('compose_debug_persona');
      const dbgWarningsEl = document.getElementById('compose_debug_warnings');
      const dbgHistoryEl = document.getElementById('compose_debug_history');
      const cpnBlock = document.getElementById('contact_profile_new_block');
      const cpnImpEl = document.getElementById('cpn_importance');
      const cpnSalEl = document.getElementById('cpn_salutation_text');
      const cpnSourceEl = document.getElementById('cpn_style_source');
      const cpnLenEl = document.getElementById('cpn_length');
      const cpnFormEl = document.getElementById('cpn_formality');
      const cpnPersEl = document.getElementById('cpn_persona');
      const cpnGreetEl = document.getElementById('cpn_greeting');
      const cpnCloseEl = document.getElementById('cpn_closing');
      const lenInput = document.getElementById('cmp_length');
      const formInput = document.getElementById('cmp_formality');
      const lenLabel = document.getElementById('cmp_length_label');
      const formLabel = document.getElementById('cmp_formality_label');
      const salDu = document.getElementById('cmp_sal_du');
      const salSie = document.getElementById('cmp_sal_sie');
      const persIch = document.getElementById('cmp_pers_ich');
      const persWir = document.getElementById('cmp_pers_wir');
      const saveBtn = null; // Speichern-Button entfernt, wir nutzen Auto-Save

      if(!blockEl){ return; }

      // Basis-Initialisierung der Slider-Labels
      if(lenInput && lenLabel){ lenLabel.textContent = cmpLabelForLength(lenInput.value); }
      if(formInput && formLabel){ formLabel.textContent = cmpLabelForFormality(formInput.value); }

      if(!contactId){
        if(statusEl){
          statusEl.textContent = 'Antwortstil: Kontakt unbekannt, es gelten globale Defaults.';
          statusEl.style.color = '#6b7280';
        }
        if(dbgContactIdEl){ dbgContactIdEl.textContent = '(kein Kontakt)'; }
        if(dbgGreetingEl){ dbgGreetingEl.textContent = '(kein Kontakt / keine Daten)'; }
        if(dbgClosingEl){ dbgClosingEl.textContent = '(kein Kontakt / keine Daten)'; }
        if(dbgWarningsEl){ dbgWarningsEl.textContent = 'Hinweis: Kein Kontakt verkn√ºpft ‚Äì Reply-Prefs k√∂nnen nicht geladen werden.'; }
        return;
      }

      if(statusEl){
        statusEl.textContent = 'Antwortstil: Lade Kontakt-Einstellungen‚Ä¶';
        statusEl.style.color = '#6b7280';
      }

      try{
        const res = await fetch(`/api/contacts/${contactId}/reply-prefs`, { headers: getAuthHeaders() });
        const data = await res.json();
        if(!data || data.error){
          if(statusEl){
            statusEl.textContent = 'Antwortstil: Fehler ‚Äì ' + (data && data.error ? data.error : 'Unbekannt');
            statusEl.style.color = '#dc2626';
          }
          if(dbgGreetingEl){ dbgGreetingEl.textContent = '(Fehler beim Laden)'; }
          if(dbgClosingEl){ dbgClosingEl.textContent = '(Fehler beim Laden)'; }
          return;
        }
        const prefs = data.preferences || {};

        currentReplyPrefs = {
          greeting_template: prefs.greeting_template,
          closing_template: prefs.closing_template,
          length_level: typeof prefs.length_level === 'number' ? prefs.length_level : null,
          formality_level: typeof prefs.formality_level === 'number' ? prefs.formality_level : null,
          salutation_mode: prefs.salutation_mode || null,
          persona_mode: prefs.persona_mode || null,
          style_source: prefs.style_source || 'default',
          language_code: (prefs.language_code || '').toString().trim().toLowerCase() || null,
          language_label: (prefs.language_label || '').toString().trim() || null
        };

        // Slider-Werte setzen
        if(lenInput){
          const v = currentReplyPrefs.length_level || 3;
          lenInput.value = String(v);
          if(lenLabel) lenLabel.textContent = cmpLabelForLength(v);
        }
        if(formInput){
          const v = currentReplyPrefs.formality_level || 3;
          formInput.value = String(v);
          if(formLabel) formLabel.textContent = cmpLabelForFormality(v);
        }

        // Toggles setzen
        cmpSelectedSal = (currentReplyPrefs.salutation_mode || '').toLowerCase() || null;
        cmpSetToggleActive(salDu, cmpSelectedSal === 'du');
        cmpSetToggleActive(salSie, cmpSelectedSal === 'sie');

        cmpSelectedPers = (currentReplyPrefs.persona_mode || '').toLowerCase() || null;
        cmpSetToggleActive(persIch, cmpSelectedPers === 'ich');
        cmpSetToggleActive(persWir, cmpSelectedPers === 'wir');

        // Zusammenfassendes Label inkl. Sprache setzen
        if(labelEl){
          const parts = [];
          // Bestehende Stilbeschreibung
          try{
            const len = currentReplyPrefs.length_level;
            const form = currentReplyPrefs.formality_level;
            if(typeof len === 'number'){
              parts.push('L e4nge ' + cmpLabelForLength(len));
            }
            if(typeof form === 'number'){
              parts.push('Formalit e4t ' + cmpLabelForFormality(form));
            }
          }catch(_e_lenform){}

          // Sprache aus Preferences anh e4ngen
          try{
            const langLabel = currentReplyPrefs.language_label;
            const langCode = currentReplyPrefs.language_code;
            if(langLabel || langCode){
              parts.push('Sprache ' + (langLabel || langCode));
            }
          }catch(_e_lang_lbl){}

          if(parts.length){
            labelEl.textContent = parts.join('  b7 ');
            labelEl.style.display = 'block';
          } else {
            labelEl.textContent = '';
            labelEl.style.display = 'none';
          }
        }

        if(labelEl){
          labelEl.textContent = formatReplyPrefsLabel(currentReplyPrefs, emailSummary && emailSummary.contact_name, emailSummary && emailSummary.from);
        }

        // Neue Kundenprofil-Kachel (oben im Kundenprofil) bef√ºllen, falls vorhanden
        if(cpnBlock){
          cpnBlock.style.display = 'block';
          if(cpnImpEl){
            const impBadge = document.getElementById('contact_importance_badge');
            const impLink = document.getElementById('contact_importance_link');
            cpnImpEl.textContent = impBadge && impBadge.textContent ? impBadge.textContent : '‚Äì';
            if (impLink) {
              const cpnImpLink = document.createElement('a');
              cpnImpLink.href = impLink.href;
              cpnImpLink.textContent = 'Bearbeiten';
              cpnImpEl.appendChild(cpnImpLink);
            }
          }
          if(cpnSalEl){
            const sm = (currentReplyPrefs.salutation_mode || '').toLowerCase();
            cpnSalEl.textContent = sm === 'du' ? 'Du' : (sm === 'sie' ? 'Sie' : '‚Äì');
          }
          if(cpnSourceEl){
            const src = (currentReplyPrefs.style_source || '').toLowerCase();
            let label = src || '(unbekannt)';
            if(src === 'history_llm') label = 'aus E-Mail-Historie (KI)';
            else if(src === 'manual') label = 'manuell angepasst';
            else if(src === 'default') label = 'Standard-Einstellungen';
            cpnSourceEl.textContent = label;
          }
          if(cpnLenEl){
            const v = currentReplyPrefs.length_level != null ? currentReplyPrefs.length_level : null;
            cpnLenEl.textContent = v != null ? cmpLabelForLength(v) : '‚Äì';
          }
          if(cpnFormEl){
            const v = currentReplyPrefs.formality_level != null ? currentReplyPrefs.formality_level : null;
            cpnFormEl.textContent = v != null ? cmpLabelForFormality(v) : '‚Äì';
          }
          if(cpnPersEl){
            const pm = (currentReplyPrefs.persona_mode || '').toLowerCase();
            if(pm === 'ich') cpnPersEl.textContent = 'Ich-Perspektive';
            else if(pm === 'wir') cpnPersEl.textContent = 'Wir-Perspektive';
            else cpnPersEl.textContent = '‚Äì';
          }
          if(cpnGreetEl){
            const gt = currentReplyPrefs.greeting_template || '';
            cpnGreetEl.textContent = gt ? gt : '‚Äì';
          }
          if(cpnCloseEl){
            const ct = currentReplyPrefs.closing_template || '';
            cpnCloseEl.textContent = ct ? ct : '‚Äì';
          }
        }

        // Debug-Felder: Rohwerte aus Kontakt + Reply-Prefs anzeigen
        const contactName = (emailSummary && emailSummary.contact_name) || '';
        const fromAddr = (emailSummary && emailSummary.from) || '';
        const fromEmailMatch = fromAddr.match(/<([^>]+)>/);
        const fromEmail = fromEmailMatch ? fromEmailMatch[1] : '';
        const contactEmail = (prefs && prefs.contact_email) || (emailSummary && emailSummary.contact_email) || fromEmail || fromAddr || '';

        if(dbgContactIdEl){ dbgContactIdEl.textContent = String(contactId); }
        if(dbgContactEmailEl){ dbgContactEmailEl.textContent = contactEmail || '(unbekannt)'; }
        if(dbgContactNameEl){ dbgContactNameEl.textContent = contactName || '(unbekannt)'; }
        if(dbgStyleSourceEl){ dbgStyleSourceEl.textContent = currentReplyPrefs.style_source || '(unbekannt)'; }
        if(dbgLengthEl){ dbgLengthEl.textContent = (currentReplyPrefs.length_level != null ? String(currentReplyPrefs.length_level) : '(NULL)'); }
        if(dbgFormalityEl){ dbgFormalityEl.textContent = (currentReplyPrefs.formality_level != null ? String(currentReplyPrefs.formality_level) : '(NULL)'); }
        if(dbgSalutationEl){ dbgSalutationEl.textContent = currentReplyPrefs.salutation_mode || '(NULL)'; }
        if(dbgPersonaEl){ dbgPersonaEl.textContent = currentReplyPrefs.persona_mode || '(NULL)'; }

        if(dbgGreetingEl){
          const v = currentReplyPrefs.greeting_template;
          dbgGreetingEl.textContent = v ? String(v) : '(NULL / nicht gesetzt)';
        }
        if(dbgClosingEl){
          const v = currentReplyPrefs.closing_template;
          dbgClosingEl.textContent = v ? String(v) : '(NULL / nicht gesetzt)';
        }

        if(statusEl){
          const src = currentReplyPrefs.style_source || 'default/auto';
          statusEl.textContent = `Quelle: ${src}`;
          statusEl.style.color = '#6b7280';
        }

        // Wichtige Hinweise/Warnungen f√ºr die manuelle Kontrolle sammeln
        if(dbgWarningsEl){
          const warnings = [];
          if(!fromEmail){
            warnings.push('- Kein Absender / keine Kontakt-E-Mail erkannt.');
          }
          if(currentReplyPrefs.length_level == null && currentReplyPrefs.formality_level == null &&
             !currentReplyPrefs.salutation_mode && !currentReplyPrefs.persona_mode){
            warnings.push('- Keine Reply-Prefs gesetzt (alle Werte NULL).');
          }
          if(currentReplyPrefs.salutation_mode && !['du','sie'].includes(currentReplyPrefs.salutation_mode.toLowerCase())){
            warnings.push(`- salutation_mode hat einen unerwarteten Wert: "${currentReplyPrefs.salutation_mode}"`);
          }
          if(currentReplyPrefs.persona_mode && !['ich','wir'].includes(currentReplyPrefs.persona_mode.toLowerCase())){
            warnings.push(`- persona_mode hat einen unerwarteten Wert: "${currentReplyPrefs.persona_mode}"`);
          }
          if(!currentReplyPrefs.greeting_template && !currentReplyPrefs.closing_template){
            warnings.push('- Weder greeting_template noch closing_template gesetzt.');
          }

          dbgWarningsEl.textContent = warnings.length ? warnings.join('\n') : '';
        }

        // History-Debug-Button: ruft den neuen Debug-Endpoint auf und zeigt das JSON an
        const historyBtn = document.getElementById('compose_debug_history_btn');
        if(historyBtn && dbgHistoryEl && contactId){
          historyBtn.onclick = async () => {
            dbgHistoryEl.style.display = 'block';
            dbgHistoryEl.textContent = 'Lade History-Debug‚Ä¶';
            try{
              const res = await fetch(`/api/contacts/${contactId}/reply-prefs/debug`, { headers: getAuthHeaders() });
              const data = await parseJsonSafe(res);
              dbgHistoryEl.textContent = JSON.stringify(data, null, 2);
            }catch(e_dbg){
              dbgHistoryEl.textContent = 'Fehler beim Laden des History-Debug: ' + e_dbg;
            }
          };
        }

        function scheduleComposePrefsAutosave(){
          if(!statusEl) return;
          statusEl.textContent = 'Antwortstil: √Ñnderungen werden gespeichert‚Ä¶';
          statusEl.style.color = '#6b7280';
          if(cmpAutosaveTimer){
            clearTimeout(cmpAutosaveTimer);
          }
          cmpAutosaveTimer = setTimeout(async () => {
            try{
              await autosaveComposeReplyPrefs();
              statusEl.textContent = 'Antwortstil: Gespeichert (Quelle: manual).';
              statusEl.style.color = '#16a34a';
            }catch(_e){
              statusEl.textContent = 'Antwortstil: Fehler beim Speichern.';
              statusEl.style.color = '#dc2626';
            }
          }, 1000);
        }

        // Event-Handler nur einmal registrieren
        if(lenInput && !lenInput.dataset.cmpAttached){
          lenInput.addEventListener('input', () => {
            if(lenLabel) lenLabel.textContent = cmpLabelForLength(lenInput.value);
            scheduleComposePrefsAutosave();
          });
          lenInput.dataset.cmpAttached = '1';
        }
        if(formInput && !formInput.dataset.cmpAttached){
          formInput.addEventListener('input', () => {
            if(formLabel) formLabel.textContent = cmpLabelForFormality(formInput.value);
            scheduleComposePrefsAutosave();
          });
          formInput.dataset.cmpAttached = '1';
        }
        if(salDu && salSie && !salDu.dataset.cmpAttached){
          salDu.addEventListener('click', () => {
            cmpSelectedSal = (cmpSelectedSal === 'du') ? null : 'du';
            cmpSetToggleActive(salDu, cmpSelectedSal === 'du');
            cmpSetToggleActive(salSie, cmpSelectedSal === 'sie');
            scheduleComposePrefsAutosave();
          });
          salSie.addEventListener('click', () => {
            cmpSelectedSal = (cmpSelectedSal === 'sie') ? null : 'sie';
            cmpSetToggleActive(salDu, cmpSelectedSal === 'du');
            cmpSetToggleActive(salSie, cmpSelectedSal === 'sie');
            scheduleComposePrefsAutosave();
          });
          salDu.dataset.cmpAttached = '1';
          salSie.dataset.cmpAttached = '1';
        }
        if(persIch && persWir && !persIch.dataset.cmpAttached){
          persIch.addEventListener('click', () => {
            cmpSelectedPers = (cmpSelectedPers === 'ich') ? null : 'ich';
            cmpSetToggleActive(persIch, cmpSelectedPers === 'ich');
            cmpSetToggleActive(persWir, cmpSelectedPers === 'wir');
            scheduleComposePrefsAutosave();
          });
          persWir.addEventListener('click', () => {
            cmpSelectedPers = (cmpSelectedPers === 'wir') ? null : 'wir';
            cmpSetToggleActive(persIch, cmpSelectedPers === 'ich');
            cmpSetToggleActive(persWir, cmpSelectedPers === 'wir');
            scheduleComposePrefsAutosave();
          });
          persIch.dataset.cmpAttached = '1';
          persWir.dataset.cmpAttached = '1';
        }

      }catch(e){
        if(statusEl){
          statusEl.textContent = 'Antwortstil: Fehler ‚Äì ' + e;
          statusEl.style.color = '#dc2626';
        }
      }
    }

    function isComposeEmpty(){
      const editor = document.getElementById('compose_editor');
      if(!editor) return true;
      const htmlNow = (editor.innerHTML || '').trim();
      const textNow = (editor.textContent || '').trim();
      // Initialplatzhalter oder komplett leer gilt als "leer"
      if(!htmlNow || /Hier erscheint der Vorschlag/i.test(htmlNow) || /Hier erscheint der Vorschlag/i.test(textNow)){
        return true;
      }
      return textNow.length === 0;
    }

    function prefillComposeShell(){
      const editor = document.getElementById('compose_editor');
      if(!editor) return;
      if(!isComposeEmpty()) return; // nichts √ºberschreiben, falls schon Inhalt da ist

      // Kontaktname & E-Mail aus dem aktuellen Kontext
      const fullName = (currentContactName || '').trim();
      const email = (currentContactEmail || '').trim();
      const displayName = fullName || (email ? email.split('@')[0] : 'Kunde');

      // Aus Reply-Prefs (falls geladen) ableiten, ob eher Du oder Sie benutzt wird.
      let salMode = null;
      try{
        salMode = (currentReplyPrefs && currentReplyPrefs.salutation_mode || '').toLowerCase() || null;
      }catch(_e_sal){}

      // F√ºr Du-Anrede den Vornamen verwenden, falls m√∂glich.
      let firstName = '';
      if(fullName){
        const parts = fullName.split(/\s+/).filter(Boolean);
        if(parts.length > 0){
          firstName = parts[0];
        }
      }
      const nameForTemplate = salMode === 'du' ? (firstName || displayName) : displayName;

      // Begr√º√üung aus Reply-Prefs, falls vorhanden; sonst einfacher Fallback
      let greetingText = '';
      if(currentReplyPrefs && currentReplyPrefs.greeting_template){
        let tpl = String(currentReplyPrefs.greeting_template || '');
        tpl = tpl.replace(/<\s*Name\s*>/gi, nameForTemplate || '');
        greetingText = tpl;
      } else {
        let greetingWord = 'Hallo';
        if(salMode === 'sie'){
          greetingWord = 'Guten Tag';
        }
        greetingText = `${greetingWord} ${nameForTemplate || displayName},`;
      }

      // Abschluss aus Reply-Prefs, falls vorhanden; sonst Fallback.
      let closingText = '';
      if(currentReplyPrefs && currentReplyPrefs.closing_template){
        closingText = String(currentReplyPrefs.closing_template || '');
      } else {
        closingText = 'Viele Gr√º√üe';
      }

      // Eigener Name als Platzhalterersatz (z.B. "LG <Eigenes Name>")
      try{
        const user = getCurrentUser && getCurrentUser();
        let selfName = '';
        if(user){
          selfName = (user.first_name || user.name || user.full_name || '').trim();
        }
        if(selfName){
          closingText = closingText.replace(/<\s*Eigenes\s+Name\s*>/gi, selfName)
                                   .replace(/<\s*Eigener\s+Name\s*>/gi, selfName);
        }
      }catch(_e_self){}

      const greetingHtml = `<p data-role="greeting">${escapeHtml(greetingText)}</p>`;
      const closingHtml = `<p data-role="closing">${escapeHtml(closingText)}</p>`;

      // Optional vorbereitete Signatur aus den Einstellungen anh√§ngen
      let signatureBlock = '';
      try{
        const sigRaw = (currentSignatureHtml || '').trim();
        if(sigRaw){
          if(/</.test(sigRaw)){
            // Enth√§lt HTML (z.B. <img>-Tag) ‚Äì Zeilenumbr√ºche in <br> umwandeln
            // damit der Text unterhalb des Bildes im Editor wie im Textfeld wirkt.
            signatureBlock = sigRaw.replace(/\n/g, '<br>');
          } else {
            // Plain-Text-Signatur in HTML-Absatz(e) umwandeln
            const escaped = escapeHtml(sigRaw).replace(/\n/g, '<br>');
            signatureBlock = `<p>${escaped}</p>`;
          }
        }
      }catch(_e_sig_conv){}

      // Struktur (kompakt, typischer Absatzabstand kommt aus CSS):
      // 0: Begr√º√üung
      // 1: Body-Absatz (leer, Cursor hier)
      // 2: Abschluss
      // 3: optionale Signatur
      editor.innerHTML =
        greetingHtml +
        '<p><br></p>' +
        closingHtml +
        (signatureBlock || '');

      // Cursor in den Body-Absatz setzen (Index 1)
      try{
        const sel = window.getSelection();
        if(!sel) return;
        const paragraphs = editor.querySelectorAll('p');
        const bodyP = paragraphs[1];
        if(!bodyP) return;
        const range = document.createRange();
        range.selectNodeContents(bodyP);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }catch(_e_caret){}
    }

    async function autosaveComposeReplyPrefs(){
      try{
        if(!currentContactId){ return; }
        const lenInput = document.getElementById('cmp_length');
        const formInput = document.getElementById('cmp_formality');
        const payload = { style_source: 'manual' };
        if(lenInput){ payload.length_level = parseInt(lenInput.value, 10) || 3; }
        if(formInput){ payload.formality_level = parseInt(formInput.value, 10) || 3; }
        payload.salutation_mode = cmpSelectedSal;
        payload.persona_mode = cmpSelectedPers;
        await fetch(`/api/contacts/${currentContactId}/reply-prefs`, {
          method: 'POST',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }catch(_e){ /* Best Effort */ }
    }

    async function proposeDraft(force=false){
      const composeEl = document.getElementById('compose');
      if(composeEl && !composeEl.classList.contains('open')){
        composeEl.classList.add('open');
        // Beim ersten √ñffnen einen einfachen Begr√º√üungs-Shell einf√ºgen
        prefillComposeShell();
      }
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      if(!currentUid){ status.textContent = 'Bitte zuerst eine E-Mail ausw√§hlen.'; return; }
      status.textContent = 'Vorschlag wird erstellt ‚Ä¶';
      try{
        // Vor dem Compose-Vorschlag immer aktuelle Reply-Preferences sichern,
        // damit der Agent den neuesten Stil nutzt.
        await autosaveComposeReplyPrefs();
        // Erster Versuch (8s Timeout)
        let res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 8, force: !!force}) });
        let data = await parseJsonSafe(res);
        if(!data.__ok){
          // Bei 504 (compose_timeout/compose_empty) ein zweiter Versuch mit 20s Timeout
          if(data.__status === 504){
            status.textContent = 'Ausgelastet, zweiter Versuch (bis 20s) ‚Ä¶';
            res = await fetch('/api/emails/agent-compose', { method:'POST', headers:{...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({uid: currentUid, timeout_s: 20, force: true}) });
            data = await parseJsonSafe(res);
          }
        }
        if(!data.__ok){
          throw new Error(data.error || ('Fehler (' + (data.__status||'') + ')'));
        }
        toInput.value = data.to || '';
        subjInput.value = data.subject || '';

        let html = data.html || '';
        try{
          const sigRaw = (currentSignatureHtml || '').trim();
          if(sigRaw){
            const htmlLower = html.toLowerCase();
            const sigLower = sigRaw.toLowerCase();
            // Nur anh√§ngen, wenn die Signatur nicht ohnehin schon vorkommt
            if(!htmlLower.includes(sigLower) && !htmlLower.includes('--\n') && !htmlLower.includes('--<br')){
              let signatureBlock = '';
              if(/</.test(sigRaw)){
                // HTML-Signatur (enth√§lt z.B. <img>-Tag) ‚Äì Zeilenumbr√ºche beibehalten
                signatureBlock = sigRaw.replace(/\n/g, '<br>');
              } else {
                const escaped = escapeHtml(sigRaw).replace(/\n/g, '<br>');
                signatureBlock = `<p>${escaped}</p>`;
              }
              html = (html || '') + (signatureBlock || '');
            }
          }
        }catch(_e_sig_append){}

        editor.innerHTML = html || '<div class="muted">(leer)</div>';
        status.textContent = 'Vorschlag erstellt';
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    async function sendDraft(){
      const status = document.getElementById('compose_status');
      const toInput = document.getElementById('compose_to');
      const ccInput = document.getElementById('compose_cc');
      const bccInput = document.getElementById('compose_bcc');
      const subjInput = document.getElementById('compose_subject');
      const editor = document.getElementById('compose_editor');
      const attachInput = document.getElementById('compose_attachments');
      if(!toInput.value){ status.textContent = 'Empf√§nger fehlt.'; return; }
      if(!currentAccountId){ status.textContent = 'Kein E-Mail-Account ausgew√§hlt.'; return; }
      status.textContent = 'Sende ‚Ä¶';
      try{
        const formData = new FormData();
        formData.append('to', toInput.value);
        if(ccInput && ccInput.value){ formData.append('cc', ccInput.value); }
        if(bccInput && bccInput.value){ formData.append('bcc', bccInput.value); }
        formData.append('subject', subjInput.value || '');
        formData.append('html', editor.innerHTML || '');
        formData.append('account_id', String(currentAccountId));
        if(currentUid){ formData.append('reply_to_uid', String(currentUid)); }
        if(attachInput && attachInput.files && attachInput.files.length){
          Array.from(attachInput.files).forEach((file) => {
            formData.append('attachments', file);
          });
        }

        const res = await fetch('/api/emails/send', {
          method:'POST',
          headers: getAuthHeaders(),
          body: formData
        });
        const data = await parseJsonSafe(res);
        if(!data.__ok && data.error){ throw new Error(data.error); }
        status.textContent = 'Gesendet';

        // Aktuelle E-Mail im Frontend als beantwortet markieren (is_replied = 1)
        if(currentUid && inboxEmails && inboxEmails.length){
          const idx = inboxEmails.findIndex(e => String(e.uid) === String(currentUid));
          if(idx >= 0){
            inboxEmails[idx].is_replied = 1;
          }

          // Wenn "Unbeantwortet" aktiv ist, die Zeile mit kleiner Animation ausblenden
          if(inboxAnswerFilter === 'unanswered'){
            const list = document.getElementById('list');
            if(list){
              const row = list.querySelector(`.item[data-uid="${currentUid}"]`);
              if(row){
                row.classList.add('answer-fade-out');
                setTimeout(() => {
                  if(row.parentNode){
                    row.parentNode.removeChild(row);
                  }
                  // Liste neu aufbauen, damit Z√§hler und Filterzustand passen
                  try{ renderInboxList(); }catch(_e){}
                }, 220);
              } else {
                // Falls keine konkrete Zeile gefunden wurde, Liste einfach neu rendern
                try{ renderInboxList(); }catch(_e2){}
              }
            }
          } else {
            // In anderen Ansichten nur die Markierung (‚Ü©Ô∏é) aktualisieren
            try{ renderInboxList(); }catch(_e3){}
          }
        }

        // Antwort-Panel nach kurzem Delay automatisch schlie√üen, wenn erfolgreich gesendet wurde
        setTimeout(() => {
          const panel = document.getElementById('compose');
          if(panel){ panel.classList.remove('open'); }
        }, 2000);
      }catch(e){ status.textContent = 'Fehler: ' + e; }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function renderProfilePlaceholder(p){
      const el = document.getElementById('profile_panel'); if(!el) return;
      const set = (id, val) => { const n = document.getElementById(id); if(n) n.textContent = val || '‚Äì'; };
      set('prof_name', p.name);
      set('prof_email', p.email);
      set('prof_phone', p.phone);
      set('prof_city', p.city);
      set('prof_source', p.source);
      set('prof_last', p.last);
      set('prof_channels', p.channels);
      const sum = document.getElementById('prof_summary'); if(sum) sum.textContent = p.summary || '‚Äì';
    }
    document.getElementById('reload').addEventListener('click', refreshInbox);
    document.getElementById('load_more_btn').addEventListener('click', loadMoreEmails);
    const proposeBtn = document.getElementById('btn_propose');
    const sendBtn = document.getElementById('btn_send');
    const attachBtn = document.getElementById('btn_attach');
    const translateBtn = document.getElementById('btn_translate');
    const attachInput = document.getElementById('compose_attachments');
    const attachList = document.getElementById('compose_attachments_list');
    const ccToggle = document.getElementById('compose_cc_toggle');
    const bccToggle = document.getElementById('compose_bcc_toggle');
    const ccRow = document.getElementById('compose_cc_row');
    const bccRow = document.getElementById('compose_bcc_row');
    if(sendBtn){
      sendBtn.addEventListener('click', sendDraft);
    }
    if(attachBtn && attachInput){
      attachBtn.addEventListener('click', () => attachInput.click());
      attachInput.addEventListener('change', () => {
        if(!attachList) return;
        const files = Array.from(attachInput.files || []);
        if(!files.length){
          attachList.textContent = '';
          return;
        }
        attachList.textContent = files.map(f => `üìé ${f.name}`).join('  ¬∑  ');
      });
    }
    if(ccToggle && ccRow){
      ccToggle.addEventListener('click', (ev) => {
        ev.preventDefault();
        ccRow.style.display = ccRow.style.display === 'none' ? 'flex' : 'none';
      });
    }
    if(bccToggle && bccRow){
      bccToggle.addEventListener('click', (ev) => {
        ev.preventDefault();
        bccRow.style.display = bccRow.style.display === 'none' ? 'flex' : 'none';
      });
    }
    if(translateBtn){
      translateBtn.addEventListener('click', async () => {
        try{
          const editor = document.getElementById('compose_editor');
          const status = document.getElementById('compose_status');
          if(!editor || !currentUid){
            if(status) status.textContent = 'Keine E-Mail ausgew√§hlt.';
            return;
          }
          const htmlNow = (editor.innerHTML || '').trim();
          if(!htmlNow){
            if(status) status.textContent = 'Nichts zum √úbersetzen.';
            return;
          }
          if(status) status.textContent = '√úbersetze Entwurf ‚Ä¶';
          const res = await fetch('/api/emails/translate-draft', {
            method:'POST',
            headers:{...getAuthHeaders(), 'Content-Type':'application/json'},
            body: JSON.stringify({ uid: currentUid, html: htmlNow })
          });
          const data = await parseJsonSafe(res);
          if(!data.__ok){
            throw new Error(data.error || '√úbersetzung fehlgeschlagen');
          }
          const translated = data.html || '';
          if(translated){
            editor.innerHTML = translated;
            if(status) status.textContent = 'Entwurf √ºbersetzt.';
          } else if(status){
            status.textContent = 'Keine √úbersetzung erhalten.';
          }
        }catch(e){
          const status = document.getElementById('compose_status');
          if(status) status.textContent = 'Fehler bei √úbersetzung: ' + e.message;
        }
      });
    }
    if(proposeBtn){
      proposeBtn.addEventListener('click', async () => {
        const status = document.getElementById('compose_status');
        const editor = document.getElementById('compose_editor');
        if(!editor){ return; }
        const htmlNow = (editor.innerHTML || '').trim();
        const textNow = (editor.textContent || '').trim();

        // Wenn noch kein Inhalt vorhanden ist, normalen Vorschlag erzeugen
        if(!htmlNow || !textNow || /Hier erscheint der Vorschlag/i.test(textNow)){
          await proposeDraft();
          return;
        }

        // Sonst bestehenden Text neu formulieren
        if(status){ status.textContent = 'Formuliere neu ‚Ä¶'; }
        proposeBtn.disabled = true;
        try{
          const res = await fetch('/api/emails/rewrite-draft', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ html: htmlNow, timeout_s: 15 })
          });
          const data = await parseJsonSafe(res);
          if(!data.__ok){
            if(status){ status.textContent = 'Fehler beim Neuformulieren: ' + (data.error || 'Unbekannter Fehler'); }
            return;
          }
          editor.innerHTML = data.html || editor.innerHTML;
          if(status){ status.textContent = 'Antwort neu formuliert'; }
        } catch(e){
          if(status){ status.textContent = 'Fehler beim Neuformulieren: ' + e; }
        } finally {
          proposeBtn.disabled = false;
        }
      });
    }

    // Antwort-Panel manuell ein-/ausblenden, ohne automatisch eine KI-Antwort zu erzeugen.
    // Event-Delegation, damit es auch f√ºr dynamische Buttons im Detailbereich funktioniert.
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('#toggle_compose_btn');
      if(!btn) return;
      const panel = document.getElementById('compose');
      if(!panel) return;
      // Wenn Panel zu ist ‚Üí √∂ffnen. Wenn offen: nur schlie√üen, wenn Editor leer ist.
      if(!panel.classList.contains('open')){
        panel.classList.add('open');
        // Direkt beim manuellen √ñffnen des Antwortfensters eine Begr√º√üung + Schluss einf√ºgen
        prefillComposeShell();

        // Empf√§nger + Betreff automatisch aus der aktuellen E-Mail vorbelegen
        try{
          const toInput = document.getElementById('compose_to');
          const subjInput = document.getElementById('compose_subject');
          if(toInput || subjInput){
            if(currentUid && Array.isArray(inboxEmails)){
              const mail = inboxEmails.find(e => String(e.uid) === String(currentUid));
              if(mail){
                // Empf√§nger: Absender-Adresse der originalen Mail
                if(toInput && !toInput.value){
                  const rawFrom = mail.from_addr || mail.from || '';
                  let addr = rawFrom;
                  const m = /<([^>]+)>/.exec(String(rawFrom));
                  if(m){ addr = m[1]; }
                  toInput.value = addr || '';
                }
                // Betreff: Re: <Subject>, falls noch kein Re:/Fwd: Prefix vorhanden ist
                if(subjInput && !subjInput.value){
                  const subj = String(mail.subject || '').trim();
                  const hasPrefix = /^((re|aw|fwd|wg)\s*[:Ôºö])/i.test(subj);
                  subjInput.value = hasPrefix ? subj : (subj ? 'Re: ' + subj : '');
                }
              }
            }
          }
        }catch(_e_prefill){ /* Prefill ist Komfort, Fehler hier ignorieren */ }
      } else {
        if(isComposeEmpty()){
          panel.classList.remove('open');
        }
      }
    });

    // Expliziter Schlie√üen-Button im Compose-Header: immer schlie√üen, unabh√§ngig vom Inhalt
    (function setupComposeClose(){
      const closeBtn = document.getElementById('compose_close_btn');
      if(!closeBtn) return;
      closeBtn.addEventListener('click', () => {
        const panel = document.getElementById('compose');
        if(!panel) return;
        panel.classList.remove('open');
      });
    })();

    // Klick au√üerhalb des Antwort-Panels: wenn Panel offen und leer, automatisch schlie√üen
    document.addEventListener('click', (ev) => {
      const panel = document.getElementById('compose');
      if(!panel || !panel.classList.contains('open')) return;
      if(panel.contains(ev.target)) return; // Klick innerhalb des Panels ignorieren
      // Antwort-Button neben Betreff darf wie bisher toggeln, hier also nicht doppelt schlie√üen
      if(ev.target.closest('#toggle_compose_btn')) return;
      if(isComposeEmpty()){
        panel.classList.remove('open');
      }
    });
    // Auth: get JWT token and user email
    function getAuthToken(){
      return localStorage.getItem('jwt_token') || '';
    }
    function getUserEmail(){
      const token = getAuthToken();
      if(!token) return '';
      try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.user_email || '';
      }catch(e){
        return '';
      }
    }
    function getCurrentUser(){
      try{
        const user = localStorage.getItem('current_user');
        return user ? JSON.parse(user) : null;
      }catch(e){
        return null;
      }
    }

    // E-Mail-Accounts laden und Dropdown initialisieren (Inbox + "Senden als")
    async function ensureEmailAccountsLoaded(){
      try{
        const res = await fetch('/api/email-accounts/list', { headers: getAuthHeaders() });
        const data = await parseJsonSafe(res);
        if(!data.__ok){ return; }
        const accounts = data.accounts || [];
        if(!accounts.length){ return; }
        // Standard: ersten Account w√§hlen, falls keiner gesetzt
        if(!currentAccountId){
          currentAccountId = accounts[0].id;
        }

        // Ordner f√ºr aktuellen Account laden
        await loadFoldersForCurrentAccount();

        // Account-Dropdown direkt im Header links anzeigen (anstelle des Textes)
        const titleEl = document.getElementById('account_title');
        if(titleEl && !document.getElementById('account_select')){
          const select = document.createElement('select');
          select.id = 'account_select';
          select.style.cssText = 'height:36px; padding:8px 16px; border-radius:8px; border:1px solid var(--border); font-size:15px; font-weight:500; min-width:200px; background:#ffffff; color:#111827;';
          for(const acc of accounts){
            const opt = document.createElement('option');
            opt.value = acc.id;
            opt.textContent = acc.label || acc.account_email;
            if(acc.id === currentAccountId){ opt.selected = true; }
            select.appendChild(opt);
          }
          select.addEventListener('change', async () => {
            currentAccountId = parseInt(select.value, 10);
            currentFolder = 'inbox';
            await loadFoldersForCurrentAccount();
            await loadInbox();
          });
          // Inhalt des Headers leeren und Dropdown einf√ºgen
          titleEl.textContent = '';
          titleEl.appendChild(select);
        }
      }catch(e){
        // Wenn das Laden scheitert, arbeitet die Inbox einfach ohne Dropdown weiter
      }
    }

    // Schlie√üt alle offenen Modalfenster (gegen "schwarzen Screen" mit mehreren Overlays)
    function closeAllModals(){
      document.querySelectorAll('.modal').forEach(m => {
        m.style.display = 'none';
      });
    }
    function updateMenuForUser(){
      const user = getCurrentUser();
      const sidebarUsersItem = document.getElementById('sidebar_users_item');
      if(user && user.role === 'superadmin'){
        if(sidebarUsersItem) sidebarUsersItem.style.display = 'block';
      } else {
        if(sidebarUsersItem) sidebarUsersItem.style.display = 'none';
      }
      // Update user badge: nur Icon, Name als Tooltip/Fallback
      const badge = document.getElementById('user_badge');
      if(user && badge){
        const name = user.first_name ? user.first_name : (user.email ? user.email.split('@')[0] : 'Profil');
        const icon = (window.getIconSvg ? window.getIconSvg('user', {size:18}) : '');
        if(icon){
          badge.innerHTML = icon;
        }else{
          badge.textContent = 'üë§';
        }
        badge.title = name;
        badge.setAttribute('aria-label', name);
        badge.style.display = 'inline-flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
      }
    }
    function getAuthHeaders(){
      const token = getAuthToken();
      return token ? {'Authorization': 'Bearer ' + token} : {};
    }
    async function checkAuth(){
      const token = getAuthToken();
      if(!token){
        showLoginModal();
        return false;
      }
      try{
        const res = await fetch('/api/auth/me', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.user){
          localStorage.setItem('current_user', JSON.stringify(data.user));
          updateMenuForUser();

          // Wichtigkeitsregeln laden: zuerst vom Server, dann mit localStorage mergen
          try{
            const rRes = await fetch('/api/emails/importance-rules', { headers: getAuthHeaders() });
            const rData = await parseJsonSafe(rRes);
            if(rData.__ok && Array.isArray(rData.rules)){
              importanceRules = rData.rules.map(r => ({
                pattern: (r.pattern || '').toLowerCase(),
                bucket: (r.bucket || '').toLowerCase(),
              }));
            }
          }catch(_){ }

          // Zus√§tzlich lokal gespeicherte Regeln anwenden (Client-Regeln √ºberschreiben Server-Regeln)
          try{
            const ls = localStorage.getItem('importance_rules');
            if(ls){
              const parsed = JSON.parse(ls);
              if(Array.isArray(parsed)){
                parsed.forEach(p => {
                  const pat = (p.pattern || '').toLowerCase();
                  const buck = (p.bucket || '').toLowerCase();
                  if(pat && buck){
                    importanceRules = (importanceRules || []).filter(r => r.pattern !== pat);
                    importanceRules.push({pattern: pat, bucket: buck});
                  }
                });
              }
            }
          }catch(_e_ls){ }

          // Falls schon E-Mails geladen sind, Liste mit neuen Regeln neu rendern
          try{
            if(inboxEmails && inboxEmails.length){
              renderInboxList();
            }
          }catch(_e_r){ }

          return true;
        } else {
          localStorage.removeItem('jwt_token');
          localStorage.removeItem('current_user');
          showLoginModal();
          return false;
        }
      }catch(e){
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('current_user');
        showLoginModal();
        return false;
      }
    }
    function showLoginModal(){
      closeAllModals();
      const modal = document.getElementById('login_modal');
      const email = document.getElementById('login_email');
      const pass = document.getElementById('login_pass');
      const msg = document.getElementById('login_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      email.value = '';
      pass.value = '';
      email.focus();
      document.getElementById('login_submit').onclick = async () => {
        const emailVal = email.value.trim();
        const passVal = pass.value;
        if(!emailVal || !passVal){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        msg.textContent = 'Login...';
        try{
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: emailVal, password: passVal})
          });
          const data = await parseJsonSafe(res);
          if(data.ok && data.token){
            localStorage.setItem('jwt_token', data.token);
            localStorage.setItem('current_user', JSON.stringify(data.user));
            updateMenuForUser();
            modal.style.display = 'none';
            msg.textContent = '';
            loadInbox();
          } else {
            msg.textContent = data.error || 'Login fehlgeschlagen';
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      pass.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') document.getElementById('login_submit').click();
      });
      document.getElementById('login_debug').onclick = async () => {
        msg.textContent = 'Lade Debug-Info...';
        try{
          const res = await fetch('/api/auth/debug');
          const data = await res.json();
          let debugText = '=== DB CONFIG ===\n';
          Object.entries(data.config || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== FALLBACK CONFIG ===\n';
          Object.entries(data.fallback || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          debugText += '\n=== CONNECTION TEST ===\n';
          Object.entries(data.connection_test || {}).forEach(([k,v]) => {
            debugText += `${k}: ${v}\n`;
          });
          if(data.tables && data.tables.length){
            debugText += '\n=== TABLES ===\n' + data.tables.join(', ');
          }
          msg.textContent = debugText;
        }catch(e){
          msg.textContent = 'Debug-Fehler: ' + e;
        }
      };
    }

    function fillEmailSettingsFormDefaults(userEmail){
      document.getElementById('imap_host').value = '';
      document.getElementById('imap_port').value = 993;
      document.getElementById('imap_user').value = '';
      document.getElementById('imap_pass').value = '';
      document.getElementById('imap_security').value = 'ssl';
      document.getElementById('smtp_host').value = '';
      document.getElementById('smtp_port').value = 465;
      document.getElementById('smtp_user').value = '';
      document.getElementById('smtp_pass').value = '';
      document.getElementById('smtp_security').value = 'ssl';
    }

    async function loadEmailAccountIntoForm(accountId, msgEl, userEmail){
      if(!accountId){
        fillEmailSettingsFormDefaults(userEmail);
        if(msgEl) msgEl.textContent = 'Neue Konfiguration';
        return;
      }
      try{
        if(msgEl) msgEl.textContent = 'Lade Account...';
        const res = await fetch(`/api/email-accounts/${encodeURIComponent(accountId)}`, {
          headers: getAuthHeaders(),
        });
        const data = await parseJsonSafe(res);
        const acc = data.account;
        if(!data.__ok || !acc){
          fillEmailSettingsFormDefaults(userEmail);
          if(msgEl) msgEl.textContent = data.error || 'Account nicht gefunden';
          return;
        }
        document.getElementById('imap_host').value = acc.imap_host || '';
        document.getElementById('imap_port').value = acc.imap_port || 993;
        document.getElementById('imap_user').value = acc.imap_user || (userEmail || '');
        document.getElementById('imap_pass').value = '';
        document.getElementById('imap_security').value = acc.imap_security || 'ssl';
        document.getElementById('smtp_host').value = acc.smtp_host || '';
        document.getElementById('smtp_port').value = acc.smtp_port || 465;
        document.getElementById('smtp_user').value = acc.smtp_user || (acc.account_email || userEmail || '');
        document.getElementById('smtp_pass').value = '';
        document.getElementById('smtp_security').value = acc.smtp_security || 'ssl';
        if(msgEl) msgEl.textContent = 'Account geladen';
      }catch(e){
        fillEmailSettingsFormDefaults(userEmail);
        if(msgEl) msgEl.textContent = 'Fehler beim Laden des Accounts: ' + e;
      }
    }
    async function openEmailSettingsModal(){
      closeAllModals();
      const modal = document.getElementById('email_settings_modal');
      const msg = document.getElementById('email_settings_msg');
      const userEmail = getUserEmail();
      if(!userEmail){ alert('E‚ÄëMail-Adresse erforderlich'); return; }
      msg.textContent = 'Lade Accounts...';
      modal.style.display = 'flex';
      try{
        // Accounts laden
        const listRes = await fetch('/api/email-accounts/list', { headers: getAuthHeaders() });
        const listData = await parseJsonSafe(listRes);
        const select = document.getElementById('email_account_select');
        emailAccounts = (listData.accounts || []);
        // Dropdown neu bef√ºllen: zuerst Accounts, dann "Neuer Account ‚Ä¶"
        select.innerHTML = '';
        for(const acc of emailAccounts){
          const opt = document.createElement('option');
          opt.value = acc.id;
          opt.textContent = acc.label || acc.account_email;
          select.appendChild(opt);
        }
        const newOpt = document.createElement('option');
        newOpt.value = '';
        newOpt.textContent = 'Neuer Account ‚Ä¶';
        select.appendChild(newOpt);

        // Falls es schon einen global ausgew√§hlten Account gibt, nutzen
        if(currentAccountId && emailAccounts.some(a => a.id === currentAccountId)){
          currentSettingsAccountId = currentAccountId;
        } else if(emailAccounts.length){
          currentSettingsAccountId = emailAccounts[0].id;
        } else {
          currentSettingsAccountId = null;
        }

        if(currentSettingsAccountId){
          select.value = String(currentSettingsAccountId);
          await loadEmailAccountIntoForm(currentSettingsAccountId, msg, userEmail);
        } else {
          // Kein Account vorhanden -> Formular mit Defaults f√ºllen
          fillEmailSettingsFormDefaults(userEmail);
          select.value = '';
          msg.textContent = 'Neue Konfiguration';
        }

        // Wechsel zwischen bestehendem Account und "Neuer Account"
        select.onchange = async () => {
          const val = select.value;
          if(!val){
            currentSettingsAccountId = null;
            fillEmailSettingsFormDefaults(userEmail);
            msg.textContent = 'Neue Konfiguration';
          } else {
            currentSettingsAccountId = parseInt(val, 10);
            await loadEmailAccountIntoForm(currentSettingsAccountId, msg, userEmail);
          }
        };
      }catch(e){
        msg.textContent = 'Fehler beim Laden: ' + e;
      }

      // Signatur aus user_email_settings laden (separat von Accounts)
      try{
        const sigRes = await fetch(`/api/user/email-settings?user_email=${encodeURIComponent(userEmail)}`);
        const sigData = await parseJsonSafe(sigRes);
        const sigField = document.getElementById('email_signature_html');
        if(sigData && sigData.signature_html && sigField){
          sigField.value = sigData.signature_html;
          try{ localStorage.setItem('email_signature_html', sigData.signature_html || ''); }catch(_e_ls1){}
        } else if(sigField){
          // Fallback: lokale Signatur aus localStorage verwenden, falls vorhanden
          try{
            const cachedSig = localStorage.getItem('email_signature_html') || '';
            sigField.value = cachedSig;
          }catch(_e_ls2){
            if(!sigField.value){ sigField.value = ''; }
          }
        }
      }catch(e){
        console.warn('Signatur konnte nicht geladen werden', e);
        // Fallback bei Fehler: lokale Signatur aus localStorage ziehen
        try{
          const sigField = document.getElementById('email_signature_html');
          if(sigField && !sigField.value){
            sigField.value = localStorage.getItem('email_signature_html') || '';
          }
        }catch(_e_ls_fail){}
      }

      // Bild-Upload f√ºr Signatur
      const sigFileInput = document.getElementById('email_signature_image');
      const sigUploadBtn = document.getElementById('email_signature_upload_btn');
      const sigStatus = document.getElementById('email_signature_img_status');
      const sigTextarea = document.getElementById('email_signature_html');
      if(sigFileInput && sigUploadBtn){
        sigUploadBtn.onclick = async () => {
          if(!sigFileInput.files || !sigFileInput.files[0]){
            sigStatus.textContent = 'Bitte zuerst ein Bild ausw√§hlen.';
            return;
          }
          const file = sigFileInput.files[0];
          const fd = new FormData();
          fd.append('file', file);
          sigStatus.textContent = 'Lade Bild hoch...';
          sigUploadBtn.disabled = true;
          try{
            const res = await fetch('/api/user/signature-image', {
              method: 'POST',
              headers: getAuthHeaders(),
              body: fd,
            });
            const data = await parseJsonSafe(res);
            if(!data.__ok && !data.ok){
              throw new Error(data.error || 'Upload fehlgeschlagen');
            }
            const url = data.url || data.image_url;
            if(url && sigTextarea){
              const snippet = `\n<img src="${url}" alt="Signaturbild" style="display:block; max-width:100%; height:auto; border-radius:12px; margin-top:8px;">`;
              sigTextarea.value = (sigTextarea.value || '') + snippet;
            }
            sigStatus.textContent = 'Bild hochgeladen. In die Signatur eingef√ºgt.';
          }catch(e){
            sigStatus.textContent = 'Fehler beim Upload: ' + e;
          }finally{
            sigUploadBtn.disabled = false;
          }
        };
      }
      
      // Auto-detect security based on SMTP port
      const smtpPortInput = document.getElementById('smtp_port');
      const smtpSecuritySelect = document.getElementById('smtp_security');
      const smtpHintDiv = document.getElementById('smtp_port_hint');
      const smtpHintText = document.getElementById('smtp_port_hint_text');
      
      function updateSmtpSecurityHint() {
        const port = parseInt(smtpPortInput.value);
        if (port === 587) {
          smtpSecuritySelect.value = 'starttls';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 587 nutzt STARTTLS - automatisch ausgew√§hlt';
        } else if (port === 465) {
          smtpSecuritySelect.value = 'ssl';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 465 nutzt SSL - automatisch ausgew√§hlt';
        } else if (port === 25) {
          smtpSecuritySelect.value = 'starttls';
          smtpHintDiv.style.display = 'block';
          smtpHintText.textContent = 'Port 25 nutzt meist STARTTLS - bitte pr√ºfen';
        } else {
          smtpHintDiv.style.display = 'none';
        }
      }
      
      smtpPortInput.addEventListener('input', updateSmtpSecurityHint);
      smtpPortInput.addEventListener('change', updateSmtpSecurityHint);
      
      // Run once on load if port is already filled
      if (smtpPortInput.value) {
        updateSmtpSecurityHint();
      }
      
      // Auto-detect security based on IMAP port
      const imapPortInput = document.getElementById('imap_port');
      const imapSecuritySelect = document.getElementById('imap_security');
      const imapHintDiv = document.getElementById('imap_port_hint');
      const imapHintText = document.getElementById('imap_port_hint_text');
      
      function updateImapSecurityHint() {
        const port = parseInt(imapPortInput.value);
        if (port === 993) {
          imapSecuritySelect.value = 'ssl';
          imapHintDiv.style.display = 'block';
          imapHintText.textContent = 'Port 993 nutzt SSL - automatisch ausgew√§hlt';
        } else if (port === 143) {
          imapSecuritySelect.value = 'starttls';
          imapHintDiv.style.display = 'block';
          imapHintText.textContent = 'Port 143 nutzt STARTTLS - automatisch ausgew√§hlt';
        } else {
          imapHintDiv.style.display = 'none';
        }
      }
      
      imapPortInput.addEventListener('input', updateImapSecurityHint);
      imapPortInput.addEventListener('change', updateImapSecurityHint);
      
      // Run once on load if port is already filled
      if (imapPortInput.value) {
        updateImapSecurityHint();
      }
      
      const cleanup = () => { modal.style.display='none'; };
      document.getElementById('email_settings_cancel').onclick = cleanup;
      document.getElementById('email_settings_save').onclick = async () => {
        msg.textContent = 'Speichere...';
        const imapHost = document.getElementById('imap_host').value.trim();
        const imapPort = parseInt(document.getElementById('imap_port').value.trim()) || 993;
        const imapUser = document.getElementById('imap_user').value.trim();
        const imapPass = document.getElementById('imap_pass').value;
        const imapSecurity = document.getElementById('imap_security').value;
        const smtpHost = document.getElementById('smtp_host').value.trim();
        const smtpPort = parseInt(document.getElementById('smtp_port').value.trim()) || 465;
        const smtpUser = document.getElementById('smtp_user').value.trim();
        const smtpPass = document.getElementById('smtp_pass').value;
        const smtpSecurity = document.getElementById('smtp_security').value;
        const signatureHtml = document.getElementById('email_signature_html').value;

        // Signatur sofort im Frontend √ºbernehmen, damit sie auch dann
        // direkt im Reply erscheint, wenn der Server-Call fehlschl√§gt.
        currentSignatureHtml = signatureHtml || '';
        try{ localStorage.setItem('email_signature_html', currentSignatureHtml); }catch(_e_ls_save){}

        // Account-E-Mail/Label aus SMTP- oder IMAP-Benutzername ableiten
        const accountEmail = smtpUser || imapUser || userEmail;

        const data = {
          id: currentSettingsAccountId || undefined,
          account_email: accountEmail,
          label: accountEmail,
          imap_host: imapHost,
          imap_port: imapPort,
          imap_user: imapUser,
          imap_pass: imapPass,
          imap_security: imapSecurity,
          smtp_host: smtpHost,
          smtp_port: smtpPort,
          smtp_user: smtpUser,
          smtp_pass: smtpPass,
          smtp_security: smtpSecurity,
          signature_html: signatureHtml,
          is_active: true,
        };

        try{
          const res = await fetch('/api/email-accounts/save', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          });
          const result = await parseJsonSafe(res);
          if(result.__ok){
            currentSettingsAccountId = result.id;
            msg.textContent = '‚úÖ Account gespeichert! E-Mails werden geladen...';

            // Signatur zus√§tzlich explizit in user_email_settings persistieren,
            // damit sie beim n√§chsten Reload sicher √ºber /api/user/email-settings
            // zur Verf√ºgung steht (Best-Effort).
            try{
              const userEmail = getUserEmail && getUserEmail();
              if(userEmail && typeof fetch !== 'undefined'){
                fetch('/api/user/email-settings', {
                  method: 'POST',
                  headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                  body: JSON.stringify({ user_email: userEmail, signature_html: signatureHtml })
                }).catch(() => {});
              }
            }catch(_e_sig_post){}
            setTimeout(() => {
              cleanup();
              // Globalen Account ggf. auf den eben gespeicherten setzen
              currentAccountId = currentSettingsAccountId;
              loadInbox();
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (result.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler beim Speichern: ' + e;
        }
      };
      
      // SMTP Test Button
      document.getElementById('smtp_test_btn').onclick = async () => {
        const resultDiv = document.getElementById('smtp_test_result');
        const btn = document.getElementById('smtp_test_btn');
        resultDiv.textContent = 'Teste Verbindung...';
        btn.disabled = true;
        
        try {
          const res = await fetch('/api/emails/smtp-test', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ account_id: currentSettingsAccountId || currentAccountId })
          });
          const data = await parseJsonSafe(res);
          
          if (data.ok) {
            let resultText = `‚úÖ SMTP-Verbindung erfolgreich!\n\nServer: ${data.host}:${data.port}\nSecurity: ${data.security}\n\n`;
            if (data.tests && data.tests.length > 0) {
              resultText += 'Tests:\n';
              data.tests.forEach(test => {
                const icon = test.success ? '‚úÖ' : '‚úÖ';
                resultText += `${icon} ${test.method}: ${test.message}\n`;
              });
            }
            resultDiv.textContent = resultText;
            resultDiv.style.color = '#059669';
          } else {
            let errorText = `‚ùå SMTP-Test fehlgeschlagen\n\n`;
            if (data.error) errorText += `Fehler: ${data.error}\n\n`;
            if (data.tests && data.tests.length > 0) {
              errorText += 'Details:\n';
              data.tests.forEach(test => {
                const icon = test.success ? '‚úÖ' : '‚ùå';
                errorText += `${icon} ${test.method}: ${test.message}\n`;
              });
            }
            resultDiv.textContent = errorText;
            resultDiv.style.color = '#dc2626';
          }
        } catch (e) {
          resultDiv.textContent = `‚ùå Fehler beim Test: ${e}`;
          resultDiv.style.color = '#dc2626';
        } finally {
          btn.disabled = false;
        }
      };
      
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    function openProfileModal(){
      closeAllModals();
      const modal = document.getElementById('profile_modal');
      const msg = document.getElementById('profile_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = '';
      
      // Fill current data
      document.getElementById('profile_email').value = user.email || '';
      document.getElementById('profile_first').value = user.first_name || '';
      document.getElementById('profile_last').value = user.last_name || '';
      document.getElementById('profile_role').value = user.role || 'user';
      document.getElementById('profile_new_pass').value = '';
      document.getElementById('profile_confirm_pass').value = '';
      const langSelect = document.getElementById('profile_language');
      if(langSelect){
        langSelect.value = '';
        // Bevorzugte Sprache aus user_email_settings laden
        try{
          const userEmail = user.email || '';
          if(userEmail){
            fetch(`/api/user/email-settings?user_email=${encodeURIComponent(userEmail)}`)
              .then(res => parseJsonSafe(res))
              .then(data => {
                if(data && (data.preferred_language || data.preferred_language === '')){
                  const code = data.preferred_language || '';
                  // Nur setzen, wenn Option existiert
                  const hasOption = Array.from(langSelect.options).some(opt => opt.value === code);
                  langSelect.value = hasOption ? code : '';
                }
              })
              .catch(() => {});
          }
        }catch(_e_lang){}
      }
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('profile_cancel').onclick = cleanup;
      document.getElementById('profile_save').onclick = async () => {
        const first = document.getElementById('profile_first').value.trim();
        const last = document.getElementById('profile_last').value.trim();
        const newPass = document.getElementById('profile_new_pass').value;
        const confirmPass = document.getElementById('profile_confirm_pass').value;
        const langSelect = document.getElementById('profile_language');
        const preferredLang = langSelect ? (langSelect.value || '') : '';
        
        // Validate password if provided
        if(newPass || confirmPass){
          if(newPass !== confirmPass){
            msg.textContent = 'Passw√∂rter stimmen nicht √ºberein';
            return;
          }
          if(newPass.length < 6){
            msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
            return;
          }
        }
        
        msg.textContent = 'Speichere...';
        const updateData = {
          first_name: first,
          last_name: last
        };
        if(newPass){
          updateData.password = newPass;
        }
        
        try{
          const res = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify(updateData)
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            // Update localStorage
            user.first_name = first;
            user.last_name = last;
            localStorage.setItem('current_user', JSON.stringify(user));
            updateMenuForUser();
            // Bevorzugte Sprache separat in user_email_settings speichern (Best Effort)
            try{
              const userEmail = user.email || '';
              if(userEmail && typeof fetch !== 'undefined'){
                fetch('/api/user/email-settings', {
                  method: 'POST',
                  headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                  body: JSON.stringify({ user_email: userEmail, preferred_language: preferredLang || null })
                }).catch(() => {});
              }
            }catch(_e_lang_save){}
            msg.textContent = '‚úÖ Profil gespeichert!';
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      // Wichtig: Modal NICHT beim Klick auf den Hintergrund schlie√üen,
      // damit eingegebener FAQ-Text nicht versehentlich verloren geht.
    }
    
    // Sidebar Menu
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar_overlay');
    const menuBtn = document.getElementById('menu_btn');
    const sidebarClose = document.getElementById('sidebar_close');
    
    function openSidebar(){
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    }
    function closeSidebar(){
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    }
    
    // Sidebar-Icons mit Lucide-SVGs bef√ºllen (data-icon-Attribut)
    if(window.getIconSvg){
      document.querySelectorAll('.sidebar-menu .icon[data-icon]').forEach(function(el){
        const name = el.getAttribute('data-icon');
        const svg = window.getIconSvg(name, {size:20});
        if(svg){ el.innerHTML = svg; }
      });
      // Men√º-Button in der Header-Toolbar ebenfalls mit Icon bef√ºllen
      if(menuBtn){
        const menuSvg = window.getIconSvg('menu', {size:18});
        if(menuSvg){
          menuBtn.innerHTML = menuSvg;
        }
      }
    }
    
    if(menuBtn){
      menuBtn.addEventListener('click', openSidebar);
    }
    sidebarClose.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    document.getElementById('sidebar_profile').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openProfileModal();
    });
    const headerUserBadge = document.getElementById('user_badge');
    if(headerUserBadge){
      headerUserBadge.addEventListener('click', (e)=>{
        e.preventDefault();
        openProfileModal();
      });
    }
    document.getElementById('sidebar_agent').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openAgentSetupModal();
    });
    document.getElementById('sidebar_knowledge').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openKnowledgeModal();
    });
    document.getElementById('sidebar_contacts').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openContactsModal();
    });
    document.getElementById('sidebar_email').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openEmailSettingsModal();
    });
    document.getElementById('sidebar_users').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      openUserManagementModal();
    });
    document.getElementById('sidebar_logout').addEventListener('click', (e)=>{
      e.preventDefault(); closeSidebar();
      logout();
    });
    function logout(){
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('current_user');
      location.reload();
    }
    
    function openAgentSetupModal(){
      const modal = document.getElementById('agent_setup_modal');
      const msg = document.getElementById('agent_setup_msg');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = 'Lade Einstellungen...';
      
      // Reset fields
      document.getElementById('agent_role').value = '';
      document.getElementById('agent_instructions').value = '';
      
      // Load agent settings
      fetch('/api/user/agent-settings', {
        headers: getAuthHeaders()
      }).then(res => res.json()).then(data => {
        if(data.role) document.getElementById('agent_role').value = data.role;
        if(data.instructions) document.getElementById('agent_instructions').value = data.instructions;
        msg.textContent = '';
      }).catch((e) => {
        msg.textContent = 'Fehler beim Laden: ' + e;
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('agent_setup_cancel').onclick = cleanup;
      document.getElementById('agent_setup_save').onclick = async () => {
        const role = document.getElementById('agent_role').value;
        const instructions = document.getElementById('agent_instructions').value.trim();
        
        msg.textContent = 'Speichere...';
        
        try{
          const res = await fetch('/api/user/agent-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({
              role: role,
              instructions: instructions
            })
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ Gespeichert!';
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      // Wichtig: Beim Wissensdatenbank-Modal NICHT auf Hintergrund-Klick reagieren,
      // damit eingegebener Text nicht versehentlich verloren geht.
      modal.onclick = (ev) => {
        if(ev.target === modal){
          // bewusst KEIN cleanup();
          ev.stopPropagation();
        }
      };

      // Autosave-Handler nur einmal registrieren
      if(faqEl && !faqEl.dataset.autosaveAttached){
        faqEl.addEventListener('input', () => {
          try {
            localStorage.setItem('knowledge_faq_draft', faqEl.value || '');
          } catch(_e) {}
        });
        faqEl.dataset.autosaveAttached = '1';
      }
      if(linksEl && !linksEl.dataset.autosaveAttached){
        linksEl.addEventListener('input', () => {
          try {
            localStorage.setItem('knowledge_links_draft', linksEl.value || '');
          } catch(_e) {}
        });
        linksEl.dataset.autosaveAttached = '1';
      }
    }
    
    function openKnowledgeModal(){
      closeAllModals();
      const modal = document.getElementById('knowledge_modal');
      const msg = document.getElementById('knowledge_msg');
      const faqEl = document.getElementById('knowledge_faq');
      const linksEl = document.getElementById('knowledge_links');
      const user = getCurrentUser();
      if(!user){ alert('Bitte erst einloggen'); return; }
      
      modal.style.display = 'flex';
      msg.textContent = 'Lade Wissensdatenbank...';
      
      // Autosave-Drafts aus localStorage laden (sofortige Anzeige)
      const draftFaq = localStorage.getItem('knowledge_faq_draft') || '';
      const draftLinks = localStorage.getItem('knowledge_links_draft') || '';
      if(faqEl && draftFaq){ faqEl.value = draftFaq; }
      if(linksEl && draftLinks){ linksEl.value = draftLinks; }
      
      // Load knowledge base
      fetch('/api/user/agent-settings', {
        headers: getAuthHeaders()
      }).then(res => res.json()).then(data => {
        // DB-Werte haben Vorrang vor Drafts; nur wenn leer, Draft √ºbernehmen
        if(faqEl){
          if(data.faq_text){
            faqEl.value = data.faq_text;
          } else if(!faqEl.value && draftFaq){
            faqEl.value = draftFaq;
          }
        }
        if(linksEl){
          if(data.document_links){
            linksEl.value = data.document_links;
          } else if(!linksEl.value && draftLinks){
            linksEl.value = draftLinks;
          }
        }
        msg.textContent = '';
      }).catch((e) => {
        msg.textContent = 'Fehler beim Laden: ' + e;
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('knowledge_cancel').onclick = cleanup;
      document.getElementById('knowledge_save').onclick = async () => {
        const faqText = (faqEl && faqEl.value ? faqEl.value.trim() : '');
        const docLinks = (linksEl && linksEl.value ? linksEl.value.trim() : '');
        
        msg.textContent = 'Speichere...';
        
        try{
          const res = await fetch('/api/user/agent-settings', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({
              faq_text: faqText,
              document_links: docLinks
            })
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ Gespeichert!';
            // Erfolgreich gespeichert -> Drafts l√∂schen
            try {
              localStorage.removeItem('knowledge_faq_draft');
              localStorage.removeItem('knowledge_links_draft');
            } catch(_e) {}
            setTimeout(cleanup, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
    }
    
    function openContactsModal(){
      closeAllModals();
      const modal = document.getElementById('contacts_modal');
      const list = document.getElementById('contacts_list');
      const searchInput = document.getElementById('contacts_search');
      
      modal.style.display = 'flex';
      
      async function loadContacts(search = ''){
        list.innerHTML = '<div class="sub" style="text-align:center; padding:20px;">Lade Kontakte...</div>';
        
        try{
          const url = search ? `/api/contacts/list?search=${encodeURIComponent(search)}` : '/api/contacts/list';
          const res = await fetch(url, { headers: getAuthHeaders() });
          const data = await parseJsonSafe(res);
          
          if(!data.__ok || !data.contacts){
            throw new Error(data.error || 'Fehler beim Laden');
          }
          
          if(data.contacts.length === 0){
            list.innerHTML = '<div class="sub" style="text-align:center; padding:40px;">Keine Kontakte gefunden.</div>';
            return;
          }
          
          list.innerHTML = '';
          for(const contact of data.contacts){
            const div = document.createElement('div');
            div.style.cssText = 'padding:14px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;';
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:600; margin-bottom:4px;">üìß ${escapeHtml(contact.name)}</div>
                  <div class="sub">${escapeHtml(contact.email)}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-weight:600; color:#0284c7;">${contact.email_count} E-Mail${contact.email_count !== 1 ? 's' : ''}</div>
                  <div class="sub">Letzter Kontakt: ${contact.last_contact}</div>
                </div>
              </div>
            `;
            div.addEventListener('mouseenter', () => { div.style.background = '#f3f4f6'; });
            div.addEventListener('mouseleave', () => { div.style.background = 'transparent'; });
            div.addEventListener('click', () => {
              openContactDetailModal(contact.id, contact.name, contact.email);
            });
            list.appendChild(div);
          }
          
        }catch(e){
          list.innerHTML = `<div class="sub" style="text-align:center; padding:40px; color:#dc2626;">Fehler: ${e}</div>`;
        }
      }
      
      loadContacts();
      
      // Search functionality
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          loadContacts(searchInput.value.trim());
        }, 300);
      });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('contacts_close').onclick = cleanup;
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openContactDetailModal(contactId, contactName, contactEmail){
      closeAllModals();
      const modal = document.getElementById('contact_detail_modal');
      const nameEl = document.getElementById('contact_name');
      const emailEl = document.getElementById('contact_email');
      const importanceEl = document.getElementById('contact_importance_badge');
      const countEl = document.getElementById('contact_detail_count');
      const emailsEl = document.getElementById('contact_detail_emails');
      const prefsStatusEl = document.getElementById('contact_reply_prefs_status');

      modal.style.display = 'flex';
      if(nameEl) nameEl.textContent = contactName;
      if(emailEl) emailEl.textContent = contactEmail;
      emailsEl.innerHTML = '<div class="sub" style="text-align:center; padding:20px;">Lade E-Mails...</div>';

      // Nur Status zu Reply-Preferences anzeigen (kein Edit an dieser Stelle)
      if(prefsStatusEl){
        prefsStatusEl.textContent = 'Antwortstil: Lade Einstellungen‚Ä¶';
        prefsStatusEl.style.color = '#6b7280';
        fetch(`/api/contacts/${contactId}/reply-prefs`, { headers: getAuthHeaders() })
          .then(res => res.json())
          .then(data => {
            try{
              if(!data || data.error){
                prefsStatusEl.textContent = 'Antwortstil: Fehler ‚Äì ' + (data && data.error ? data.error : 'Unbekannt');
                prefsStatusEl.style.color = '#dc2626';
                return;
              }
              const prefs = data.preferences || {};
              if(!prefs || (
                prefs.greeting_template == null &&
                prefs.closing_template == null &&
                prefs.length_level == null &&
                prefs.formality_level == null &&
                !prefs.salutation_mode &&
                !prefs.persona_mode
              )){
                prefsStatusEl.textContent = 'Antwortstil: Noch keine gespeicherten Einstellungen (es gelten Default/History-Werte).';
                prefsStatusEl.style.color = '#6b7280';
              } else {
                const src = prefs.style_source || 'manuell/auto';
                prefsStatusEl.textContent = `Antwortstil: Einstellungen geladen (${src}).`;
                prefsStatusEl.style.color = '#16a34a';
              }
            }catch(_e){
              prefsStatusEl.textContent = 'Antwortstil: Fehler beim Auswerten der Daten.';
              prefsStatusEl.style.color = '#dc2626';
            }
          })
          .catch(e => {
            prefsStatusEl.textContent = 'Antwortstil: Fehler ‚Äì ' + e;
            prefsStatusEl.style.color = '#dc2626';
          });
      }
      
      // Load emails from this contact
      fetch(`/api/contacts/${contactId}/emails`, { headers: getAuthHeaders() })
        .then(res => res.json())
        .then(data => {
          if(!data || !data.emails){
            throw new Error('Keine E-Mails gefunden');
          }
          
          countEl.textContent = data.contact.email_count;

          // Relevanz-Badge im KONTAKT-PROFIL setzen (falls vom Backend geliefert)
          if(importanceEl){
            const ib = (data.contact && data.contact.importance_bucket
              ? String(data.contact.importance_bucket).toLowerCase()
              : '');
            let label = '';
            let bg = '#e5e7eb';
            let color = '#4b5563';
            if(ib === 'focus'){
              label = 'Fokus-Kontakt';
              bg = '#dcfce7';
              color = '#166534';
            } else if(ib === 'unwichtig'){
              label = 'Unwichtiger Kontakt';
              bg = '#fee2e2';
              color = '#b91c1c';
            } else if(ib === 'normal'){
              label = 'Normal';
            }
            if(label){
              importanceEl.textContent = label;
              importanceEl.style.display = 'inline-flex';
              importanceEl.style.background = bg;
              importanceEl.style.color = color;
            } else {
              importanceEl.textContent = '';
              importanceEl.style.display = 'none';
            }
          }
          
          if(data.emails.length === 0){
            emailsEl.innerHTML = '<div class="sub" style="text-align:center; padding:40px;">Keine E-Mails gefunden.</div>';
            return;
          }
          
          emailsEl.innerHTML = '';
          for(const email of data.emails){
            const div = document.createElement('div');
            div.style.cssText = 'padding:12px; border:1px solid var(--border); border-radius:6px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;';
            div.innerHTML = `
              <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(email.subject)}</div>
              <div class="sub" style="margin-bottom:6px;">${escapeHtml(email.preview)}...</div>
              <div class="sub">${email.date}${email.has_attachments ? ' ¬∑ üìé Anhang' : ''}</div>
            `;
            div.addEventListener('mouseenter', () => { div.style.background = '#f3f4f6'; });
            div.addEventListener('mouseleave', () => { div.style.background = 'transparent'; });
            div.addEventListener('click', () => {
              // Close contact detail modal and open email in main view
              modal.style.display = 'none';
              document.getElementById('contacts_modal').style.display = 'none';
              // Select the email in list (if exists)
              const emailItem = document.querySelector(`[data-uid="${email.id}"]`);
              if(emailItem){
                emailItem.click();
              }
            });
            emailsEl.appendChild(div);
          }
          
        })
        .catch(e => {
          emailsEl.innerHTML = `<div class="sub" style="text-align:center; padding:40px; color:#dc2626;">Fehler: ${e}</div>`;
        });
      
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('contact_detail_close').onclick = cleanup;
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    
    function openUserManagementModal(){
      closeAllModals();
      const modal = document.getElementById('user_management_modal');
      const list = document.getElementById('user_list');
      const msg = document.getElementById('user_management_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      loadUserList();
      document.getElementById('user_management_close').onclick = () => {
        modal.style.display = 'none';
      };
      document.getElementById('btn_new_user').onclick = () => {
        openNewUserModal();
      };
      modal.onclick = (ev) => { if(ev.target === modal) modal.style.display = 'none'; };
    }
    async function loadUserList(){
      const list = document.getElementById('user_list');
      list.innerHTML = '<div class="sub">Lade User...</div>';
      try{
        const res = await fetch('/api/admin/users', {
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok && data.users){
          if(data.users.length === 0){
            list.innerHTML = '<div class="sub">Keine User vorhanden</div>';
            return;
          }
          let html = '<div style="display:grid; gap:8px;">';
          data.users.forEach(u => {
            const activeLabel = u.active ? '‚úÖ' : '‚ùå';
            const roleLabel = u.role === 'superadmin' ? 'üîë' : u.role === 'admin' ? '‚öôÔ∏è' : 'üë§';
            html += `<div style="background:#fff; border:1px solid var(--border); border-radius:6px; padding:10px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<div><div style="font-weight:600;">${roleLabel} ${escapeHtml(u.email)}</div>`;
            html += `<div class="sub">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')} ¬∑ ${u.role} ¬∑ ${activeLabel}</div></div>`;
            html += `<button onclick="deleteUser(${u.id}, '${escapeHtml(u.email)}')" style="background:#dc2626; padding:6px 10px; font-size:12px;">üóëÔ∏è L√∂schen</button>`;
            html += `</div>`;
          });
          html += '</div>';
          list.innerHTML = html;
        } else {
          list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler beim Laden: ' + (data.error || 'Unbekannt') + '</div>';
        }
      }catch(e){
        list.innerHTML = '<div class="sub" style="color:#dc2626;">Fehler: ' + e + '</div>';
      }
    }
    function openNewUserModal(){
      closeAllModals();
      const modal = document.getElementById('new_user_modal');
      const msg = document.getElementById('new_user_msg');
      modal.style.display = 'flex';
      msg.textContent = '';
      document.getElementById('new_user_email').value = '';
      document.getElementById('new_user_first').value = '';
      document.getElementById('new_user_last').value = '';
      document.getElementById('new_user_pass').value = '';
      document.getElementById('new_user_role').value = 'user';
      const cleanup = () => { modal.style.display = 'none'; };
      document.getElementById('new_user_cancel').onclick = cleanup;
      document.getElementById('new_user_save').onclick = async () => {
        const email = document.getElementById('new_user_email').value.trim();
        const first = document.getElementById('new_user_first').value.trim();
        const last = document.getElementById('new_user_last').value.trim();
        const pass = document.getElementById('new_user_pass').value;
        const role = document.getElementById('new_user_role').value;
        if(!email || !pass){
          msg.textContent = 'E‚ÄëMail und Passwort erforderlich';
          return;
        }
        if(pass.length < 6){
          msg.textContent = 'Passwort muss mindestens 6 Zeichen haben';
          return;
        }
        msg.textContent = 'Erstelle User...';
        try{
          const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
            body: JSON.stringify({email, first_name: first, last_name: last, password: pass, role})
          });
          const data = await parseJsonSafe(res);
          if(data.__ok){
            msg.textContent = '‚úÖ User erstellt!';
            setTimeout(() => {
              cleanup();
              loadUserList();
            }, 1500);
          } else {
            msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
          }
        }catch(e){
          msg.textContent = 'Fehler: ' + e;
        }
      };
      modal.onclick = (ev) => { if(ev.target === modal) cleanup(); };
    }
    window.deleteUser = async function(userId, email){
      if(!confirm(`User "${email}" wirklich l√∂schen?`)) return;
      const msg = document.getElementById('user_management_msg');
      msg.textContent = 'L√∂sche User...';
      try{
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        const data = await parseJsonSafe(res);
        if(data.__ok){
          msg.textContent = '‚úÖ User gel√∂scht';
          loadUserList();
        } else {
          msg.textContent = 'Fehler: ' + (data.error || 'Unbekannt');
        }
      }catch(e){
        msg.textContent = 'Fehler: ' + e;
      }
    };
    // Check auth on app start
    checkAuth().then(ok => {
      if(ok) loadInbox();
    });
  </script>
</body>
</html>
